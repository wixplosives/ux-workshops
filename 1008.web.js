/*! For license information please see 1008.web.js.LICENSE.txt */
"use strict";(self.webpackChunk_wixc3_component_playground=self.webpackChunk_wixc3_component_playground||[]).push([[1008],{61008:(t,e,n)=>{n.r(e),n.d(e,{AbstractUserDataWriter:()=>tm,Bytes:()=>Wd,CACHE_SIZE_UNLIMITED:()=>Dd,CollectionReference:()=>bd,DocumentReference:()=>vd,DocumentSnapshot:()=>Cf,FieldPath:()=>Qd,FieldValue:()=>Yd,Firestore:()=>kd,FirestoreError:()=>Ls,GeoPoint:()=>Xd,LoadBundleTask:()=>Cd,Query:()=>Id,QueryConstraint:()=>Mf,QueryDocumentSnapshot:()=>Df,QuerySnapshot:()=>kf,SnapshotMetadata:()=>Nf,Timestamp:()=>Xs,Transaction:()=>Im,WriteBatch:()=>sm,_DatabaseId:()=>yr,_DocumentKey:()=>br,_EmptyAppCheckTokenProvider:()=>Gs,_EmptyAuthCredentialsProvider:()=>Fs,_FieldPath:()=>ir,_cast:()=>md,_debugAssert:()=>ks,_isBase64Available:()=>ar,_logWarn:()=>_s,_setIndexConfiguration:()=>Nm,_validateIsNotUsedTogether:()=>hd,addDoc:()=>gm,arrayRemove:()=>xm,arrayUnion:()=>Sm,clearIndexedDbPersistence:()=>Ud,collection:()=>Td,collectionGroup:()=>Ed,connectFirestoreEmulator:()=>wd,deleteDoc:()=>mm,deleteField:()=>Tm,disableNetwork:()=>Kd,doc:()=>Sd,documentId:()=>Hd,enableIndexedDbPersistence:()=>Pd,enableMultiTabIndexedDbPersistence:()=>Fd,enableNetwork:()=>Bd,endAt:()=>Wf,endBefore:()=>Hf,ensureFirestoreConfigured:()=>Ld,executeWrite:()=>wm,getDoc:()=>im,getDocFromCache:()=>am,getDocFromServer:()=>cm,getDocs:()=>um,getDocsFromCache:()=>hm,getDocsFromServer:()=>lm,getFirestore:()=>Rd,increment:()=>Am,initializeFirestore:()=>Od,limit:()=>Kf,limitToLast:()=>jf,loadBundle:()=>Gd,namedQuery:()=>$d,onSnapshot:()=>pm,onSnapshotsInSync:()=>ym,orderBy:()=>qf,query:()=>Pf,queryEqual:()=>Ad,refEqual:()=>xd,runTransaction:()=>bm,serverTimestamp:()=>Em,setDoc:()=>dm,setLogLevel:()=>Ss,snapshotEqual:()=>Rf,startAfter:()=>zf,startAt:()=>$f,terminate:()=>jd,updateDoc:()=>fm,waitForPendingWrites:()=>qd,where:()=>Vf,writeBatch:()=>_m});var s,r=n(85500),i=n(46387),o=n(68207),a=n(83395),c="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:void 0!==n.g?n.g:"undefined"!=typeof self?self:{},u={},h=h||{},l=c||self;function d(){}function f(t){var e=typeof t;return"array"==(e="object"!=e?e:t?Array.isArray(t)?"array":e:"null")||"object"==e&&"number"==typeof t.length}function m(t){var e=typeof t;return"object"==e&&null!=t||"function"==e}var g="closure_uid_"+(1e9*Math.random()>>>0),p=0;function y(t,e,n){return t.call.apply(t.bind,arguments)}function w(t,e,n){if(!t)throw Error();if(2<arguments.length){var s=Array.prototype.slice.call(arguments,2);return function(){var n=Array.prototype.slice.call(arguments);return Array.prototype.unshift.apply(n,s),t.apply(e,n)}}return function(){return t.apply(e,arguments)}}function v(t,e,n){return(v=Function.prototype.bind&&-1!=Function.prototype.bind.toString().indexOf("native code")?y:w).apply(null,arguments)}function I(t,e){var n=Array.prototype.slice.call(arguments,1);return function(){var e=n.slice();return e.push.apply(e,arguments),t.apply(this,e)}}function b(t,e){function n(){}n.prototype=e.prototype,t.Z=e.prototype,t.prototype=new n,t.prototype.constructor=t,t.Vb=function(t,n,s){for(var r=Array(arguments.length-2),i=2;i<arguments.length;i++)r[i-2]=arguments[i];return e.prototype[n].apply(t,r)}}function T(){this.s=this.s,this.o=this.o}var E={};T.prototype.s=!1,T.prototype.na=function(){if(!this.s&&(this.s=!0,this.M(),0)){var t=function(t){return Object.prototype.hasOwnProperty.call(t,g)&&t[g]||(t[g]=++p)}(this);delete E[t]}},T.prototype.M=function(){if(this.o)for(;this.o.length;)this.o.shift()()};const S=Array.prototype.indexOf?function(t,e){return Array.prototype.indexOf.call(t,e,void 0)}:function(t,e){if("string"==typeof t)return"string"!=typeof e||1!=e.length?-1:t.indexOf(e,0);for(let n=0;n<t.length;n++)if(n in t&&t[n]===e)return n;return-1},x=Array.prototype.forEach?function(t,e,n){Array.prototype.forEach.call(t,e,n)}:function(t,e,n){const s=t.length,r="string"==typeof t?t.split(""):t;for(let i=0;i<s;i++)i in r&&e.call(n,r[i],i,t)};function A(t){return Array.prototype.concat.apply([],arguments)}function _(t){const e=t.length;if(0<e){const n=Array(e);for(let s=0;s<e;s++)n[s]=t[s];return n}return[]}function N(t){return/^[\s\xa0]*$/.test(t)}var C,D=String.prototype.trim?function(t){return t.trim()}:function(t){return/^[\s\xa0]*([\s\S]*?)[\s\xa0]*$/.exec(t)[1]};function k(t,e){return-1!=t.indexOf(e)}function O(t,e){return t<e?-1:t>e?1:0}t:{var R=l.navigator;if(R){var L=R.userAgent;if(L){C=L;break t}}C=""}function M(t,e,n){for(const s in t)e.call(n,t[s],s,t)}function P(t){const e={};for(const n in t)e[n]=t[n];return e}var F="constructor hasOwnProperty isPrototypeOf propertyIsEnumerable toLocaleString toString valueOf".split(" ");function V(t,e){let n,s;for(let e=1;e<arguments.length;e++){for(n in s=arguments[e],s)t[n]=s[n];for(let e=0;e<F.length;e++)n=F[e],Object.prototype.hasOwnProperty.call(s,n)&&(t[n]=s[n])}}function U(t){return U[" "](t),t}U[" "]=d;var q,B,K=k(C,"Opera"),j=k(C,"Trident")||k(C,"MSIE"),G=k(C,"Edge"),$=G||j,z=k(C,"Gecko")&&!(k(C.toLowerCase(),"webkit")&&!k(C,"Edge"))&&!(k(C,"Trident")||k(C,"MSIE"))&&!k(C,"Edge"),Q=k(C.toLowerCase(),"webkit")&&!k(C,"Edge");function H(){var t=l.document;return t?t.documentMode:void 0}t:{var W="",Y=(B=C,z?/rv:([^\);]+)(\)|;)/.exec(B):G?/Edge\/([\d\.]+)/.exec(B):j?/\b(?:MSIE|rv)[: ]([^\);]+)(\)|;)/.exec(B):Q?/WebKit\/(\S+)/.exec(B):K?/(?:Version)[ \/]?(\S+)/.exec(B):void 0);if(Y&&(W=Y?Y[1]:""),j){var X=H();if(null!=X&&X>parseFloat(W)){q=String(X);break t}}q=W}var J,Z={};function tt(){return t=Z,Object.prototype.hasOwnProperty.call(t,9)?t[9]:t[9]=function(){let t=0;const e=D(String(q)).split("."),n=D("9").split("."),s=Math.max(e.length,n.length);for(let o=0;0==t&&o<s;o++){var r=e[o]||"",i=n[o]||"";do{if(r=/(\d*)(\D*)(.*)/.exec(r)||["","","",""],i=/(\d*)(\D*)(.*)/.exec(i)||["","","",""],0==r[0].length&&0==i[0].length)break;t=O(0==r[1].length?0:parseInt(r[1],10),0==i[1].length?0:parseInt(i[1],10))||O(0==r[2].length,0==i[2].length)||O(r[2],i[2]),r=r[3],i=i[3]}while(0==t)}return 0<=t}();var t}l.document&&j?J=H()||parseInt(q,10)||void 0:J=void 0;var et=J,nt=function(){if(!l.addEventListener||!Object.defineProperty)return!1;var t=!1,e=Object.defineProperty({},"passive",{get:function(){t=!0}});try{l.addEventListener("test",d,e),l.removeEventListener("test",d,e)}catch(t){}return t}();function st(t,e){this.type=t,this.g=this.target=e,this.defaultPrevented=!1}function rt(t,e){if(st.call(this,t?t.type:""),this.relatedTarget=this.g=this.target=null,this.button=this.screenY=this.screenX=this.clientY=this.clientX=0,this.key="",this.metaKey=this.shiftKey=this.altKey=this.ctrlKey=!1,this.state=null,this.pointerId=0,this.pointerType="",this.i=null,t){var n=this.type=t.type,s=t.changedTouches&&t.changedTouches.length?t.changedTouches[0]:null;if(this.target=t.target||t.srcElement,this.g=e,e=t.relatedTarget){if(z){t:{try{U(e.nodeName);var r=!0;break t}catch(t){}r=!1}r||(e=null)}}else"mouseover"==n?e=t.fromElement:"mouseout"==n&&(e=t.toElement);this.relatedTarget=e,s?(this.clientX=void 0!==s.clientX?s.clientX:s.pageX,this.clientY=void 0!==s.clientY?s.clientY:s.pageY,this.screenX=s.screenX||0,this.screenY=s.screenY||0):(this.clientX=void 0!==t.clientX?t.clientX:t.pageX,this.clientY=void 0!==t.clientY?t.clientY:t.pageY,this.screenX=t.screenX||0,this.screenY=t.screenY||0),this.button=t.button,this.key=t.key||"",this.ctrlKey=t.ctrlKey,this.altKey=t.altKey,this.shiftKey=t.shiftKey,this.metaKey=t.metaKey,this.pointerId=t.pointerId||0,this.pointerType="string"==typeof t.pointerType?t.pointerType:it[t.pointerType]||"",this.state=t.state,this.i=t,t.defaultPrevented&&rt.Z.h.call(this)}}st.prototype.h=function(){this.defaultPrevented=!0},b(rt,st);var it={2:"touch",3:"pen",4:"mouse"};rt.prototype.h=function(){rt.Z.h.call(this);var t=this.i;t.preventDefault?t.preventDefault():t.returnValue=!1};var ot="closure_listenable_"+(1e6*Math.random()|0),at=0;function ct(t,e,n,s,r){this.listener=t,this.proxy=null,this.src=e,this.type=n,this.capture=!!s,this.ia=r,this.key=++at,this.ca=this.fa=!1}function ut(t){t.ca=!0,t.listener=null,t.proxy=null,t.src=null,t.ia=null}function ht(t){this.src=t,this.g={},this.h=0}function lt(t,e){var n=e.type;if(n in t.g){var s,r=t.g[n],i=S(r,e);(s=0<=i)&&Array.prototype.splice.call(r,i,1),s&&(ut(e),0==t.g[n].length&&(delete t.g[n],t.h--))}}function dt(t,e,n,s){for(var r=0;r<t.length;++r){var i=t[r];if(!i.ca&&i.listener==e&&i.capture==!!n&&i.ia==s)return r}return-1}ht.prototype.add=function(t,e,n,s,r){var i=t.toString();(t=this.g[i])||(t=this.g[i]=[],this.h++);var o=dt(t,e,s,r);return-1<o?(e=t[o],n||(e.fa=!1)):((e=new ct(e,this.src,i,!!s,r)).fa=n,t.push(e)),e};var ft="closure_lm_"+(1e6*Math.random()|0),mt={};function gt(t,e,n,s,r){if(s&&s.once)return yt(t,e,n,s,r);if(Array.isArray(e)){for(var i=0;i<e.length;i++)gt(t,e[i],n,s,r);return null}return n=St(n),t&&t[ot]?t.N(e,n,m(s)?!!s.capture:!!s,r):pt(t,e,n,!1,s,r)}function pt(t,e,n,s,r,i){if(!e)throw Error("Invalid event type");var o=m(r)?!!r.capture:!!r,a=Tt(t);if(a||(t[ft]=a=new ht(t)),(n=a.add(e,n,s,o,i)).proxy)return n;if(s=function(){var t=bt;return function e(n){return t.call(e.src,e.listener,n)}}(),n.proxy=s,s.src=t,s.listener=n,t.addEventListener)nt||(r=o),void 0===r&&(r=!1),t.addEventListener(e.toString(),s,r);else if(t.attachEvent)t.attachEvent(It(e.toString()),s);else{if(!t.addListener||!t.removeListener)throw Error("addEventListener and attachEvent are unavailable.");t.addListener(s)}return n}function yt(t,e,n,s,r){if(Array.isArray(e)){for(var i=0;i<e.length;i++)yt(t,e[i],n,s,r);return null}return n=St(n),t&&t[ot]?t.O(e,n,m(s)?!!s.capture:!!s,r):pt(t,e,n,!0,s,r)}function wt(t,e,n,s,r){if(Array.isArray(e))for(var i=0;i<e.length;i++)wt(t,e[i],n,s,r);else s=m(s)?!!s.capture:!!s,n=St(n),t&&t[ot]?(t=t.i,(e=String(e).toString())in t.g&&-1<(n=dt(i=t.g[e],n,s,r))&&(ut(i[n]),Array.prototype.splice.call(i,n,1),0==i.length&&(delete t.g[e],t.h--))):t&&(t=Tt(t))&&(e=t.g[e.toString()],t=-1,e&&(t=dt(e,n,s,r)),(n=-1<t?e[t]:null)&&vt(n))}function vt(t){if("number"!=typeof t&&t&&!t.ca){var e=t.src;if(e&&e[ot])lt(e.i,t);else{var n=t.type,s=t.proxy;e.removeEventListener?e.removeEventListener(n,s,t.capture):e.detachEvent?e.detachEvent(It(n),s):e.addListener&&e.removeListener&&e.removeListener(s),(n=Tt(e))?(lt(n,t),0==n.h&&(n.src=null,e[ft]=null)):ut(t)}}}function It(t){return t in mt?mt[t]:mt[t]="on"+t}function bt(t,e){if(t.ca)t=!0;else{e=new rt(e,this);var n=t.listener,s=t.ia||t.src;t.fa&&vt(t),t=n.call(s,e)}return t}function Tt(t){return(t=t[ft])instanceof ht?t:null}var Et="__closure_events_fn_"+(1e9*Math.random()>>>0);function St(t){return"function"==typeof t?t:(t[Et]||(t[Et]=function(e){return t.handleEvent(e)}),t[Et])}function xt(){T.call(this),this.i=new ht(this),this.P=this,this.I=null}function At(t,e){var n,s=t.I;if(s)for(n=[];s;s=s.I)n.push(s);if(t=t.P,s=e.type||e,"string"==typeof e)e=new st(e,t);else if(e instanceof st)e.target=e.target||t;else{var r=e;V(e=new st(s,t),r)}if(r=!0,n)for(var i=n.length-1;0<=i;i--){var o=e.g=n[i];r=_t(o,s,!0,e)&&r}if(r=_t(o=e.g=t,s,!0,e)&&r,r=_t(o,s,!1,e)&&r,n)for(i=0;i<n.length;i++)r=_t(o=e.g=n[i],s,!1,e)&&r}function _t(t,e,n,s){if(!(e=t.i.g[String(e)]))return!0;e=e.concat();for(var r=!0,i=0;i<e.length;++i){var o=e[i];if(o&&!o.ca&&o.capture==n){var a=o.listener,c=o.ia||o.src;o.fa&&lt(t.i,o),r=!1!==a.call(c,s)&&r}}return r&&!s.defaultPrevented}b(xt,T),xt.prototype[ot]=!0,xt.prototype.removeEventListener=function(t,e,n,s){wt(this,t,e,n,s)},xt.prototype.M=function(){if(xt.Z.M.call(this),this.i){var t,e=this.i;for(t in e.g){for(var n=e.g[t],s=0;s<n.length;s++)ut(n[s]);delete e.g[t],e.h--}}this.I=null},xt.prototype.N=function(t,e,n,s){return this.i.add(String(t),e,!1,n,s)},xt.prototype.O=function(t,e,n,s){return this.i.add(String(t),e,!0,n,s)};var Nt=l.JSON.stringify;function Ct(){var t=Pt;let e=null;return t.g&&(e=t.g,t.g=t.g.next,t.g||(t.h=null),e.next=null),e}var Dt,kt=new class{constructor(t,e){this.i=t,this.j=e,this.h=0,this.g=null}get(){let t;return 0<this.h?(this.h--,t=this.g,this.g=t.next,t.next=null):t=this.i(),t}}((()=>new Ot),(t=>t.reset()));class Ot{constructor(){this.next=this.g=this.h=null}set(t,e){this.h=t,this.g=e,this.next=null}reset(){this.next=this.g=this.h=null}}function Rt(t){l.setTimeout((()=>{throw t}),0)}function Lt(t,e){Dt||function(){var t=l.Promise.resolve(void 0);Dt=function(){t.then(Ft)}}(),Mt||(Dt(),Mt=!0),Pt.add(t,e)}var Mt=!1,Pt=new class{constructor(){this.h=this.g=null}add(t,e){const n=kt.get();n.set(t,e),this.h?this.h.next=n:this.g=n,this.h=n}};function Ft(){for(var t;t=Ct();){try{t.h.call(t.g)}catch(t){Rt(t)}var e=kt;e.j(t),100>e.h&&(e.h++,t.next=e.g,e.g=t)}Mt=!1}function Vt(t,e){xt.call(this),this.h=t||1,this.g=e||l,this.j=v(this.kb,this),this.l=Date.now()}function Ut(t){t.da=!1,t.S&&(t.g.clearTimeout(t.S),t.S=null)}function qt(t,e,n){if("function"==typeof t)n&&(t=v(t,n));else{if(!t||"function"!=typeof t.handleEvent)throw Error("Invalid listener argument");t=v(t.handleEvent,t)}return 2147483647<Number(e)?-1:l.setTimeout(t,e||0)}function Bt(t){t.g=qt((()=>{t.g=null,t.i&&(t.i=!1,Bt(t))}),t.j);const e=t.h;t.h=null,t.m.apply(null,e)}b(Vt,xt),(s=Vt.prototype).da=!1,s.S=null,s.kb=function(){if(this.da){var t=Date.now()-this.l;0<t&&t<.8*this.h?this.S=this.g.setTimeout(this.j,this.h-t):(this.S&&(this.g.clearTimeout(this.S),this.S=null),At(this,"tick"),this.da&&(Ut(this),this.start()))}},s.start=function(){this.da=!0,this.S||(this.S=this.g.setTimeout(this.j,this.h),this.l=Date.now())},s.M=function(){Vt.Z.M.call(this),Ut(this),delete this.g};class Kt extends T{constructor(t,e){super(),this.m=t,this.j=e,this.h=null,this.i=!1,this.g=null}l(t){this.h=arguments,this.g?this.i=!0:Bt(this)}M(){super.M(),this.g&&(l.clearTimeout(this.g),this.g=null,this.i=!1,this.h=null)}}function jt(t){T.call(this),this.h=t,this.g={}}b(jt,T);var Gt=[];function $t(t,e,n,s){Array.isArray(n)||(n&&(Gt[0]=n.toString()),n=Gt);for(var r=0;r<n.length;r++){var i=gt(e,n[r],s||t.handleEvent,!1,t.h||t);if(!i)break;t.g[i.key]=i}}function zt(t){M(t.g,(function(t,e){this.g.hasOwnProperty(e)&&vt(t)}),t),t.g={}}function Qt(){this.g=!0}function Ht(t,e,n,s){t.info((function(){return"XMLHTTP TEXT ("+e+"): "+function(t,e){if(!t.g)return e;if(!e)return null;try{var n=JSON.parse(e);if(n)for(t=0;t<n.length;t++)if(Array.isArray(n[t])){var s=n[t];if(!(2>s.length)){var r=s[1];if(Array.isArray(r)&&!(1>r.length)){var i=r[0];if("noop"!=i&&"stop"!=i&&"close"!=i)for(var o=1;o<r.length;o++)r[o]=""}}}return Nt(n)}catch(t){return e}}(t,n)+(s?" "+s:"")}))}jt.prototype.M=function(){jt.Z.M.call(this),zt(this)},jt.prototype.handleEvent=function(){throw Error("EventHandler.handleEvent not implemented")},Qt.prototype.Aa=function(){this.g=!1},Qt.prototype.info=function(){};var Wt={},Yt=null;function Xt(){return Yt=Yt||new xt}function Jt(t){st.call(this,Wt.Ma,t)}function Zt(t){const e=Xt();At(e,new Jt(e,t))}function te(t,e){st.call(this,Wt.STAT_EVENT,t),this.stat=e}function ee(t){const e=Xt();At(e,new te(e,t))}function ne(t,e){st.call(this,Wt.Na,t),this.size=e}function se(t,e){if("function"!=typeof t)throw Error("Fn must not be null and must be a function");return l.setTimeout((function(){t()}),e)}Wt.Ma="serverreachability",b(Jt,st),Wt.STAT_EVENT="statevent",b(te,st),Wt.Na="timingevent",b(ne,st);var re={NO_ERROR:0,lb:1,yb:2,xb:3,sb:4,wb:5,zb:6,Ja:7,TIMEOUT:8,Cb:9},ie={qb:"complete",Mb:"success",Ka:"error",Ja:"abort",Eb:"ready",Fb:"readystatechange",TIMEOUT:"timeout",Ab:"incrementaldata",Db:"progress",tb:"downloadprogress",Ub:"uploadprogress"};function oe(){}function ae(t){return t.h||(t.h=t.i())}function ce(){}oe.prototype.h=null;var ue,he={OPEN:"a",pb:"b",Ka:"c",Bb:"d"};function le(){st.call(this,"d")}function de(){st.call(this,"c")}function fe(){}function me(t,e,n,s){this.l=t,this.j=e,this.m=n,this.X=s||1,this.V=new jt(this),this.P=pe,t=$?125:void 0,this.W=new Vt(t),this.H=null,this.i=!1,this.s=this.A=this.v=this.K=this.F=this.Y=this.B=null,this.D=[],this.g=null,this.C=0,this.o=this.u=null,this.N=-1,this.I=!1,this.O=0,this.L=null,this.aa=this.J=this.$=this.U=!1,this.h=new ge}function ge(){this.i=null,this.g="",this.h=!1}b(le,st),b(de,st),b(fe,oe),fe.prototype.g=function(){return new XMLHttpRequest},fe.prototype.i=function(){return{}},ue=new fe;var pe=45e3,ye={},we={};function ve(t,e,n){t.K=1,t.v=Ke(Pe(e)),t.s=n,t.U=!0,Ie(t,null)}function Ie(t,e){t.F=Date.now(),Se(t),t.A=Pe(t.v);var n=t.A,s=t.X;Array.isArray(s)||(s=[String(s)]),en(n.h,"t",s),t.C=0,n=t.l.H,t.h=new ge,t.g=ns(t.l,n?e:null,!t.s),0<t.O&&(t.L=new Kt(v(t.Ia,t,t.g),t.O)),$t(t.V,t.g,"readystatechange",t.gb),e=t.H?P(t.H):{},t.s?(t.u||(t.u="POST"),e["Content-Type"]="application/x-www-form-urlencoded",t.g.ea(t.A,t.u,t.s,e)):(t.u="GET",t.g.ea(t.A,t.u,null,e)),Zt(1),function(t,e,n,s,r,i){t.info((function(){if(t.g)if(i)for(var o="",a=i.split("&"),c=0;c<a.length;c++){var u=a[c].split("=");if(1<u.length){var h=u[0];u=u[1];var l=h.split("_");o=2<=l.length&&"type"==l[1]?o+(h+"=")+u+"&":o+(h+"=redacted&")}}else o=null;else o=i;return"XMLHTTP REQ ("+s+") [attempt "+r+"]: "+e+"\n"+n+"\n"+o}))}(t.j,t.u,t.A,t.m,t.X,t.s)}function be(t){return!!t.g&&"GET"==t.u&&2!=t.K&&t.l.Ba}function Te(t,e,n){let s,r=!0;for(;!t.I&&t.C<n.length;){if(s=Ee(t,n),s==we){4==e&&(t.o=4,ee(14),r=!1),Ht(t.j,t.m,null,"[Incomplete Response]");break}if(s==ye){t.o=4,ee(15),Ht(t.j,t.m,n,"[Invalid Chunk]"),r=!1;break}Ht(t.j,t.m,s,null),Ce(t,s)}be(t)&&s!=we&&s!=ye&&(t.h.g="",t.C=0),4!=e||0!=n.length||t.h.h||(t.o=1,ee(16),r=!1),t.i=t.i&&r,r?0<n.length&&!t.aa&&(t.aa=!0,(e=t.l).g==t&&e.$&&!e.L&&(e.h.info("Great, no buffering proxy detected. Bytes received: "+n.length),Hn(e),e.L=!0,ee(11))):(Ht(t.j,t.m,n,"[Invalid Chunked Response]"),Ne(t),_e(t))}function Ee(t,e){var n=t.C,s=e.indexOf("\n",n);return-1==s?we:(n=Number(e.substring(n,s)),isNaN(n)?ye:(s+=1)+n>e.length?we:(e=e.substr(s,n),t.C=s+n,e))}function Se(t){t.Y=Date.now()+t.P,xe(t,t.P)}function xe(t,e){if(null!=t.B)throw Error("WatchDog timer not null");t.B=se(v(t.eb,t),e)}function Ae(t){t.B&&(l.clearTimeout(t.B),t.B=null)}function _e(t){0==t.l.G||t.I||Xn(t.l,t)}function Ne(t){Ae(t);var e=t.L;e&&"function"==typeof e.na&&e.na(),t.L=null,Ut(t.W),zt(t.V),t.g&&(e=t.g,t.g=null,e.abort(),e.na())}function Ce(t,e){try{var n=t.l;if(0!=n.G&&(n.g==t||cn(n.i,t)))if(n.I=t.N,!t.J&&cn(n.i,t)&&3==n.G){try{var s=n.Ca.g.parse(e)}catch(t){s=null}if(Array.isArray(s)&&3==s.length){var r=s;if(0==r[0]){t:if(!n.u){if(n.g){if(!(n.g.F+3e3<t.F))break t;Yn(n),Un(n)}Qn(n),ee(18)}}else n.ta=r[1],0<n.ta-n.U&&37500>r[2]&&n.N&&0==n.A&&!n.v&&(n.v=se(v(n.ab,n),6e3));if(1>=an(n.i)&&n.ka){try{n.ka()}catch(t){}n.ka=void 0}}else Zn(n,11)}else if((t.J||n.g==t)&&Yn(n),!N(e))for(r=n.Ca.g.parse(e),e=0;e<r.length;e++){let u=r[e];if(n.U=u[0],u=u[1],2==n.G)if("c"==u[0]){n.J=u[1],n.la=u[2];const e=u[3];null!=e&&(n.ma=e,n.h.info("VER="+n.ma));const r=u[4];null!=r&&(n.za=r,n.h.info("SVER="+n.za));const h=u[5];null!=h&&"number"==typeof h&&0<h&&(s=1.5*h,n.K=s,n.h.info("backChannelRequestTimeoutMs_="+s)),s=n;const l=t.g;if(l){const t=l.g?l.g.getResponseHeader("X-Client-Wire-Protocol"):null;if(t){var i=s.i;!i.g&&(k(t,"spdy")||k(t,"quic")||k(t,"h2"))&&(i.j=i.l,i.g=new Set,i.h&&(un(i,i.h),i.h=null))}if(s.D){const t=l.g?l.g.getResponseHeader("X-HTTP-Session-Id"):null;t&&(s.sa=t,Be(s.F,s.D,t))}}n.G=3,n.j&&n.j.xa(),n.$&&(n.O=Date.now()-t.F,n.h.info("Handshake RTT: "+n.O+"ms"));var o=t;if((s=n).oa=es(s,s.H?s.la:null,s.W),o.J){hn(s.i,o);var a=o,c=s.K;c&&a.setTimeout(c),a.B&&(Ae(a),Se(a)),s.g=o}else zn(s);0<n.l.length&&Kn(n)}else"stop"!=u[0]&&"close"!=u[0]||Zn(n,7);else 3==n.G&&("stop"==u[0]||"close"==u[0]?"stop"==u[0]?Zn(n,7):Vn(n):"noop"!=u[0]&&n.j&&n.j.wa(u),n.A=0)}Zt(4)}catch(t){}}function De(t,e){if(t.forEach&&"function"==typeof t.forEach)t.forEach(e,void 0);else if(f(t)||"string"==typeof t)x(t,e,void 0);else{if(t.T&&"function"==typeof t.T)var n=t.T();else if(t.R&&"function"==typeof t.R)n=void 0;else if(f(t)||"string"==typeof t){n=[];for(var s=t.length,r=0;r<s;r++)n.push(r)}else for(r in n=[],s=0,t)n[s++]=r;s=function(t){if(t.R&&"function"==typeof t.R)return t.R();if("string"==typeof t)return t.split("");if(f(t)){for(var e=[],n=t.length,s=0;s<n;s++)e.push(t[s]);return e}for(s in e=[],n=0,t)e[n++]=t[s];return e}(t),r=s.length;for(var i=0;i<r;i++)e.call(void 0,s[i],n&&n[i],t)}}function ke(t,e){this.h={},this.g=[],this.i=0;var n=arguments.length;if(1<n){if(n%2)throw Error("Uneven number of arguments");for(var s=0;s<n;s+=2)this.set(arguments[s],arguments[s+1])}else if(t)if(t instanceof ke)for(n=t.T(),s=0;s<n.length;s++)this.set(n[s],t.get(n[s]));else for(s in t)this.set(s,t[s])}function Oe(t){if(t.i!=t.g.length){for(var e=0,n=0;e<t.g.length;){var s=t.g[e];Re(t.h,s)&&(t.g[n++]=s),e++}t.g.length=n}if(t.i!=t.g.length){var r={};for(n=e=0;e<t.g.length;)Re(r,s=t.g[e])||(t.g[n++]=s,r[s]=1),e++;t.g.length=n}}function Re(t,e){return Object.prototype.hasOwnProperty.call(t,e)}(s=me.prototype).setTimeout=function(t){this.P=t},s.gb=function(t){t=t.target;const e=this.L;e&&3==Rn(t)?e.l():this.Ia(t)},s.Ia=function(t){try{if(t==this.g)t:{const h=Rn(this.g);var e=this.g.Da();const d=this.g.ba();if(!(3>h)&&(3!=h||$||this.g&&(this.h.h||this.g.ga()||Ln(this.g)))){this.I||4!=h||7==e||Zt(8==e||0>=d?3:2),Ae(this);var n=this.g.ba();this.N=n;e:if(be(this)){var s=Ln(this.g);t="";var r=s.length,i=4==Rn(this.g);if(!this.h.i){if("undefined"==typeof TextDecoder){Ne(this),_e(this);var o="";break e}this.h.i=new l.TextDecoder}for(e=0;e<r;e++)this.h.h=!0,t+=this.h.i.decode(s[e],{stream:i&&e==r-1});s.splice(0,r),this.h.g+=t,this.C=0,o=this.h.g}else o=this.g.ga();if(this.i=200==n,function(t,e,n,s,r,i,o){t.info((function(){return"XMLHTTP RESP ("+s+") [ attempt "+r+"]: "+e+"\n"+n+"\n"+i+" "+o}))}(this.j,this.u,this.A,this.m,this.X,h,n),this.i){if(this.$&&!this.J){e:{if(this.g){var a,c=this.g;if((a=c.g?c.g.getResponseHeader("X-HTTP-Initial-Response"):null)&&!N(a)){var u=a;break e}}u=null}if(!(n=u)){this.i=!1,this.o=3,ee(12),Ne(this),_e(this);break t}Ht(this.j,this.m,n,"Initial handshake response via X-HTTP-Initial-Response"),this.J=!0,Ce(this,n)}this.U?(Te(this,h,o),$&&this.i&&3==h&&($t(this.V,this.W,"tick",this.fb),this.W.start())):(Ht(this.j,this.m,o,null),Ce(this,o)),4==h&&Ne(this),this.i&&!this.I&&(4==h?Xn(this.l,this):(this.i=!1,Se(this)))}else 400==n&&0<o.indexOf("Unknown SID")?(this.o=3,ee(12)):(this.o=0,ee(13)),Ne(this),_e(this)}}}catch(t){}},s.fb=function(){if(this.g){var t=Rn(this.g),e=this.g.ga();this.C<e.length&&(Ae(this),Te(this,t,e),this.i&&4!=t&&Se(this))}},s.cancel=function(){this.I=!0,Ne(this)},s.eb=function(){this.B=null;const t=Date.now();0<=t-this.Y?(function(t,e){t.info((function(){return"TIMEOUT: "+e}))}(this.j,this.A),2!=this.K&&(Zt(3),ee(17)),Ne(this),this.o=2,_e(this)):xe(this,this.Y-t)},(s=ke.prototype).R=function(){Oe(this);for(var t=[],e=0;e<this.g.length;e++)t.push(this.h[this.g[e]]);return t},s.T=function(){return Oe(this),this.g.concat()},s.get=function(t,e){return Re(this.h,t)?this.h[t]:e},s.set=function(t,e){Re(this.h,t)||(this.i++,this.g.push(t)),this.h[t]=e},s.forEach=function(t,e){for(var n=this.T(),s=0;s<n.length;s++){var r=n[s],i=this.get(r);t.call(e,i,r,this)}};var Le=/^(?:([^:/?#.]+):)?(?:\/\/(?:([^\\/?#]*)@)?([^\\/?#]*?)(?::([0-9]+))?(?=[\\/?#]|$))?([^?#]+)?(?:\?([^#]*))?(?:#([\s\S]*))?$/;function Me(t,e){if(this.i=this.s=this.j="",this.m=null,this.o=this.l="",this.g=!1,t instanceof Me){this.g=void 0!==e?e:t.g,Fe(this,t.j),this.s=t.s,Ve(this,t.i),Ue(this,t.m),this.l=t.l,e=t.h;var n=new Xe;n.i=e.i,e.g&&(n.g=new ke(e.g),n.h=e.h),qe(this,n),this.o=t.o}else t&&(n=String(t).match(Le))?(this.g=!!e,Fe(this,n[1]||"",!0),this.s=je(n[2]||""),Ve(this,n[3]||"",!0),Ue(this,n[4]),this.l=je(n[5]||"",!0),qe(this,n[6]||"",!0),this.o=je(n[7]||"")):(this.g=!!e,this.h=new Xe(null,this.g))}function Pe(t){return new Me(t)}function Fe(t,e,n){t.j=n?je(e,!0):e,t.j&&(t.j=t.j.replace(/:$/,""))}function Ve(t,e,n){t.i=n?je(e,!0):e}function Ue(t,e){if(e){if(e=Number(e),isNaN(e)||0>e)throw Error("Bad port number "+e);t.m=e}else t.m=null}function qe(t,e,n){e instanceof Xe?(t.h=e,function(t,e){e&&!t.j&&(Je(t),t.i=null,t.g.forEach((function(t,e){var n=e.toLowerCase();e!=n&&(Ze(this,e),en(this,n,t))}),t)),t.j=e}(t.h,t.g)):(n||(e=Ge(e,We)),t.h=new Xe(e,t.g))}function Be(t,e,n){t.h.set(e,n)}function Ke(t){return Be(t,"zx",Math.floor(2147483648*Math.random()).toString(36)+Math.abs(Math.floor(2147483648*Math.random())^Date.now()).toString(36)),t}function je(t,e){return t?e?decodeURI(t.replace(/%25/g,"%2525")):decodeURIComponent(t):""}function Ge(t,e,n){return"string"==typeof t?(t=encodeURI(t).replace(e,$e),n&&(t=t.replace(/%25([0-9a-fA-F]{2})/g,"%$1")),t):null}function $e(t){return"%"+((t=t.charCodeAt(0))>>4&15).toString(16)+(15&t).toString(16)}Me.prototype.toString=function(){var t=[],e=this.j;e&&t.push(Ge(e,ze,!0),":");var n=this.i;return(n||"file"==e)&&(t.push("//"),(e=this.s)&&t.push(Ge(e,ze,!0),"@"),t.push(encodeURIComponent(String(n)).replace(/%25([0-9a-fA-F]{2})/g,"%$1")),null!=(n=this.m)&&t.push(":",String(n))),(n=this.l)&&(this.i&&"/"!=n.charAt(0)&&t.push("/"),t.push(Ge(n,"/"==n.charAt(0)?He:Qe,!0))),(n=this.h.toString())&&t.push("?",n),(n=this.o)&&t.push("#",Ge(n,Ye)),t.join("")};var ze=/[#\/\?@]/g,Qe=/[#\?:]/g,He=/[#\?]/g,We=/[#\?@]/g,Ye=/#/g;function Xe(t,e){this.h=this.g=null,this.i=t||null,this.j=!!e}function Je(t){t.g||(t.g=new ke,t.h=0,t.i&&function(t,e){if(t){t=t.split("&");for(var n=0;n<t.length;n++){var s=t[n].indexOf("="),r=null;if(0<=s){var i=t[n].substring(0,s);r=t[n].substring(s+1)}else i=t[n];e(i,r?decodeURIComponent(r.replace(/\+/g," ")):"")}}}(t.i,(function(e,n){t.add(decodeURIComponent(e.replace(/\+/g," ")),n)})))}function Ze(t,e){Je(t),e=nn(t,e),Re(t.g.h,e)&&(t.i=null,t.h-=t.g.get(e).length,Re((t=t.g).h,e)&&(delete t.h[e],t.i--,t.g.length>2*t.i&&Oe(t)))}function tn(t,e){return Je(t),e=nn(t,e),Re(t.g.h,e)}function en(t,e,n){Ze(t,e),0<n.length&&(t.i=null,t.g.set(nn(t,e),_(n)),t.h+=n.length)}function nn(t,e){return e=String(e),t.j&&(e=e.toLowerCase()),e}function sn(t){this.l=t||rn,t=l.PerformanceNavigationTiming?0<(t=l.performance.getEntriesByType("navigation")).length&&("hq"==t[0].nextHopProtocol||"h2"==t[0].nextHopProtocol):!!(l.g&&l.g.Ea&&l.g.Ea()&&l.g.Ea().Zb),this.j=t?this.l:1,this.g=null,1<this.j&&(this.g=new Set),this.h=null,this.i=[]}(s=Xe.prototype).add=function(t,e){Je(this),this.i=null,t=nn(this,t);var n=this.g.get(t);return n||this.g.set(t,n=[]),n.push(e),this.h+=1,this},s.forEach=function(t,e){Je(this),this.g.forEach((function(n,s){x(n,(function(n){t.call(e,n,s,this)}),this)}),this)},s.T=function(){Je(this);for(var t=this.g.R(),e=this.g.T(),n=[],s=0;s<e.length;s++)for(var r=t[s],i=0;i<r.length;i++)n.push(e[s]);return n},s.R=function(t){Je(this);var e=[];if("string"==typeof t)tn(this,t)&&(e=A(e,this.g.get(nn(this,t))));else{t=this.g.R();for(var n=0;n<t.length;n++)e=A(e,t[n])}return e},s.set=function(t,e){return Je(this),this.i=null,tn(this,t=nn(this,t))&&(this.h-=this.g.get(t).length),this.g.set(t,[e]),this.h+=1,this},s.get=function(t,e){return t&&0<(t=this.R(t)).length?String(t[0]):e},s.toString=function(){if(this.i)return this.i;if(!this.g)return"";for(var t=[],e=this.g.T(),n=0;n<e.length;n++){var s=e[n],r=encodeURIComponent(String(s));s=this.R(s);for(var i=0;i<s.length;i++){var o=r;""!==s[i]&&(o+="="+encodeURIComponent(String(s[i]))),t.push(o)}}return this.i=t.join("&")};var rn=10;function on(t){return!!t.h||!!t.g&&t.g.size>=t.j}function an(t){return t.h?1:t.g?t.g.size:0}function cn(t,e){return t.h?t.h==e:!!t.g&&t.g.has(e)}function un(t,e){t.g?t.g.add(e):t.h=e}function hn(t,e){t.h&&t.h==e?t.h=null:t.g&&t.g.has(e)&&t.g.delete(e)}function ln(t){if(null!=t.h)return t.i.concat(t.h.D);if(null!=t.g&&0!==t.g.size){let e=t.i;for(const n of t.g.values())e=e.concat(n.D);return e}return _(t.i)}function dn(){}function fn(){this.g=new dn}function mn(t,e,n){const s=n||"";try{De(t,(function(t,n){let r=t;m(t)&&(r=Nt(t)),e.push(s+n+"="+encodeURIComponent(r))}))}catch(t){throw e.push(s+"type="+encodeURIComponent("_badmap")),t}}function gn(t,e,n,s,r){try{e.onload=null,e.onerror=null,e.onabort=null,e.ontimeout=null,r(s)}catch(t){}}function pn(t){this.l=t.$b||null,this.j=t.ib||!1}function yn(t,e){xt.call(this),this.D=t,this.u=e,this.m=void 0,this.readyState=wn,this.status=0,this.responseType=this.responseText=this.response=this.statusText="",this.onreadystatechange=null,this.v=new Headers,this.h=null,this.C="GET",this.B="",this.g=!1,this.A=this.j=this.l=null}sn.prototype.cancel=function(){if(this.i=ln(this),this.h)this.h.cancel(),this.h=null;else if(this.g&&0!==this.g.size){for(const t of this.g.values())t.cancel();this.g.clear()}},dn.prototype.stringify=function(t){return l.JSON.stringify(t,void 0)},dn.prototype.parse=function(t){return l.JSON.parse(t,void 0)},b(pn,oe),pn.prototype.g=function(){return new yn(this.l,this.j)},pn.prototype.i=function(t){return function(){return t}}({}),b(yn,xt);var wn=0;function vn(t){t.j.read().then(t.Sa.bind(t)).catch(t.ha.bind(t))}function In(t){t.readyState=4,t.l=null,t.j=null,t.A=null,bn(t)}function bn(t){t.onreadystatechange&&t.onreadystatechange.call(t)}(s=yn.prototype).open=function(t,e){if(this.readyState!=wn)throw this.abort(),Error("Error reopening a connection");this.C=t,this.B=e,this.readyState=1,bn(this)},s.send=function(t){if(1!=this.readyState)throw this.abort(),Error("need to call open() first. ");this.g=!0;const e={headers:this.v,method:this.C,credentials:this.m,cache:void 0};t&&(e.body=t),(this.D||l).fetch(new Request(this.B,e)).then(this.Va.bind(this),this.ha.bind(this))},s.abort=function(){this.response=this.responseText="",this.v=new Headers,this.status=0,this.j&&this.j.cancel("Request was aborted."),1<=this.readyState&&this.g&&4!=this.readyState&&(this.g=!1,In(this)),this.readyState=wn},s.Va=function(t){if(this.g&&(this.l=t,this.h||(this.status=this.l.status,this.statusText=this.l.statusText,this.h=t.headers,this.readyState=2,bn(this)),this.g&&(this.readyState=3,bn(this),this.g)))if("arraybuffer"===this.responseType)t.arrayBuffer().then(this.Ta.bind(this),this.ha.bind(this));else if(void 0!==l.ReadableStream&&"body"in t){if(this.j=t.body.getReader(),this.u){if(this.responseType)throw Error('responseType must be empty for "streamBinaryChunks" mode responses.');this.response=[]}else this.response=this.responseText="",this.A=new TextDecoder;vn(this)}else t.text().then(this.Ua.bind(this),this.ha.bind(this))},s.Sa=function(t){if(this.g){if(this.u&&t.value)this.response.push(t.value);else if(!this.u){var e=t.value?t.value:new Uint8Array(0);(e=this.A.decode(e,{stream:!t.done}))&&(this.response=this.responseText+=e)}t.done?In(this):bn(this),3==this.readyState&&vn(this)}},s.Ua=function(t){this.g&&(this.response=this.responseText=t,In(this))},s.Ta=function(t){this.g&&(this.response=t,In(this))},s.ha=function(){this.g&&In(this)},s.setRequestHeader=function(t,e){this.v.append(t,e)},s.getResponseHeader=function(t){return this.h&&this.h.get(t.toLowerCase())||""},s.getAllResponseHeaders=function(){if(!this.h)return"";const t=[],e=this.h.entries();for(var n=e.next();!n.done;)n=n.value,t.push(n[0]+": "+n[1]),n=e.next();return t.join("\r\n")},Object.defineProperty(yn.prototype,"withCredentials",{get:function(){return"include"===this.m},set:function(t){this.m=t?"include":"same-origin"}});var Tn=l.JSON.parse;function En(t){xt.call(this),this.headers=new ke,this.u=t||null,this.h=!1,this.C=this.g=null,this.H="",this.m=0,this.j="",this.l=this.F=this.v=this.D=!1,this.B=0,this.A=null,this.J=Sn,this.K=this.L=!1}b(En,xt);var Sn="",xn=/^https?$/i,An=["POST","PUT"];function _n(t){return"content-type"==t.toLowerCase()}function Nn(t,e){t.h=!1,t.g&&(t.l=!0,t.g.abort(),t.l=!1),t.j=e,t.m=5,Cn(t),kn(t)}function Cn(t){t.D||(t.D=!0,At(t,"complete"),At(t,"error"))}function Dn(t){if(t.h&&void 0!==h&&(!t.C[1]||4!=Rn(t)||2!=t.ba()))if(t.v&&4==Rn(t))qt(t.Fa,0,t);else if(At(t,"readystatechange"),4==Rn(t)){t.h=!1;try{const a=t.ba();t:switch(a){case 200:case 201:case 202:case 204:case 206:case 304:case 1223:var e=!0;break t;default:e=!1}var n;if(!(n=e)){var s;if(s=0===a){var r=String(t.H).match(Le)[1]||null;if(!r&&l.self&&l.self.location){var i=l.self.location.protocol;r=i.substr(0,i.length-1)}s=!xn.test(r?r.toLowerCase():"")}n=s}if(n)At(t,"complete"),At(t,"success");else{t.m=6;try{var o=2<Rn(t)?t.g.statusText:""}catch(t){o=""}t.j=o+" ["+t.ba()+"]",Cn(t)}}finally{kn(t)}}}function kn(t,e){if(t.g){On(t);const n=t.g,s=t.C[0]?d:null;t.g=null,t.C=null,e||At(t,"ready");try{n.onreadystatechange=s}catch(t){}}}function On(t){t.g&&t.K&&(t.g.ontimeout=null),t.A&&(l.clearTimeout(t.A),t.A=null)}function Rn(t){return t.g?t.g.readyState:0}function Ln(t){try{if(!t.g)return null;if("response"in t.g)return t.g.response;switch(t.J){case Sn:case"text":return t.g.responseText;case"arraybuffer":if("mozResponseArrayBuffer"in t.g)return t.g.mozResponseArrayBuffer}return null}catch(t){return null}}function Mn(t,e,n){t:{for(s in n){var s=!1;break t}s=!0}s||(n=function(t){let e="";return M(t,(function(t,n){e+=n,e+=":",e+=t,e+="\r\n"})),e}(n),"string"==typeof t?null!=n&&encodeURIComponent(String(n)):Be(t,e,n))}function Pn(t,e,n){return n&&n.internalChannelParams&&n.internalChannelParams[t]||e}function Fn(t){this.za=0,this.l=[],this.h=new Qt,this.la=this.oa=this.F=this.W=this.g=this.sa=this.D=this.aa=this.o=this.P=this.s=null,this.Za=this.V=0,this.Xa=Pn("failFast",!1,t),this.N=this.v=this.u=this.m=this.j=null,this.X=!0,this.I=this.ta=this.U=-1,this.Y=this.A=this.C=0,this.Pa=Pn("baseRetryDelayMs",5e3,t),this.$a=Pn("retryDelaySeedMs",1e4,t),this.Ya=Pn("forwardChannelMaxRetries",2,t),this.ra=Pn("forwardChannelRequestTimeoutMs",2e4,t),this.qa=t&&t.xmlHttpFactory||void 0,this.Ba=t&&t.Yb||!1,this.K=void 0,this.H=t&&t.supportsCrossDomainXhr||!1,this.J="",this.i=new sn(t&&t.concurrentRequestLimit),this.Ca=new fn,this.ja=t&&t.fastHandshake||!1,this.Ra=t&&t.Wb||!1,t&&t.Aa&&this.h.Aa(),t&&t.forceLongPolling&&(this.X=!1),this.$=!this.ja&&this.X&&t&&t.detectBufferingProxy||!1,this.ka=void 0,this.O=0,this.L=!1,this.B=null,this.Wa=!t||!1!==t.Xb}function Vn(t){if(qn(t),3==t.G){var e=t.V++,n=Pe(t.F);Be(n,"SID",t.J),Be(n,"RID",e),Be(n,"TYPE","terminate"),Gn(t,n),(e=new me(t,t.h,e,void 0)).K=2,e.v=Ke(Pe(n)),n=!1,l.navigator&&l.navigator.sendBeacon&&(n=l.navigator.sendBeacon(e.v.toString(),"")),!n&&l.Image&&((new Image).src=e.v,n=!0),n||(e.g=ns(e.l,null),e.g.ea(e.v)),e.F=Date.now(),Se(e)}ts(t)}function Un(t){t.g&&(Hn(t),t.g.cancel(),t.g=null)}function qn(t){Un(t),t.u&&(l.clearTimeout(t.u),t.u=null),Yn(t),t.i.cancel(),t.m&&("number"==typeof t.m&&l.clearTimeout(t.m),t.m=null)}function Bn(t,e){t.l.push(new class{constructor(t,e){this.h=t,this.g=e}}(t.Za++,e)),3==t.G&&Kn(t)}function Kn(t){on(t.i)||t.m||(t.m=!0,Lt(t.Ha,t),t.C=0)}function jn(t,e){var n;n=e?e.m:t.V++;const s=Pe(t.F);Be(s,"SID",t.J),Be(s,"RID",n),Be(s,"AID",t.U),Gn(t,s),t.o&&t.s&&Mn(s,t.o,t.s),n=new me(t,t.h,n,t.C+1),null===t.o&&(n.H=t.s),e&&(t.l=e.D.concat(t.l)),e=$n(t,n,1e3),n.setTimeout(Math.round(.5*t.ra)+Math.round(.5*t.ra*Math.random())),un(t.i,n),ve(n,s,e)}function Gn(t,e){t.j&&De({},(function(t,n){Be(e,n,t)}))}function $n(t,e,n){n=Math.min(t.l.length,n);var s=t.j?v(t.j.Oa,t.j,t):null;t:{var r=t.l;let e=-1;for(;;){const t=["count="+n];-1==e?0<n?(e=r[0].h,t.push("ofs="+e)):e=0:t.push("ofs="+e);let i=!0;for(let o=0;o<n;o++){let n=r[o].h;const a=r[o].g;if(n-=e,0>n)e=Math.max(0,r[o].h-100),i=!1;else try{mn(a,t,"req"+n+"_")}catch(t){s&&s(a)}}if(i){s=t.join("&");break t}}}return t=t.l.splice(0,n),e.D=t,s}function zn(t){t.g||t.u||(t.Y=1,Lt(t.Ga,t),t.A=0)}function Qn(t){return!(t.g||t.u||3<=t.A||(t.Y++,t.u=se(v(t.Ga,t),Jn(t,t.A)),t.A++,0))}function Hn(t){null!=t.B&&(l.clearTimeout(t.B),t.B=null)}function Wn(t){t.g=new me(t,t.h,"rpc",t.Y),null===t.o&&(t.g.H=t.s),t.g.O=0;var e=Pe(t.oa);Be(e,"RID","rpc"),Be(e,"SID",t.J),Be(e,"CI",t.N?"0":"1"),Be(e,"AID",t.U),Gn(t,e),Be(e,"TYPE","xmlhttp"),t.o&&t.s&&Mn(e,t.o,t.s),t.K&&t.g.setTimeout(t.K);var n=t.g;t=t.la,n.K=1,n.v=Ke(Pe(e)),n.s=null,n.U=!0,Ie(n,t)}function Yn(t){null!=t.v&&(l.clearTimeout(t.v),t.v=null)}function Xn(t,e){var n=null;if(t.g==e){Yn(t),Hn(t),t.g=null;var s=2}else{if(!cn(t.i,e))return;n=e.D,hn(t.i,e),s=1}if(t.I=e.N,0!=t.G)if(e.i)if(1==s){n=e.s?e.s.length:0,e=Date.now()-e.F;var r=t.C;At(s=Xt(),new ne(s,n,e,r)),Kn(t)}else zn(t);else if(3==(r=e.o)||0==r&&0<t.I||!(1==s&&function(t,e){return!(an(t.i)>=t.i.j-(t.m?1:0)||(t.m?(t.l=e.D.concat(t.l),0):1==t.G||2==t.G||t.C>=(t.Xa?0:t.Ya)||(t.m=se(v(t.Ha,t,e),Jn(t,t.C)),t.C++,0)))}(t,e)||2==s&&Qn(t)))switch(n&&0<n.length&&(e=t.i,e.i=e.i.concat(n)),r){case 1:Zn(t,5);break;case 4:Zn(t,10);break;case 3:Zn(t,6);break;default:Zn(t,2)}}function Jn(t,e){let n=t.Pa+Math.floor(Math.random()*t.$a);return t.j||(n*=2),n*e}function Zn(t,e){if(t.h.info("Error code "+e),2==e){var n=null;t.j&&(n=null);var s=v(t.jb,t);n||(n=new Me("//www.google.com/images/cleardot.gif"),l.location&&"http"==l.location.protocol||Fe(n,"https"),Ke(n)),function(t,e){const n=new Qt;if(l.Image){const s=new Image;s.onload=I(gn,n,s,"TestLoadImage: loaded",!0,e),s.onerror=I(gn,n,s,"TestLoadImage: error",!1,e),s.onabort=I(gn,n,s,"TestLoadImage: abort",!1,e),s.ontimeout=I(gn,n,s,"TestLoadImage: timeout",!1,e),l.setTimeout((function(){s.ontimeout&&s.ontimeout()}),1e4),s.src=t}else e(!1)}(n.toString(),s)}else ee(2);t.G=0,t.j&&t.j.va(e),ts(t),qn(t)}function ts(t){t.G=0,t.I=-1,t.j&&(0==ln(t.i).length&&0==t.l.length||(t.i.i.length=0,_(t.l),t.l.length=0),t.j.ua())}function es(t,e,n){let s=function(t){return t instanceof Me?Pe(t):new Me(t,void 0)}(n);if(""!=s.i)e&&Ve(s,e+"."+s.i),Ue(s,s.m);else{const t=l.location;s=function(t,e,n,s){var r=new Me(null,void 0);return t&&Fe(r,t),e&&Ve(r,e),n&&Ue(r,n),s&&(r.l=s),r}(t.protocol,e?e+"."+t.hostname:t.hostname,+t.port,n)}return t.aa&&M(t.aa,(function(t,e){Be(s,e,t)})),e=t.D,n=t.sa,e&&n&&Be(s,e,n),Be(s,"VER",t.ma),Gn(t,s),s}function ns(t,e,n){if(e&&!t.H)throw Error("Can't create secondary domain capable XhrIo object.");return(e=n&&t.Ba&&!t.qa?new En(new pn({ib:!0})):new En(t.qa)).L=t.H,e}function ss(){}function rs(){if(j&&!(10<=Number(et)))throw Error("Environmental error: no available transport.")}function is(t,e){xt.call(this),this.g=new Fn(e),this.l=t,this.h=e&&e.messageUrlParams||null,t=e&&e.messageHeaders||null,e&&e.clientProtocolHeaderRequired&&(t?t["X-Client-Protocol"]="webchannel":t={"X-Client-Protocol":"webchannel"}),this.g.s=t,t=e&&e.initMessageHeaders||null,e&&e.messageContentType&&(t?t["X-WebChannel-Content-Type"]=e.messageContentType:t={"X-WebChannel-Content-Type":e.messageContentType}),e&&e.ya&&(t?t["X-WebChannel-Client-Profile"]=e.ya:t={"X-WebChannel-Client-Profile":e.ya}),this.g.P=t,(t=e&&e.httpHeadersOverwriteParam)&&!N(t)&&(this.g.o=t),this.A=e&&e.supportsCrossDomainXhr||!1,this.v=e&&e.sendRawJson||!1,(e=e&&e.httpSessionIdParam)&&!N(e)&&(this.g.D=e,null!==(t=this.h)&&e in t&&e in(t=this.h)&&delete t[e]),this.j=new cs(this)}function os(t){le.call(this);var e=t.__sm__;if(e){t:{for(const n in e){t=n;break t}t=void 0}(this.i=t)&&(t=this.i,e=null!==e&&t in e?e[t]:void 0),this.data=e}else this.data=t}function as(){de.call(this),this.status=1}function cs(t){this.g=t}(s=En.prototype).ea=function(t,e,n,s){if(this.g)throw Error("[goog.net.XhrIo] Object is active with another request="+this.H+"; newUri="+t);e=e?e.toUpperCase():"GET",this.H=t,this.j="",this.m=0,this.D=!1,this.h=!0,this.g=this.u?this.u.g():ue.g(),this.C=this.u?ae(this.u):ae(ue),this.g.onreadystatechange=v(this.Fa,this);try{this.F=!0,this.g.open(e,String(t),!0),this.F=!1}catch(t){return void Nn(this,t)}t=n||"";const r=new ke(this.headers);s&&De(s,(function(t,e){r.set(e,t)})),s=function(t){t:{var e=_n;const n=t.length,s="string"==typeof t?t.split(""):t;for(let r=0;r<n;r++)if(r in s&&e.call(void 0,s[r],r,t)){e=r;break t}e=-1}return 0>e?null:"string"==typeof t?t.charAt(e):t[e]}(r.T()),n=l.FormData&&t instanceof l.FormData,!(0<=S(An,e))||s||n||r.set("Content-Type","application/x-www-form-urlencoded;charset=utf-8"),r.forEach((function(t,e){this.g.setRequestHeader(e,t)}),this),this.J&&(this.g.responseType=this.J),"withCredentials"in this.g&&this.g.withCredentials!==this.L&&(this.g.withCredentials=this.L);try{On(this),0<this.B&&((this.K=function(t){return j&&tt()&&"number"==typeof t.timeout&&void 0!==t.ontimeout}(this.g))?(this.g.timeout=this.B,this.g.ontimeout=v(this.pa,this)):this.A=qt(this.pa,this.B,this)),this.v=!0,this.g.send(t),this.v=!1}catch(t){Nn(this,t)}},s.pa=function(){void 0!==h&&this.g&&(this.j="Timed out after "+this.B+"ms, aborting",this.m=8,At(this,"timeout"),this.abort(8))},s.abort=function(t){this.g&&this.h&&(this.h=!1,this.l=!0,this.g.abort(),this.l=!1,this.m=t||7,At(this,"complete"),At(this,"abort"),kn(this))},s.M=function(){this.g&&(this.h&&(this.h=!1,this.l=!0,this.g.abort(),this.l=!1),kn(this,!0)),En.Z.M.call(this)},s.Fa=function(){this.s||(this.F||this.v||this.l?Dn(this):this.cb())},s.cb=function(){Dn(this)},s.ba=function(){try{return 2<Rn(this)?this.g.status:-1}catch(t){return-1}},s.ga=function(){try{return this.g?this.g.responseText:""}catch(t){return""}},s.Qa=function(t){if(this.g){var e=this.g.responseText;return t&&0==e.indexOf(t)&&(e=e.substring(t.length)),Tn(e)}},s.Da=function(){return this.m},s.La=function(){return"string"==typeof this.j?this.j:String(this.j)},(s=Fn.prototype).ma=8,s.G=1,s.hb=function(t){try{this.h.info("Origin Trials invoked: "+t)}catch(t){}},s.Ha=function(t){if(this.m)if(this.m=null,1==this.G){if(!t){this.V=Math.floor(1e5*Math.random()),t=this.V++;const r=new me(this,this.h,t,void 0);let i=this.s;if(this.P&&(i?(i=P(i),V(i,this.P)):i=this.P),null===this.o&&(r.H=i),this.ja)t:{for(var e=0,n=0;n<this.l.length;n++){var s=this.l[n];if(void 0===(s="__data__"in s.g&&"string"==typeof(s=s.g.__data__)?s.length:void 0))break;if(4096<(e+=s)){e=n;break t}if(4096===e||n===this.l.length-1){e=n+1;break t}}e=1e3}else e=1e3;e=$n(this,r,e),Be(n=Pe(this.F),"RID",t),Be(n,"CVER",22),this.D&&Be(n,"X-HTTP-Session-Id",this.D),Gn(this,n),this.o&&i&&Mn(n,this.o,i),un(this.i,r),this.Ra&&Be(n,"TYPE","init"),this.ja?(Be(n,"$req",e),Be(n,"SID","null"),r.$=!0,ve(r,n,null)):ve(r,n,e),this.G=2}}else 3==this.G&&(t?jn(this,t):0==this.l.length||on(this.i)||jn(this))},s.Ga=function(){if(this.u=null,Wn(this),this.$&&!(this.L||null==this.g||0>=this.O)){var t=2*this.O;this.h.info("BP detection timer enabled: "+t),this.B=se(v(this.bb,this),t)}},s.bb=function(){this.B&&(this.B=null,this.h.info("BP detection timeout reached."),this.h.info("Buffering proxy detected and switch to long-polling!"),this.N=!1,this.L=!0,ee(10),Un(this),Wn(this))},s.ab=function(){null!=this.v&&(this.v=null,Un(this),Qn(this),ee(19))},s.jb=function(t){t?(this.h.info("Successfully pinged google.com"),ee(2)):(this.h.info("Failed to ping google.com"),ee(1))},(s=ss.prototype).xa=function(){},s.wa=function(){},s.va=function(){},s.ua=function(){},s.Oa=function(){},rs.prototype.g=function(t,e){return new is(t,e)},b(is,xt),is.prototype.m=function(){this.g.j=this.j,this.A&&(this.g.H=!0);var t=this.g,e=this.l,n=this.h||void 0;t.Wa&&(t.h.info("Origin Trials enabled."),Lt(v(t.hb,t,e))),ee(0),t.W=e,t.aa=n||{},t.N=t.X,t.F=es(t,null,t.W),Kn(t)},is.prototype.close=function(){Vn(this.g)},is.prototype.u=function(t){if("string"==typeof t){var e={};e.__data__=t,Bn(this.g,e)}else this.v?((e={}).__data__=Nt(t),Bn(this.g,e)):Bn(this.g,t)},is.prototype.M=function(){this.g.j=null,delete this.j,Vn(this.g),delete this.g,is.Z.M.call(this)},b(os,le),b(as,de),b(cs,ss),cs.prototype.xa=function(){At(this.g,"a")},cs.prototype.wa=function(t){At(this.g,new os(t))},cs.prototype.va=function(t){At(this.g,new as(t))},cs.prototype.ua=function(){At(this.g,"b")},rs.prototype.createWebChannel=rs.prototype.g,is.prototype.send=is.prototype.u,is.prototype.open=is.prototype.m,is.prototype.close=is.prototype.close,re.NO_ERROR=0,re.TIMEOUT=8,re.HTTP_ERROR=6,ie.COMPLETE="complete",ce.EventType=he,he.OPEN="a",he.CLOSE="b",he.ERROR="c",he.MESSAGE="d",xt.prototype.listen=xt.prototype.N,En.prototype.listenOnce=En.prototype.O,En.prototype.getLastError=En.prototype.La,En.prototype.getLastErrorCode=En.prototype.Da,En.prototype.getStatus=En.prototype.ba,En.prototype.getResponseJson=En.prototype.Qa,En.prototype.getResponseText=En.prototype.ga,En.prototype.send=En.prototype.ea;var us=u.createWebChannelTransport=function(){return new rs},hs=u.getStatEventTarget=function(){return Xt()},ls=u.ErrorCode=re,ds=u.EventType=ie,fs=u.Event=Wt,ms=u.Stat={rb:0,ub:1,vb:2,Ob:3,Tb:4,Qb:5,Rb:6,Pb:7,Nb:8,Sb:9,PROXY:10,NOPROXY:11,Lb:12,Hb:13,Ib:14,Gb:15,Jb:16,Kb:17,nb:18,mb:19,ob:20},gs=u.FetchXmlHttpFactory=pn,ps=u.WebChannel=ce,ys=u.XhrIo=En,ws=n(34406);const vs="@firebase/firestore";class Is{constructor(t){this.uid=t}isAuthenticated(){return null!=this.uid}toKey(){return this.isAuthenticated()?"uid:"+this.uid:"anonymous-user"}isEqual(t){return t.uid===this.uid}}Is.UNAUTHENTICATED=new Is(null),Is.GOOGLE_CREDENTIALS=new Is("google-credentials-uid"),Is.FIRST_PARTY=new Is("first-party-uid"),Is.MOCK_USER=new Is("mock-user");let bs="9.6.7";const Ts=new o.Yd("@firebase/firestore");function Es(){return Ts.logLevel}function Ss(t){Ts.setLogLevel(t)}function xs(t,...e){if(Ts.logLevel<=o.in.DEBUG){const n=e.map(Ns);Ts.debug(`Firestore (${bs}): ${t}`,...n)}}function As(t,...e){if(Ts.logLevel<=o.in.ERROR){const n=e.map(Ns);Ts.error(`Firestore (${bs}): ${t}`,...n)}}function _s(t,...e){if(Ts.logLevel<=o.in.WARN){const n=e.map(Ns);Ts.warn(`Firestore (${bs}): ${t}`,...n)}}function Ns(t){if("string"==typeof t)return t;try{return e=t,JSON.stringify(e)}catch(e){return t}var e}function Cs(t="Unexpected state"){const e=`FIRESTORE (${bs}) INTERNAL ASSERTION FAILED: `+t;throw As(e),new Error(e)}function Ds(t,e){t||Cs()}function ks(t,e){t||Cs()}function Os(t,e){return t}const Rs={OK:"ok",CANCELLED:"cancelled",UNKNOWN:"unknown",INVALID_ARGUMENT:"invalid-argument",DEADLINE_EXCEEDED:"deadline-exceeded",NOT_FOUND:"not-found",ALREADY_EXISTS:"already-exists",PERMISSION_DENIED:"permission-denied",UNAUTHENTICATED:"unauthenticated",RESOURCE_EXHAUSTED:"resource-exhausted",FAILED_PRECONDITION:"failed-precondition",ABORTED:"aborted",OUT_OF_RANGE:"out-of-range",UNIMPLEMENTED:"unimplemented",INTERNAL:"internal",UNAVAILABLE:"unavailable",DATA_LOSS:"data-loss"};class Ls extends a.ZR{constructor(t,e){super(t,e),this.code=t,this.message=e,this.toString=()=>`${this.name}: [code=${this.code}]: ${this.message}`}}class Ms{constructor(){this.promise=new Promise(((t,e)=>{this.resolve=t,this.reject=e}))}}class Ps{constructor(t,e){this.user=e,this.type="OAuth",this.headers=new Map,this.headers.set("Authorization",`Bearer ${t}`)}}class Fs{getToken(){return Promise.resolve(null)}invalidateToken(){}start(t,e){t.enqueueRetryable((()=>e(Is.UNAUTHENTICATED)))}shutdown(){}}class Vs{constructor(t){this.token=t,this.changeListener=null}getToken(){return Promise.resolve(this.token)}invalidateToken(){}start(t,e){this.changeListener=e,t.enqueueRetryable((()=>e(this.token.user)))}shutdown(){this.changeListener=null}}class Us{constructor(t){this.t=t,this.currentUser=Is.UNAUTHENTICATED,this.i=0,this.forceRefresh=!1,this.auth=null}start(t,e){let n=this.i;const s=t=>this.i!==n?(n=this.i,e(t)):Promise.resolve();let r=new Ms;this.o=()=>{this.i++,this.currentUser=this.u(),r.resolve(),r=new Ms,t.enqueueRetryable((()=>s(this.currentUser)))};const i=()=>{const e=r;t.enqueueRetryable((async()=>{await e.promise,await s(this.currentUser)}))},o=t=>{xs("FirebaseAuthCredentialsProvider","Auth detected"),this.auth=t,this.auth.addAuthTokenListener(this.o),i()};this.t.onInit((t=>o(t))),setTimeout((()=>{if(!this.auth){const t=this.t.getImmediate({optional:!0});t?o(t):(xs("FirebaseAuthCredentialsProvider","Auth not yet detected"),r.resolve(),r=new Ms)}}),0),i()}getToken(){const t=this.i,e=this.forceRefresh;return this.forceRefresh=!1,this.auth?this.auth.getToken(e).then((e=>this.i!==t?(xs("FirebaseAuthCredentialsProvider","getToken aborted due to token change."),this.getToken()):e?(Ds("string"==typeof e.accessToken),new Ps(e.accessToken,this.currentUser)):null)):Promise.resolve(null)}invalidateToken(){this.forceRefresh=!0}shutdown(){this.auth&&this.auth.removeAuthTokenListener(this.o)}u(){const t=this.auth&&this.auth.getUid();return Ds(null===t||"string"==typeof t),new Is(t)}}class qs{constructor(t,e,n){this.type="FirstParty",this.user=Is.FIRST_PARTY,this.headers=new Map,this.headers.set("X-Goog-AuthUser",e);const s=t.auth.getAuthHeaderValueForFirstParty([]);s&&this.headers.set("Authorization",s),n&&this.headers.set("X-Goog-Iam-Authorization-Token",n)}}class Bs{constructor(t,e,n){this.h=t,this.l=e,this.m=n}getToken(){return Promise.resolve(new qs(this.h,this.l,this.m))}start(t,e){t.enqueueRetryable((()=>e(Is.FIRST_PARTY)))}shutdown(){}invalidateToken(){}}class Ks{constructor(t){this.value=t,this.type="AppCheck",this.headers=new Map,t&&t.length>0&&this.headers.set("x-firebase-appcheck",this.value)}}class js{constructor(t){this.g=t,this.forceRefresh=!1,this.appCheck=null,this.p=null}start(t,e){const n=t=>{null!=t.error&&xs("FirebaseAppCheckTokenProvider",`Error getting App Check token; using placeholder token instead. Error: ${t.error.message}`);const n=t.token!==this.p;return this.p=t.token,xs("FirebaseAppCheckTokenProvider",`Received ${n?"new":"existing"} token.`),n?e(t.token):Promise.resolve()};this.o=e=>{t.enqueueRetryable((()=>n(e)))};const s=t=>{xs("FirebaseAppCheckTokenProvider","AppCheck detected"),this.appCheck=t,this.appCheck.addTokenListener(this.o)};this.g.onInit((t=>s(t))),setTimeout((()=>{if(!this.appCheck){const t=this.g.getImmediate({optional:!0});t?s(t):xs("FirebaseAppCheckTokenProvider","AppCheck not yet detected")}}),0)}getToken(){const t=this.forceRefresh;return this.forceRefresh=!1,this.appCheck?this.appCheck.getToken(t).then((t=>t?(Ds("string"==typeof t.token),this.p=t.token,new Ks(t.token)):null)):Promise.resolve(null)}invalidateToken(){this.forceRefresh=!0}shutdown(){this.appCheck&&this.appCheck.removeTokenListener(this.o)}}class Gs{getToken(){return Promise.resolve(new Ks(""))}invalidateToken(){}start(t,e){}shutdown(){}}class $s{constructor(t,e){this.previousValue=t,e&&(e.sequenceNumberHandler=t=>this.I(t),this.T=t=>e.writeSequenceNumber(t))}I(t){return this.previousValue=Math.max(t,this.previousValue),this.previousValue}next(){const t=++this.previousValue;return this.T&&this.T(t),t}}function zs(t){const e="undefined"!=typeof self&&(self.crypto||self.msCrypto),n=new Uint8Array(t);if(e&&"function"==typeof e.getRandomValues)e.getRandomValues(n);else for(let e=0;e<t;e++)n[e]=Math.floor(256*Math.random());return n}$s.A=-1;class Qs{static R(){const t="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",e=Math.floor(256/t.length)*t.length;let n="";for(;n.length<20;){const s=zs(40);for(let r=0;r<s.length;++r)n.length<20&&s[r]<e&&(n+=t.charAt(s[r]%t.length))}return n}}function Hs(t,e){return t<e?-1:t>e?1:0}function Ws(t,e,n){return t.length===e.length&&t.every(((t,s)=>n(t,e[s])))}function Ys(t){return t+"\0"}class Xs{constructor(t,e){if(this.seconds=t,this.nanoseconds=e,e<0)throw new Ls(Rs.INVALID_ARGUMENT,"Timestamp nanoseconds out of range: "+e);if(e>=1e9)throw new Ls(Rs.INVALID_ARGUMENT,"Timestamp nanoseconds out of range: "+e);if(t<-62135596800)throw new Ls(Rs.INVALID_ARGUMENT,"Timestamp seconds out of range: "+t);if(t>=253402300800)throw new Ls(Rs.INVALID_ARGUMENT,"Timestamp seconds out of range: "+t)}static now(){return Xs.fromMillis(Date.now())}static fromDate(t){return Xs.fromMillis(t.getTime())}static fromMillis(t){const e=Math.floor(t/1e3),n=Math.floor(1e6*(t-1e3*e));return new Xs(e,n)}toDate(){return new Date(this.toMillis())}toMillis(){return 1e3*this.seconds+this.nanoseconds/1e6}_compareTo(t){return this.seconds===t.seconds?Hs(this.nanoseconds,t.nanoseconds):Hs(this.seconds,t.seconds)}isEqual(t){return t.seconds===this.seconds&&t.nanoseconds===this.nanoseconds}toString(){return"Timestamp(seconds="+this.seconds+", nanoseconds="+this.nanoseconds+")"}toJSON(){return{seconds:this.seconds,nanoseconds:this.nanoseconds}}valueOf(){const t=this.seconds- -62135596800;return String(t).padStart(12,"0")+"."+String(this.nanoseconds).padStart(9,"0")}}class Js{constructor(t){this.timestamp=t}static fromTimestamp(t){return new Js(t)}static min(){return new Js(new Xs(0,0))}compareTo(t){return this.timestamp._compareTo(t.timestamp)}isEqual(t){return this.timestamp.isEqual(t.timestamp)}toMicroseconds(){return 1e6*this.timestamp.seconds+this.timestamp.nanoseconds/1e3}toString(){return"SnapshotVersion("+this.timestamp.toString()+")"}toTimestamp(){return this.timestamp}}function Zs(t){let e=0;for(const n in t)Object.prototype.hasOwnProperty.call(t,n)&&e++;return e}function tr(t,e){for(const n in t)Object.prototype.hasOwnProperty.call(t,n)&&e(n,t[n])}function er(t){for(const e in t)if(Object.prototype.hasOwnProperty.call(t,e))return!1;return!0}class nr{constructor(t,e,n){void 0===e?e=0:e>t.length&&Cs(),void 0===n?n=t.length-e:n>t.length-e&&Cs(),this.segments=t,this.offset=e,this.len=n}get length(){return this.len}isEqual(t){return 0===nr.comparator(this,t)}child(t){const e=this.segments.slice(this.offset,this.limit());return t instanceof nr?t.forEach((t=>{e.push(t)})):e.push(t),this.construct(e)}limit(){return this.offset+this.length}popFirst(t){return t=void 0===t?1:t,this.construct(this.segments,this.offset+t,this.length-t)}popLast(){return this.construct(this.segments,this.offset,this.length-1)}firstSegment(){return this.segments[this.offset]}lastSegment(){return this.get(this.length-1)}get(t){return this.segments[this.offset+t]}isEmpty(){return 0===this.length}isPrefixOf(t){if(t.length<this.length)return!1;for(let e=0;e<this.length;e++)if(this.get(e)!==t.get(e))return!1;return!0}isImmediateParentOf(t){if(this.length+1!==t.length)return!1;for(let e=0;e<this.length;e++)if(this.get(e)!==t.get(e))return!1;return!0}forEach(t){for(let e=this.offset,n=this.limit();e<n;e++)t(this.segments[e])}toArray(){return this.segments.slice(this.offset,this.limit())}static comparator(t,e){const n=Math.min(t.length,e.length);for(let s=0;s<n;s++){const n=t.get(s),r=e.get(s);if(n<r)return-1;if(n>r)return 1}return t.length<e.length?-1:t.length>e.length?1:0}}class sr extends nr{construct(t,e,n){return new sr(t,e,n)}canonicalString(){return this.toArray().join("/")}toString(){return this.canonicalString()}static fromString(...t){const e=[];for(const n of t){if(n.indexOf("//")>=0)throw new Ls(Rs.INVALID_ARGUMENT,`Invalid segment (${n}). Paths must not contain // in them.`);e.push(...n.split("/").filter((t=>t.length>0)))}return new sr(e)}static emptyPath(){return new sr([])}}const rr=/^[_a-zA-Z][_a-zA-Z0-9]*$/;class ir extends nr{construct(t,e,n){return new ir(t,e,n)}static isValidIdentifier(t){return rr.test(t)}canonicalString(){return this.toArray().map((t=>(t=t.replace(/\\/g,"\\\\").replace(/`/g,"\\`"),ir.isValidIdentifier(t)||(t="`"+t+"`"),t))).join(".")}toString(){return this.canonicalString()}isKeyField(){return 1===this.length&&"__name__"===this.get(0)}static keyField(){return new ir(["__name__"])}static fromServerFormat(t){const e=[];let n="",s=0;const r=()=>{if(0===n.length)throw new Ls(Rs.INVALID_ARGUMENT,`Invalid field path (${t}). Paths must not be empty, begin with '.', end with '.', or contain '..'`);e.push(n),n=""};let i=!1;for(;s<t.length;){const e=t[s];if("\\"===e){if(s+1===t.length)throw new Ls(Rs.INVALID_ARGUMENT,"Path has trailing escape character: "+t);const e=t[s+1];if("\\"!==e&&"."!==e&&"`"!==e)throw new Ls(Rs.INVALID_ARGUMENT,"Path has invalid escape sequence: "+t);n+=e,s+=2}else"`"===e?(i=!i,s++):"."!==e||i?(n+=e,s++):(r(),s++)}if(r(),i)throw new Ls(Rs.INVALID_ARGUMENT,"Unterminated ` in path: "+t);return new ir(e)}static emptyPath(){return new ir([])}}class or{constructor(t){this.fields=t,t.sort(ir.comparator)}covers(t){for(const e of this.fields)if(e.isPrefixOf(t))return!0;return!1}isEqual(t){return Ws(this.fields,t.fields,((t,e)=>t.isEqual(e)))}}function ar(){return"undefined"!=typeof atob}class cr{constructor(t){this.binaryString=t}static fromBase64String(t){const e=atob(t);return new cr(e)}static fromUint8Array(t){const e=function(t){let e="";for(let n=0;n<t.length;++n)e+=String.fromCharCode(t[n]);return e}(t);return new cr(e)}[Symbol.iterator](){let t=0;return{next:()=>t<this.binaryString.length?{value:this.binaryString.charCodeAt(t++),done:!1}:{value:void 0,done:!0}}}toBase64(){return t=this.binaryString,btoa(t);var t}toUint8Array(){return function(t){const e=new Uint8Array(t.length);for(let n=0;n<t.length;n++)e[n]=t.charCodeAt(n);return e}(this.binaryString)}approximateByteSize(){return 2*this.binaryString.length}compareTo(t){return Hs(this.binaryString,t.binaryString)}isEqual(t){return this.binaryString===t.binaryString}}cr.EMPTY_BYTE_STRING=new cr("");const ur=new RegExp(/^\d{4}-\d\d-\d\dT\d\d:\d\d:\d\d(?:\.(\d+))?Z$/);function hr(t){if(Ds(!!t),"string"==typeof t){let e=0;const n=ur.exec(t);if(Ds(!!n),n[1]){let t=n[1];t=(t+"000000000").substr(0,9),e=Number(t)}const s=new Date(t);return{seconds:Math.floor(s.getTime()/1e3),nanos:e}}return{seconds:lr(t.seconds),nanos:lr(t.nanos)}}function lr(t){return"number"==typeof t?t:"string"==typeof t?Number(t):0}function dr(t){return"string"==typeof t?cr.fromBase64String(t):cr.fromUint8Array(t)}function fr(t){var e,n;return"server_timestamp"===(null===(n=((null===(e=null==t?void 0:t.mapValue)||void 0===e?void 0:e.fields)||{}).__type__)||void 0===n?void 0:n.stringValue)}function mr(t){const e=t.mapValue.fields.__previous_value__;return fr(e)?mr(e):e}function gr(t){const e=hr(t.mapValue.fields.__local_write_time__.timestampValue);return new Xs(e.seconds,e.nanos)}class pr{constructor(t,e,n,s,r,i,o,a){this.databaseId=t,this.appId=e,this.persistenceKey=n,this.host=s,this.ssl=r,this.forceLongPolling=i,this.autoDetectLongPolling=o,this.useFetchStreams=a}}class yr{constructor(t,e){this.projectId=t,this.database=e||"(default)"}static empty(){return new yr("","")}get isDefaultDatabase(){return"(default)"===this.database}isEqual(t){return t instanceof yr&&t.projectId===this.projectId&&t.database===this.database}}function wr(t){return null==t}function vr(t){return 0===t&&1/t==-1/0}function Ir(t){return"number"==typeof t&&Number.isInteger(t)&&!vr(t)&&t<=Number.MAX_SAFE_INTEGER&&t>=Number.MIN_SAFE_INTEGER}class br{constructor(t){this.path=t}static fromPath(t){return new br(sr.fromString(t))}static fromName(t){return new br(sr.fromString(t).popFirst(5))}static empty(){return new br(sr.emptyPath())}get collectionGroup(){return this.path.popLast().lastSegment()}hasCollectionId(t){return this.path.length>=2&&this.path.get(this.path.length-2)===t}getCollectionGroup(){return this.path.get(this.path.length-2)}getCollectionPath(){return this.path.popLast()}isEqual(t){return null!==t&&0===sr.comparator(this.path,t.path)}toString(){return this.path.toString()}static comparator(t,e){return sr.comparator(t.path,e.path)}static isDocumentKey(t){return t.length%2==0}static fromSegments(t){return new br(new sr(t.slice()))}}const Tr={mapValue:{fields:{__type__:{stringValue:"__max___"}}}};function Er(t){return"nullValue"in t?0:"booleanValue"in t?1:"integerValue"in t||"doubleValue"in t?2:"timestampValue"in t?3:"stringValue"in t?5:"bytesValue"in t?6:"referenceValue"in t?7:"geoPointValue"in t?8:"arrayValue"in t?9:"mapValue"in t?fr(t)?4:10:Cs()}function Sr(t,e){if(t===e)return!0;const n=Er(t);if(n!==Er(e))return!1;switch(n){case 0:return!0;case 1:return t.booleanValue===e.booleanValue;case 4:return gr(t).isEqual(gr(e));case 3:return function(t,e){if("string"==typeof t.timestampValue&&"string"==typeof e.timestampValue&&t.timestampValue.length===e.timestampValue.length)return t.timestampValue===e.timestampValue;const n=hr(t.timestampValue),s=hr(e.timestampValue);return n.seconds===s.seconds&&n.nanos===s.nanos}(t,e);case 5:return t.stringValue===e.stringValue;case 6:return function(t,e){return dr(t.bytesValue).isEqual(dr(e.bytesValue))}(t,e);case 7:return t.referenceValue===e.referenceValue;case 8:return function(t,e){return lr(t.geoPointValue.latitude)===lr(e.geoPointValue.latitude)&&lr(t.geoPointValue.longitude)===lr(e.geoPointValue.longitude)}(t,e);case 2:return function(t,e){if("integerValue"in t&&"integerValue"in e)return lr(t.integerValue)===lr(e.integerValue);if("doubleValue"in t&&"doubleValue"in e){const n=lr(t.doubleValue),s=lr(e.doubleValue);return n===s?vr(n)===vr(s):isNaN(n)&&isNaN(s)}return!1}(t,e);case 9:return Ws(t.arrayValue.values||[],e.arrayValue.values||[],Sr);case 10:return function(t,e){const n=t.mapValue.fields||{},s=e.mapValue.fields||{};if(Zs(n)!==Zs(s))return!1;for(const t in n)if(n.hasOwnProperty(t)&&(void 0===s[t]||!Sr(n[t],s[t])))return!1;return!0}(t,e);default:return Cs()}}function xr(t,e){return void 0!==(t.values||[]).find((t=>Sr(t,e)))}function Ar(t,e){if(t===e)return 0;const n=Er(t),s=Er(e);if(n!==s)return Hs(n,s);switch(n){case 0:return 0;case 1:return Hs(t.booleanValue,e.booleanValue);case 2:return function(t,e){const n=lr(t.integerValue||t.doubleValue),s=lr(e.integerValue||e.doubleValue);return n<s?-1:n>s?1:n===s?0:isNaN(n)?isNaN(s)?0:-1:1}(t,e);case 3:return _r(t.timestampValue,e.timestampValue);case 4:return _r(gr(t),gr(e));case 5:return Hs(t.stringValue,e.stringValue);case 6:return function(t,e){const n=dr(t),s=dr(e);return n.compareTo(s)}(t.bytesValue,e.bytesValue);case 7:return function(t,e){const n=t.split("/"),s=e.split("/");for(let t=0;t<n.length&&t<s.length;t++){const e=Hs(n[t],s[t]);if(0!==e)return e}return Hs(n.length,s.length)}(t.referenceValue,e.referenceValue);case 8:return function(t,e){const n=Hs(lr(t.latitude),lr(e.latitude));return 0!==n?n:Hs(lr(t.longitude),lr(e.longitude))}(t.geoPointValue,e.geoPointValue);case 9:return function(t,e){const n=t.values||[],s=e.values||[];for(let t=0;t<n.length&&t<s.length;++t){const e=Ar(n[t],s[t]);if(e)return e}return Hs(n.length,s.length)}(t.arrayValue,e.arrayValue);case 10:return function(t,e){const n=t.fields||{},s=Object.keys(n),r=e.fields||{},i=Object.keys(r);s.sort(),i.sort();for(let t=0;t<s.length&&t<i.length;++t){const e=Hs(s[t],i[t]);if(0!==e)return e;const o=Ar(n[s[t]],r[i[t]]);if(0!==o)return o}return Hs(s.length,i.length)}(t.mapValue,e.mapValue);default:throw Cs()}}function _r(t,e){if("string"==typeof t&&"string"==typeof e&&t.length===e.length)return Hs(t,e);const n=hr(t),s=hr(e),r=Hs(n.seconds,s.seconds);return 0!==r?r:Hs(n.nanos,s.nanos)}function Nr(t){return Cr(t)}function Cr(t){return"nullValue"in t?"null":"booleanValue"in t?""+t.booleanValue:"integerValue"in t?""+t.integerValue:"doubleValue"in t?""+t.doubleValue:"timestampValue"in t?function(t){const e=hr(t);return`time(${e.seconds},${e.nanos})`}(t.timestampValue):"stringValue"in t?t.stringValue:"bytesValue"in t?dr(t.bytesValue).toBase64():"referenceValue"in t?(n=t.referenceValue,br.fromName(n).toString()):"geoPointValue"in t?`geo(${(e=t.geoPointValue).latitude},${e.longitude})`:"arrayValue"in t?function(t){let e="[",n=!0;for(const s of t.values||[])n?n=!1:e+=",",e+=Cr(s);return e+"]"}(t.arrayValue):"mapValue"in t?function(t){const e=Object.keys(t.fields||{}).sort();let n="{",s=!0;for(const r of e)s?s=!1:n+=",",n+=`${r}:${Cr(t.fields[r])}`;return n+"}"}(t.mapValue):Cs();var e,n}function Dr(t,e){return{referenceValue:`projects/${t.projectId}/databases/${t.database}/documents/${e.path.canonicalString()}`}}function kr(t){return!!t&&"integerValue"in t}function Or(t){return!!t&&"arrayValue"in t}function Rr(t){return!!t&&"nullValue"in t}function Lr(t){return!!t&&"doubleValue"in t&&isNaN(Number(t.doubleValue))}function Mr(t){return!!t&&"mapValue"in t}function Pr(t){if(t.geoPointValue)return{geoPointValue:Object.assign({},t.geoPointValue)};if(t.timestampValue&&"object"==typeof t.timestampValue)return{timestampValue:Object.assign({},t.timestampValue)};if(t.mapValue){const e={mapValue:{fields:{}}};return tr(t.mapValue.fields,((t,n)=>e.mapValue.fields[t]=Pr(n))),e}if(t.arrayValue){const e={arrayValue:{values:[]}};for(let n=0;n<(t.arrayValue.values||[]).length;++n)e.arrayValue.values[n]=Pr(t.arrayValue.values[n]);return e}return Object.assign({},t)}class Fr{constructor(t){this.value=t}static empty(){return new Fr({mapValue:{}})}field(t){if(t.isEmpty())return this.value;{let e=this.value;for(let n=0;n<t.length-1;++n)if(e=(e.mapValue.fields||{})[t.get(n)],!Mr(e))return null;return e=(e.mapValue.fields||{})[t.lastSegment()],e||null}}set(t,e){this.getFieldsMap(t.popLast())[t.lastSegment()]=Pr(e)}setAll(t){let e=ir.emptyPath(),n={},s=[];t.forEach(((t,r)=>{if(!e.isImmediateParentOf(r)){const t=this.getFieldsMap(e);this.applyChanges(t,n,s),n={},s=[],e=r.popLast()}t?n[r.lastSegment()]=Pr(t):s.push(r.lastSegment())}));const r=this.getFieldsMap(e);this.applyChanges(r,n,s)}delete(t){const e=this.field(t.popLast());Mr(e)&&e.mapValue.fields&&delete e.mapValue.fields[t.lastSegment()]}isEqual(t){return Sr(this.value,t.value)}getFieldsMap(t){let e=this.value;e.mapValue.fields||(e.mapValue={fields:{}});for(let n=0;n<t.length;++n){let s=e.mapValue.fields[t.get(n)];Mr(s)&&s.mapValue.fields||(s={mapValue:{fields:{}}},e.mapValue.fields[t.get(n)]=s),e=s}return e.mapValue.fields}applyChanges(t,e,n){tr(e,((e,n)=>t[e]=n));for(const e of n)delete t[e]}clone(){return new Fr(Pr(this.value))}}function Vr(t){const e=[];return tr(t.fields,((t,n)=>{const s=new ir([t]);if(Mr(n)){const t=Vr(n.mapValue).fields;if(0===t.length)e.push(s);else for(const n of t)e.push(s.child(n))}else e.push(s)})),new or(e)}class Ur{constructor(t,e,n,s,r,i){this.key=t,this.documentType=e,this.version=n,this.readTime=s,this.data=r,this.documentState=i}static newInvalidDocument(t){return new Ur(t,0,Js.min(),Js.min(),Fr.empty(),0)}static newFoundDocument(t,e,n){return new Ur(t,1,e,Js.min(),n,0)}static newNoDocument(t,e){return new Ur(t,2,e,Js.min(),Fr.empty(),0)}static newUnknownDocument(t,e){return new Ur(t,3,e,Js.min(),Fr.empty(),2)}convertToFoundDocument(t,e){return this.version=t,this.documentType=1,this.data=e,this.documentState=0,this}convertToNoDocument(t){return this.version=t,this.documentType=2,this.data=Fr.empty(),this.documentState=0,this}convertToUnknownDocument(t){return this.version=t,this.documentType=3,this.data=Fr.empty(),this.documentState=2,this}setHasCommittedMutations(){return this.documentState=2,this}setHasLocalMutations(){return this.documentState=1,this}setReadTime(t){return this.readTime=t,this}get hasLocalMutations(){return 1===this.documentState}get hasCommittedMutations(){return 2===this.documentState}get hasPendingWrites(){return this.hasLocalMutations||this.hasCommittedMutations}isValidDocument(){return 0!==this.documentType}isFoundDocument(){return 1===this.documentType}isNoDocument(){return 2===this.documentType}isUnknownDocument(){return 3===this.documentType}isEqual(t){return t instanceof Ur&&this.key.isEqual(t.key)&&this.version.isEqual(t.version)&&this.documentType===t.documentType&&this.documentState===t.documentState&&this.data.isEqual(t.data)}mutableCopy(){return new Ur(this.key,this.documentType,this.version,this.readTime,this.data.clone(),this.documentState)}toString(){return`Document(${this.key}, ${this.version}, ${JSON.stringify(this.data.value)}, {documentType: ${this.documentType}}), {documentState: ${this.documentState}})`}}class qr{constructor(t,e,n,s){this.indexId=t,this.collectionGroup=e,this.fields=n,this.indexState=s}}qr.UNKNOWN_ID=-1;class Br{constructor(t,e){this.fieldPath=t,this.kind=e}}class Kr{constructor(t,e){this.sequenceNumber=t,this.offset=e}static empty(){return new Kr(0,jr.min())}}class jr{constructor(t,e,n){this.readTime=t,this.documentKey=e,this.largestBatchId=n}static min(){return new jr(Js.min(),br.empty(),-1)}}class Gr{constructor(t,e=null,n=[],s=[],r=null,i=null,o=null){this.path=t,this.collectionGroup=e,this.orderBy=n,this.filters=s,this.limit=r,this.startAt=i,this.endAt=o,this.P=null}}function $r(t,e=null,n=[],s=[],r=null,i=null,o=null){return new Gr(t,e,n,s,r,i,o)}function zr(t){const e=Os(t);if(null===e.P){let t=e.path.canonicalString();null!==e.collectionGroup&&(t+="|cg:"+e.collectionGroup),t+="|f:",t+=e.filters.map((t=>{return(e=t).field.canonicalString()+e.op.toString()+Nr(e.value);var e})).join(","),t+="|ob:",t+=e.orderBy.map((t=>function(t){return t.field.canonicalString()+t.dir}(t))).join(","),wr(e.limit)||(t+="|l:",t+=e.limit),e.startAt&&(t+="|lb:",t+=e.startAt.inclusive?"b:":"a:",t+=e.startAt.position.map((t=>Nr(t))).join(",")),e.endAt&&(t+="|ub:",t+=e.endAt.inclusive?"a:":"b:",t+=e.endAt.position.map((t=>Nr(t))).join(",")),e.P=t}return e.P}function Qr(t,e){if(t.limit!==e.limit)return!1;if(t.orderBy.length!==e.orderBy.length)return!1;for(let n=0;n<t.orderBy.length;n++)if(!oi(t.orderBy[n],e.orderBy[n]))return!1;if(t.filters.length!==e.filters.length)return!1;for(let r=0;r<t.filters.length;r++)if(n=t.filters[r],s=e.filters[r],n.op!==s.op||!n.field.isEqual(s.field)||!Sr(n.value,s.value))return!1;var n,s;return t.collectionGroup===e.collectionGroup&&!!t.path.isEqual(e.path)&&!!ci(t.startAt,e.startAt)&&ci(t.endAt,e.endAt)}function Hr(t){return br.isDocumentKey(t.path)&&null===t.collectionGroup&&0===t.filters.length}class Wr extends class{}{constructor(t,e,n){super(),this.field=t,this.op=e,this.value=n}static create(t,e,n){return t.isKeyField()?"in"===e||"not-in"===e?this.v(t,e,n):new Yr(t,e,n):"array-contains"===e?new ti(t,n):"in"===e?new ei(t,n):"not-in"===e?new ni(t,n):"array-contains-any"===e?new si(t,n):new Wr(t,e,n)}static v(t,e,n){return"in"===e?new Xr(t,n):new Jr(t,n)}matches(t){const e=t.data.field(this.field);return"!="===this.op?null!==e&&this.V(Ar(e,this.value)):null!==e&&Er(this.value)===Er(e)&&this.V(Ar(e,this.value))}V(t){switch(this.op){case"<":return t<0;case"<=":return t<=0;case"==":return 0===t;case"!=":return 0!==t;case">":return t>0;case">=":return t>=0;default:return Cs()}}S(){return["<","<=",">",">=","!=","not-in"].indexOf(this.op)>=0}}class Yr extends Wr{constructor(t,e,n){super(t,e,n),this.key=br.fromName(n.referenceValue)}matches(t){const e=br.comparator(t.key,this.key);return this.V(e)}}class Xr extends Wr{constructor(t,e){super(t,"in",e),this.keys=Zr(0,e)}matches(t){return this.keys.some((e=>e.isEqual(t.key)))}}class Jr extends Wr{constructor(t,e){super(t,"not-in",e),this.keys=Zr(0,e)}matches(t){return!this.keys.some((e=>e.isEqual(t.key)))}}function Zr(t,e){var n;return((null===(n=e.arrayValue)||void 0===n?void 0:n.values)||[]).map((t=>br.fromName(t.referenceValue)))}class ti extends Wr{constructor(t,e){super(t,"array-contains",e)}matches(t){const e=t.data.field(this.field);return Or(e)&&xr(e.arrayValue,this.value)}}class ei extends Wr{constructor(t,e){super(t,"in",e)}matches(t){const e=t.data.field(this.field);return null!==e&&xr(this.value.arrayValue,e)}}class ni extends Wr{constructor(t,e){super(t,"not-in",e)}matches(t){if(xr(this.value.arrayValue,{nullValue:"NULL_VALUE"}))return!1;const e=t.data.field(this.field);return null!==e&&!xr(this.value.arrayValue,e)}}class si extends Wr{constructor(t,e){super(t,"array-contains-any",e)}matches(t){const e=t.data.field(this.field);return!(!Or(e)||!e.arrayValue.values)&&e.arrayValue.values.some((t=>xr(this.value.arrayValue,t)))}}class ri{constructor(t,e){this.position=t,this.inclusive=e}}class ii{constructor(t,e="asc"){this.field=t,this.dir=e}}function oi(t,e){return t.dir===e.dir&&t.field.isEqual(e.field)}function ai(t,e,n){let s=0;for(let r=0;r<t.position.length;r++){const i=e[r],o=t.position[r];if(s=i.field.isKeyField()?br.comparator(br.fromName(o.referenceValue),n.key):Ar(o,n.data.field(i.field)),"desc"===i.dir&&(s*=-1),0!==s)break}return s}function ci(t,e){if(null===t)return null===e;if(null===e)return!1;if(t.inclusive!==e.inclusive||t.position.length!==e.position.length)return!1;for(let n=0;n<t.position.length;n++)if(!Sr(t.position[n],e.position[n]))return!1;return!0}class ui{constructor(t,e=null,n=[],s=[],r=null,i="F",o=null,a=null){this.path=t,this.collectionGroup=e,this.explicitOrderBy=n,this.filters=s,this.limit=r,this.limitType=i,this.startAt=o,this.endAt=a,this.D=null,this.C=null,this.startAt,this.endAt}}function hi(t,e,n,s,r,i,o,a){return new ui(t,e,n,s,r,i,o,a)}function li(t){return new ui(t)}function di(t){return!wr(t.limit)&&"F"===t.limitType}function fi(t){return!wr(t.limit)&&"L"===t.limitType}function mi(t){return t.explicitOrderBy.length>0?t.explicitOrderBy[0].field:null}function gi(t){for(const e of t.filters)if(e.S())return e.field;return null}function pi(t){return null!==t.collectionGroup}function yi(t){const e=Os(t);if(null===e.D){e.D=[];const t=gi(e),n=mi(e);if(null!==t&&null===n)t.isKeyField()||e.D.push(new ii(t)),e.D.push(new ii(ir.keyField(),"asc"));else{let t=!1;for(const n of e.explicitOrderBy)e.D.push(n),n.field.isKeyField()&&(t=!0);if(!t){const t=e.explicitOrderBy.length>0?e.explicitOrderBy[e.explicitOrderBy.length-1].dir:"asc";e.D.push(new ii(ir.keyField(),t))}}}return e.D}function wi(t){const e=Os(t);if(!e.C)if("F"===e.limitType)e.C=$r(e.path,e.collectionGroup,yi(e),e.filters,e.limit,e.startAt,e.endAt);else{const t=[];for(const n of yi(e)){const e="desc"===n.dir?"asc":"desc";t.push(new ii(n.field,e))}const n=e.endAt?new ri(e.endAt.position,!e.endAt.inclusive):null,s=e.startAt?new ri(e.startAt.position,!e.startAt.inclusive):null;e.C=$r(e.path,e.collectionGroup,t,e.filters,e.limit,n,s)}return e.C}function vi(t,e,n){return new ui(t.path,t.collectionGroup,t.explicitOrderBy.slice(),t.filters.slice(),e,n,t.startAt,t.endAt)}function Ii(t,e){return Qr(wi(t),wi(e))&&t.limitType===e.limitType}function bi(t){return`${zr(wi(t))}|lt:${t.limitType}`}function Ti(t){return`Query(target=${function(t){let e=t.path.canonicalString();return null!==t.collectionGroup&&(e+=" collectionGroup="+t.collectionGroup),t.filters.length>0&&(e+=`, filters: [${t.filters.map((t=>{return`${(e=t).field.canonicalString()} ${e.op} ${Nr(e.value)}`;var e})).join(", ")}]`),wr(t.limit)||(e+=", limit: "+t.limit),t.orderBy.length>0&&(e+=`, orderBy: [${t.orderBy.map((t=>function(t){return`${t.field.canonicalString()} (${t.dir})`}(t))).join(", ")}]`),t.startAt&&(e+=", startAt: ",e+=t.startAt.inclusive?"b:":"a:",e+=t.startAt.position.map((t=>Nr(t))).join(",")),t.endAt&&(e+=", endAt: ",e+=t.endAt.inclusive?"a:":"b:",e+=t.endAt.position.map((t=>Nr(t))).join(",")),`Target(${e})`}(wi(t))}; limitType=${t.limitType})`}function Ei(t,e){return e.isFoundDocument()&&function(t,e){const n=e.key.path;return null!==t.collectionGroup?e.key.hasCollectionId(t.collectionGroup)&&t.path.isPrefixOf(n):br.isDocumentKey(t.path)?t.path.isEqual(n):t.path.isImmediateParentOf(n)}(t,e)&&function(t,e){for(const n of t.explicitOrderBy)if(!n.field.isKeyField()&&null===e.data.field(n.field))return!1;return!0}(t,e)&&function(t,e){for(const n of t.filters)if(!n.matches(e))return!1;return!0}(t,e)&&function(t,e){return!(t.startAt&&!function(t,e,n){const s=ai(t,e,n);return t.inclusive?s<=0:s<0}(t.startAt,yi(t),e)||t.endAt&&!function(t,e,n){const s=ai(t,e,n);return t.inclusive?s>=0:s>0}(t.endAt,yi(t),e))}(t,e)}function Si(t){return(e,n)=>{let s=!1;for(const r of yi(t)){const t=xi(r,e,n);if(0!==t)return t;s=s||r.field.isKeyField()}return 0}}function xi(t,e,n){const s=t.field.isKeyField()?br.comparator(e.key,n.key):function(t,e,n){const s=e.data.field(t),r=n.data.field(t);return null!==s&&null!==r?Ar(s,r):Cs()}(t.field,e,n);switch(t.dir){case"asc":return s;case"desc":return-1*s;default:return Cs()}}function Ai(t,e){if(t.N){if(isNaN(e))return{doubleValue:"NaN"};if(e===1/0)return{doubleValue:"Infinity"};if(e===-1/0)return{doubleValue:"-Infinity"}}return{doubleValue:vr(e)?"-0":e}}function _i(t){return{integerValue:""+t}}function Ni(t,e){return Ir(e)?_i(e):Ai(t,e)}class Ci{constructor(){this._=void 0}}function Di(t,e,n){return t instanceof Ri?function(t,e){const n={fields:{__type__:{stringValue:"server_timestamp"},__local_write_time__:{timestampValue:{seconds:t.seconds,nanos:t.nanoseconds}}}};return e&&(n.fields.__previous_value__=e),{mapValue:n}}(n,e):t instanceof Li?Mi(t,e):t instanceof Pi?Fi(t,e):function(t,e){const n=Oi(t,e),s=Ui(n)+Ui(t.k);return kr(n)&&kr(t.k)?_i(s):Ai(t.O,s)}(t,e)}function ki(t,e,n){return t instanceof Li?Mi(t,e):t instanceof Pi?Fi(t,e):n}function Oi(t,e){return t instanceof Vi?kr(n=e)||function(t){return!!t&&"doubleValue"in t}(n)?e:{integerValue:0}:null;var n}class Ri extends Ci{}class Li extends Ci{constructor(t){super(),this.elements=t}}function Mi(t,e){const n=qi(e);for(const e of t.elements)n.some((t=>Sr(t,e)))||n.push(e);return{arrayValue:{values:n}}}class Pi extends Ci{constructor(t){super(),this.elements=t}}function Fi(t,e){let n=qi(e);for(const e of t.elements)n=n.filter((t=>!Sr(t,e)));return{arrayValue:{values:n}}}class Vi extends Ci{constructor(t,e){super(),this.O=t,this.k=e}}function Ui(t){return lr(t.integerValue||t.doubleValue)}function qi(t){return Or(t)&&t.arrayValue.values?t.arrayValue.values.slice():[]}class Bi{constructor(t,e){this.field=t,this.transform=e}}class Ki{constructor(t,e){this.version=t,this.transformResults=e}}class ji{constructor(t,e){this.updateTime=t,this.exists=e}static none(){return new ji}static exists(t){return new ji(void 0,t)}static updateTime(t){return new ji(t)}get isNone(){return void 0===this.updateTime&&void 0===this.exists}isEqual(t){return this.exists===t.exists&&(this.updateTime?!!t.updateTime&&this.updateTime.isEqual(t.updateTime):!t.updateTime)}}function Gi(t,e){return void 0!==t.updateTime?e.isFoundDocument()&&e.version.isEqual(t.updateTime):void 0===t.exists||t.exists===e.isFoundDocument()}class $i{}function zi(t,e,n){t instanceof Xi?function(t,e,n){const s=t.value.clone(),r=to(t.fieldTransforms,e,n.transformResults);s.setAll(r),e.convertToFoundDocument(n.version,s).setHasCommittedMutations()}(t,e,n):t instanceof Ji?function(t,e,n){if(!Gi(t.precondition,e))return void e.convertToUnknownDocument(n.version);const s=to(t.fieldTransforms,e,n.transformResults),r=e.data;r.setAll(Zi(t)),r.setAll(s),e.convertToFoundDocument(n.version,r).setHasCommittedMutations()}(t,e,n):function(t,e,n){e.convertToNoDocument(n.version).setHasCommittedMutations()}(0,e,n)}function Qi(t,e,n){t instanceof Xi?function(t,e,n){if(!Gi(t.precondition,e))return;const s=t.value.clone(),r=eo(t.fieldTransforms,n,e);s.setAll(r),e.convertToFoundDocument(Yi(e),s).setHasLocalMutations()}(t,e,n):t instanceof Ji?function(t,e,n){if(!Gi(t.precondition,e))return;const s=eo(t.fieldTransforms,n,e),r=e.data;r.setAll(Zi(t)),r.setAll(s),e.convertToFoundDocument(Yi(e),r).setHasLocalMutations()}(t,e,n):function(t,e){Gi(t.precondition,e)&&e.convertToNoDocument(Js.min())}(t,e)}function Hi(t,e){let n=null;for(const s of t.fieldTransforms){const t=e.data.field(s.field),r=Oi(s.transform,t||null);null!=r&&(null==n&&(n=Fr.empty()),n.set(s.field,r))}return n||null}function Wi(t,e){return t.type===e.type&&!!t.key.isEqual(e.key)&&!!t.precondition.isEqual(e.precondition)&&!!function(t,e){return void 0===t&&void 0===e||!(!t||!e)&&Ws(t,e,((t,e)=>function(t,e){return t.field.isEqual(e.field)&&function(t,e){return t instanceof Li&&e instanceof Li||t instanceof Pi&&e instanceof Pi?Ws(t.elements,e.elements,Sr):t instanceof Vi&&e instanceof Vi?Sr(t.k,e.k):t instanceof Ri&&e instanceof Ri}(t.transform,e.transform)}(t,e)))}(t.fieldTransforms,e.fieldTransforms)&&(0===t.type?t.value.isEqual(e.value):1!==t.type||t.data.isEqual(e.data)&&t.fieldMask.isEqual(e.fieldMask))}function Yi(t){return t.isFoundDocument()?t.version:Js.min()}class Xi extends $i{constructor(t,e,n,s=[]){super(),this.key=t,this.value=e,this.precondition=n,this.fieldTransforms=s,this.type=0}}class Ji extends $i{constructor(t,e,n,s,r=[]){super(),this.key=t,this.data=e,this.fieldMask=n,this.precondition=s,this.fieldTransforms=r,this.type=1}}function Zi(t){const e=new Map;return t.fieldMask.fields.forEach((n=>{if(!n.isEmpty()){const s=t.data.field(n);e.set(n,s)}})),e}function to(t,e,n){const s=new Map;Ds(t.length===n.length);for(let r=0;r<n.length;r++){const i=t[r],o=i.transform,a=e.data.field(i.field);s.set(i.field,ki(o,a,n[r]))}return s}function eo(t,e,n){const s=new Map;for(const r of t){const t=r.transform,i=n.data.field(r.field);s.set(r.field,Di(t,i,e))}return s}class no extends $i{constructor(t,e){super(),this.key=t,this.precondition=e,this.type=2,this.fieldTransforms=[]}}class so extends $i{constructor(t,e){super(),this.key=t,this.precondition=e,this.type=3,this.fieldTransforms=[]}}class ro{constructor(t){this.count=t}}var io,oo;function ao(t){switch(t){default:return Cs();case Rs.CANCELLED:case Rs.UNKNOWN:case Rs.DEADLINE_EXCEEDED:case Rs.RESOURCE_EXHAUSTED:case Rs.INTERNAL:case Rs.UNAVAILABLE:case Rs.UNAUTHENTICATED:return!1;case Rs.INVALID_ARGUMENT:case Rs.NOT_FOUND:case Rs.ALREADY_EXISTS:case Rs.PERMISSION_DENIED:case Rs.FAILED_PRECONDITION:case Rs.ABORTED:case Rs.OUT_OF_RANGE:case Rs.UNIMPLEMENTED:case Rs.DATA_LOSS:return!0}}function co(t){if(void 0===t)return As("GRPC error has no .code"),Rs.UNKNOWN;switch(t){case io.OK:return Rs.OK;case io.CANCELLED:return Rs.CANCELLED;case io.UNKNOWN:return Rs.UNKNOWN;case io.DEADLINE_EXCEEDED:return Rs.DEADLINE_EXCEEDED;case io.RESOURCE_EXHAUSTED:return Rs.RESOURCE_EXHAUSTED;case io.INTERNAL:return Rs.INTERNAL;case io.UNAVAILABLE:return Rs.UNAVAILABLE;case io.UNAUTHENTICATED:return Rs.UNAUTHENTICATED;case io.INVALID_ARGUMENT:return Rs.INVALID_ARGUMENT;case io.NOT_FOUND:return Rs.NOT_FOUND;case io.ALREADY_EXISTS:return Rs.ALREADY_EXISTS;case io.PERMISSION_DENIED:return Rs.PERMISSION_DENIED;case io.FAILED_PRECONDITION:return Rs.FAILED_PRECONDITION;case io.ABORTED:return Rs.ABORTED;case io.OUT_OF_RANGE:return Rs.OUT_OF_RANGE;case io.UNIMPLEMENTED:return Rs.UNIMPLEMENTED;case io.DATA_LOSS:return Rs.DATA_LOSS;default:return Cs()}}(oo=io||(io={}))[oo.OK=0]="OK",oo[oo.CANCELLED=1]="CANCELLED",oo[oo.UNKNOWN=2]="UNKNOWN",oo[oo.INVALID_ARGUMENT=3]="INVALID_ARGUMENT",oo[oo.DEADLINE_EXCEEDED=4]="DEADLINE_EXCEEDED",oo[oo.NOT_FOUND=5]="NOT_FOUND",oo[oo.ALREADY_EXISTS=6]="ALREADY_EXISTS",oo[oo.PERMISSION_DENIED=7]="PERMISSION_DENIED",oo[oo.UNAUTHENTICATED=16]="UNAUTHENTICATED",oo[oo.RESOURCE_EXHAUSTED=8]="RESOURCE_EXHAUSTED",oo[oo.FAILED_PRECONDITION=9]="FAILED_PRECONDITION",oo[oo.ABORTED=10]="ABORTED",oo[oo.OUT_OF_RANGE=11]="OUT_OF_RANGE",oo[oo.UNIMPLEMENTED=12]="UNIMPLEMENTED",oo[oo.INTERNAL=13]="INTERNAL",oo[oo.UNAVAILABLE=14]="UNAVAILABLE",oo[oo.DATA_LOSS=15]="DATA_LOSS";class uo{constructor(t,e){this.comparator=t,this.root=e||lo.EMPTY}insert(t,e){return new uo(this.comparator,this.root.insert(t,e,this.comparator).copy(null,null,lo.BLACK,null,null))}remove(t){return new uo(this.comparator,this.root.remove(t,this.comparator).copy(null,null,lo.BLACK,null,null))}get(t){let e=this.root;for(;!e.isEmpty();){const n=this.comparator(t,e.key);if(0===n)return e.value;n<0?e=e.left:n>0&&(e=e.right)}return null}indexOf(t){let e=0,n=this.root;for(;!n.isEmpty();){const s=this.comparator(t,n.key);if(0===s)return e+n.left.size;s<0?n=n.left:(e+=n.left.size+1,n=n.right)}return-1}isEmpty(){return this.root.isEmpty()}get size(){return this.root.size}minKey(){return this.root.minKey()}maxKey(){return this.root.maxKey()}inorderTraversal(t){return this.root.inorderTraversal(t)}forEach(t){this.inorderTraversal(((e,n)=>(t(e,n),!1)))}toString(){const t=[];return this.inorderTraversal(((e,n)=>(t.push(`${e}:${n}`),!1))),`{${t.join(", ")}}`}reverseTraversal(t){return this.root.reverseTraversal(t)}getIterator(){return new ho(this.root,null,this.comparator,!1)}getIteratorFrom(t){return new ho(this.root,t,this.comparator,!1)}getReverseIterator(){return new ho(this.root,null,this.comparator,!0)}getReverseIteratorFrom(t){return new ho(this.root,t,this.comparator,!0)}}class ho{constructor(t,e,n,s){this.isReverse=s,this.nodeStack=[];let r=1;for(;!t.isEmpty();)if(r=e?n(t.key,e):1,s&&(r*=-1),r<0)t=this.isReverse?t.left:t.right;else{if(0===r){this.nodeStack.push(t);break}this.nodeStack.push(t),t=this.isReverse?t.right:t.left}}getNext(){let t=this.nodeStack.pop();const e={key:t.key,value:t.value};if(this.isReverse)for(t=t.left;!t.isEmpty();)this.nodeStack.push(t),t=t.right;else for(t=t.right;!t.isEmpty();)this.nodeStack.push(t),t=t.left;return e}hasNext(){return this.nodeStack.length>0}peek(){if(0===this.nodeStack.length)return null;const t=this.nodeStack[this.nodeStack.length-1];return{key:t.key,value:t.value}}}class lo{constructor(t,e,n,s,r){this.key=t,this.value=e,this.color=null!=n?n:lo.RED,this.left=null!=s?s:lo.EMPTY,this.right=null!=r?r:lo.EMPTY,this.size=this.left.size+1+this.right.size}copy(t,e,n,s,r){return new lo(null!=t?t:this.key,null!=e?e:this.value,null!=n?n:this.color,null!=s?s:this.left,null!=r?r:this.right)}isEmpty(){return!1}inorderTraversal(t){return this.left.inorderTraversal(t)||t(this.key,this.value)||this.right.inorderTraversal(t)}reverseTraversal(t){return this.right.reverseTraversal(t)||t(this.key,this.value)||this.left.reverseTraversal(t)}min(){return this.left.isEmpty()?this:this.left.min()}minKey(){return this.min().key}maxKey(){return this.right.isEmpty()?this.key:this.right.maxKey()}insert(t,e,n){let s=this;const r=n(t,s.key);return s=r<0?s.copy(null,null,null,s.left.insert(t,e,n),null):0===r?s.copy(null,e,null,null,null):s.copy(null,null,null,null,s.right.insert(t,e,n)),s.fixUp()}removeMin(){if(this.left.isEmpty())return lo.EMPTY;let t=this;return t.left.isRed()||t.left.left.isRed()||(t=t.moveRedLeft()),t=t.copy(null,null,null,t.left.removeMin(),null),t.fixUp()}remove(t,e){let n,s=this;if(e(t,s.key)<0)s.left.isEmpty()||s.left.isRed()||s.left.left.isRed()||(s=s.moveRedLeft()),s=s.copy(null,null,null,s.left.remove(t,e),null);else{if(s.left.isRed()&&(s=s.rotateRight()),s.right.isEmpty()||s.right.isRed()||s.right.left.isRed()||(s=s.moveRedRight()),0===e(t,s.key)){if(s.right.isEmpty())return lo.EMPTY;n=s.right.min(),s=s.copy(n.key,n.value,null,null,s.right.removeMin())}s=s.copy(null,null,null,null,s.right.remove(t,e))}return s.fixUp()}isRed(){return this.color}fixUp(){let t=this;return t.right.isRed()&&!t.left.isRed()&&(t=t.rotateLeft()),t.left.isRed()&&t.left.left.isRed()&&(t=t.rotateRight()),t.left.isRed()&&t.right.isRed()&&(t=t.colorFlip()),t}moveRedLeft(){let t=this.colorFlip();return t.right.left.isRed()&&(t=t.copy(null,null,null,null,t.right.rotateRight()),t=t.rotateLeft(),t=t.colorFlip()),t}moveRedRight(){let t=this.colorFlip();return t.left.left.isRed()&&(t=t.rotateRight(),t=t.colorFlip()),t}rotateLeft(){const t=this.copy(null,null,lo.RED,null,this.right.left);return this.right.copy(null,null,this.color,t,null)}rotateRight(){const t=this.copy(null,null,lo.RED,this.left.right,null);return this.left.copy(null,null,this.color,null,t)}colorFlip(){const t=this.left.copy(null,null,!this.left.color,null,null),e=this.right.copy(null,null,!this.right.color,null,null);return this.copy(null,null,!this.color,t,e)}checkMaxDepth(){const t=this.check();return Math.pow(2,t)<=this.size+1}check(){if(this.isRed()&&this.left.isRed())throw Cs();if(this.right.isRed())throw Cs();const t=this.left.check();if(t!==this.right.check())throw Cs();return t+(this.isRed()?0:1)}}lo.EMPTY=null,lo.RED=!0,lo.BLACK=!1,lo.EMPTY=new class{constructor(){this.size=0}get key(){throw Cs()}get value(){throw Cs()}get color(){throw Cs()}get left(){throw Cs()}get right(){throw Cs()}copy(t,e,n,s,r){return this}insert(t,e,n){return new lo(t,e)}remove(t,e){return this}isEmpty(){return!0}inorderTraversal(t){return!1}reverseTraversal(t){return!1}minKey(){return null}maxKey(){return null}isRed(){return!1}checkMaxDepth(){return!0}check(){return 0}};class fo{constructor(t){this.comparator=t,this.data=new uo(this.comparator)}has(t){return null!==this.data.get(t)}first(){return this.data.minKey()}last(){return this.data.maxKey()}get size(){return this.data.size}indexOf(t){return this.data.indexOf(t)}forEach(t){this.data.inorderTraversal(((e,n)=>(t(e),!1)))}forEachInRange(t,e){const n=this.data.getIteratorFrom(t[0]);for(;n.hasNext();){const s=n.getNext();if(this.comparator(s.key,t[1])>=0)return;e(s.key)}}forEachWhile(t,e){let n;for(n=void 0!==e?this.data.getIteratorFrom(e):this.data.getIterator();n.hasNext();)if(!t(n.getNext().key))return}firstAfterOrEqual(t){const e=this.data.getIteratorFrom(t);return e.hasNext()?e.getNext().key:null}getIterator(){return new mo(this.data.getIterator())}getIteratorFrom(t){return new mo(this.data.getIteratorFrom(t))}add(t){return this.copy(this.data.remove(t).insert(t,!0))}delete(t){return this.has(t)?this.copy(this.data.remove(t)):this}isEmpty(){return this.data.isEmpty()}unionWith(t){let e=this;return e.size<t.size&&(e=t,t=this),t.forEach((t=>{e=e.add(t)})),e}isEqual(t){if(!(t instanceof fo))return!1;if(this.size!==t.size)return!1;const e=this.data.getIterator(),n=t.data.getIterator();for(;e.hasNext();){const t=e.getNext().key,s=n.getNext().key;if(0!==this.comparator(t,s))return!1}return!0}toArray(){const t=[];return this.forEach((e=>{t.push(e)})),t}toString(){const t=[];return this.forEach((e=>t.push(e))),"SortedSet("+t.toString()+")"}copy(t){const e=new fo(this.comparator);return e.data=t,e}}class mo{constructor(t){this.iter=t}getNext(){return this.iter.getNext().key}hasNext(){return this.iter.hasNext()}}function go(t){return t.hasNext()?t.getNext():void 0}const po=new uo(br.comparator);function yo(){return po}const wo=new uo(br.comparator);function vo(){return wo}const Io=new uo(br.comparator),bo=new fo(br.comparator);function To(...t){let e=bo;for(const n of t)e=e.add(n);return e}const Eo=new fo(Hs);function So(){return Eo}class xo{constructor(t,e,n,s,r){this.snapshotVersion=t,this.targetChanges=e,this.targetMismatches=n,this.documentUpdates=s,this.resolvedLimboDocuments=r}static createSynthesizedRemoteEventForCurrentChange(t,e){const n=new Map;return n.set(t,Ao.createSynthesizedTargetChangeForCurrentChange(t,e)),new xo(Js.min(),n,So(),yo(),To())}}class Ao{constructor(t,e,n,s,r){this.resumeToken=t,this.current=e,this.addedDocuments=n,this.modifiedDocuments=s,this.removedDocuments=r}static createSynthesizedTargetChangeForCurrentChange(t,e){return new Ao(cr.EMPTY_BYTE_STRING,e,To(),To(),To())}}class _o{constructor(t,e,n,s){this.M=t,this.removedTargetIds=e,this.key=n,this.$=s}}class No{constructor(t,e){this.targetId=t,this.F=e}}class Co{constructor(t,e,n=cr.EMPTY_BYTE_STRING,s=null){this.state=t,this.targetIds=e,this.resumeToken=n,this.cause=s}}class Do{constructor(){this.B=0,this.L=Ro(),this.U=cr.EMPTY_BYTE_STRING,this.q=!1,this.K=!0}get current(){return this.q}get resumeToken(){return this.U}get G(){return 0!==this.B}get j(){return this.K}W(t){t.approximateByteSize()>0&&(this.K=!0,this.U=t)}H(){let t=To(),e=To(),n=To();return this.L.forEach(((s,r)=>{switch(r){case 0:t=t.add(s);break;case 2:e=e.add(s);break;case 1:n=n.add(s);break;default:Cs()}})),new Ao(this.U,this.q,t,e,n)}J(){this.K=!1,this.L=Ro()}Y(t,e){this.K=!0,this.L=this.L.insert(t,e)}X(t){this.K=!0,this.L=this.L.remove(t)}Z(){this.B+=1}tt(){this.B-=1}et(){this.K=!0,this.q=!0}}class ko{constructor(t){this.nt=t,this.st=new Map,this.it=yo(),this.rt=Oo(),this.ot=new fo(Hs)}ct(t){for(const e of t.M)t.$&&t.$.isFoundDocument()?this.ut(e,t.$):this.at(e,t.key,t.$);for(const e of t.removedTargetIds)this.at(e,t.key,t.$)}ht(t){this.forEachTarget(t,(e=>{const n=this.lt(e);switch(t.state){case 0:this.ft(e)&&n.W(t.resumeToken);break;case 1:n.tt(),n.G||n.J(),n.W(t.resumeToken);break;case 2:n.tt(),n.G||this.removeTarget(e);break;case 3:this.ft(e)&&(n.et(),n.W(t.resumeToken));break;case 4:this.ft(e)&&(this.dt(e),n.W(t.resumeToken));break;default:Cs()}}))}forEachTarget(t,e){t.targetIds.length>0?t.targetIds.forEach(e):this.st.forEach(((t,n)=>{this.ft(n)&&e(n)}))}_t(t){const e=t.targetId,n=t.F.count,s=this.wt(e);if(s){const t=s.target;if(Hr(t))if(0===n){const n=new br(t.path);this.at(e,n,Ur.newNoDocument(n,Js.min()))}else Ds(1===n);else this.gt(e)!==n&&(this.dt(e),this.ot=this.ot.add(e))}}yt(t){const e=new Map;this.st.forEach(((n,s)=>{const r=this.wt(s);if(r){if(n.current&&Hr(r.target)){const e=new br(r.target.path);null!==this.it.get(e)||this.It(s,e)||this.at(s,e,Ur.newNoDocument(e,t))}n.j&&(e.set(s,n.H()),n.J())}}));let n=To();this.rt.forEach(((t,e)=>{let s=!0;e.forEachWhile((t=>{const e=this.wt(t);return!e||2===e.purpose||(s=!1,!1)})),s&&(n=n.add(t))})),this.it.forEach(((e,n)=>n.setReadTime(t)));const s=new xo(t,e,this.ot,this.it,n);return this.it=yo(),this.rt=Oo(),this.ot=new fo(Hs),s}ut(t,e){if(!this.ft(t))return;const n=this.It(t,e.key)?2:0;this.lt(t).Y(e.key,n),this.it=this.it.insert(e.key,e),this.rt=this.rt.insert(e.key,this.Et(e.key).add(t))}at(t,e,n){if(!this.ft(t))return;const s=this.lt(t);this.It(t,e)?s.Y(e,1):s.X(e),this.rt=this.rt.insert(e,this.Et(e).delete(t)),n&&(this.it=this.it.insert(e,n))}removeTarget(t){this.st.delete(t)}gt(t){const e=this.lt(t).H();return this.nt.getRemoteKeysForTarget(t).size+e.addedDocuments.size-e.removedDocuments.size}Z(t){this.lt(t).Z()}lt(t){let e=this.st.get(t);return e||(e=new Do,this.st.set(t,e)),e}Et(t){let e=this.rt.get(t);return e||(e=new fo(Hs),this.rt=this.rt.insert(t,e)),e}ft(t){const e=null!==this.wt(t);return e||xs("WatchChangeAggregator","Detected inactive target",t),e}wt(t){const e=this.st.get(t);return e&&e.G?null:this.nt.Tt(t)}dt(t){this.st.set(t,new Do),this.nt.getRemoteKeysForTarget(t).forEach((e=>{this.at(t,e,null)}))}It(t,e){return this.nt.getRemoteKeysForTarget(t).has(e)}}function Oo(){return new uo(br.comparator)}function Ro(){return new uo(br.comparator)}const Lo={asc:"ASCENDING",desc:"DESCENDING"},Mo={"<":"LESS_THAN","<=":"LESS_THAN_OR_EQUAL",">":"GREATER_THAN",">=":"GREATER_THAN_OR_EQUAL","==":"EQUAL","!=":"NOT_EQUAL","array-contains":"ARRAY_CONTAINS",in:"IN","not-in":"NOT_IN","array-contains-any":"ARRAY_CONTAINS_ANY"};class Po{constructor(t,e){this.databaseId=t,this.N=e}}function Fo(t,e){return t.N?`${new Date(1e3*e.seconds).toISOString().replace(/\.\d*/,"").replace("Z","")}.${("000000000"+e.nanoseconds).slice(-9)}Z`:{seconds:""+e.seconds,nanos:e.nanoseconds}}function Vo(t,e){return t.N?e.toBase64():e.toUint8Array()}function Uo(t,e){return Fo(t,e.toTimestamp())}function qo(t){return Ds(!!t),Js.fromTimestamp(function(t){const e=hr(t);return new Xs(e.seconds,e.nanos)}(t))}function Bo(t,e){return function(t){return new sr(["projects",t.projectId,"databases",t.database])}(t).child("documents").child(e).canonicalString()}function Ko(t){const e=sr.fromString(t);return Ds(ha(e)),e}function jo(t,e){return Bo(t.databaseId,e.path)}function Go(t,e){const n=Ko(e);if(n.get(1)!==t.databaseId.projectId)throw new Ls(Rs.INVALID_ARGUMENT,"Tried to deserialize key from different project: "+n.get(1)+" vs "+t.databaseId.projectId);if(n.get(3)!==t.databaseId.database)throw new Ls(Rs.INVALID_ARGUMENT,"Tried to deserialize key from different database: "+n.get(3)+" vs "+t.databaseId.database);return new br(Ho(n))}function $o(t,e){return Bo(t.databaseId,e)}function zo(t){const e=Ko(t);return 4===e.length?sr.emptyPath():Ho(e)}function Qo(t){return new sr(["projects",t.databaseId.projectId,"databases",t.databaseId.database]).canonicalString()}function Ho(t){return Ds(t.length>4&&"documents"===t.get(4)),t.popFirst(5)}function Wo(t,e,n){return{name:jo(t,e),fields:n.value.mapValue.fields}}function Yo(t,e,n){const s=Go(t,e.name),r=qo(e.updateTime),i=new Fr({mapValue:{fields:e.fields}}),o=Ur.newFoundDocument(s,r,i);return n&&o.setHasCommittedMutations(),n?o.setHasCommittedMutations():o}function Xo(t,e){let n;if(e instanceof Xi)n={update:Wo(t,e.key,e.value)};else if(e instanceof no)n={delete:jo(t,e.key)};else if(e instanceof Ji)n={update:Wo(t,e.key,e.data),updateMask:ua(e.fieldMask)};else{if(!(e instanceof so))return Cs();n={verify:jo(t,e.key)}}return e.fieldTransforms.length>0&&(n.updateTransforms=e.fieldTransforms.map((t=>function(t,e){const n=e.transform;if(n instanceof Ri)return{fieldPath:e.field.canonicalString(),setToServerValue:"REQUEST_TIME"};if(n instanceof Li)return{fieldPath:e.field.canonicalString(),appendMissingElements:{values:n.elements}};if(n instanceof Pi)return{fieldPath:e.field.canonicalString(),removeAllFromArray:{values:n.elements}};if(n instanceof Vi)return{fieldPath:e.field.canonicalString(),increment:n.k};throw Cs()}(0,t)))),e.precondition.isNone||(n.currentDocument=function(t,e){return void 0!==e.updateTime?{updateTime:Uo(t,e.updateTime)}:void 0!==e.exists?{exists:e.exists}:Cs()}(t,e.precondition)),n}function Jo(t,e){const n=e.currentDocument?function(t){return void 0!==t.updateTime?ji.updateTime(qo(t.updateTime)):void 0!==t.exists?ji.exists(t.exists):ji.none()}(e.currentDocument):ji.none(),s=e.updateTransforms?e.updateTransforms.map((e=>function(t,e){let n=null;if("setToServerValue"in e)Ds("REQUEST_TIME"===e.setToServerValue),n=new Ri;else if("appendMissingElements"in e){const t=e.appendMissingElements.values||[];n=new Li(t)}else if("removeAllFromArray"in e){const t=e.removeAllFromArray.values||[];n=new Pi(t)}else"increment"in e?n=new Vi(t,e.increment):Cs();const s=ir.fromServerFormat(e.fieldPath);return new Bi(s,n)}(t,e))):[];if(e.update){e.update.name;const r=Go(t,e.update.name),i=new Fr({mapValue:{fields:e.update.fields}});if(e.updateMask){const t=function(t){const e=t.fieldPaths||[];return new or(e.map((t=>ir.fromServerFormat(t))))}(e.updateMask);return new Ji(r,i,t,n,s)}return new Xi(r,i,n,s)}if(e.delete){const s=Go(t,e.delete);return new no(s,n)}if(e.verify){const s=Go(t,e.verify);return new so(s,n)}return Cs()}function Zo(t,e){return{documents:[$o(t,e.path)]}}function ta(t,e){const n={structuredQuery:{}},s=e.path;null!==e.collectionGroup?(n.parent=$o(t,s),n.structuredQuery.from=[{collectionId:e.collectionGroup,allDescendants:!0}]):(n.parent=$o(t,s.popLast()),n.structuredQuery.from=[{collectionId:s.lastSegment()}]);const r=function(t){if(0===t.length)return;const e=t.map((t=>function(t){if("=="===t.op){if(Lr(t.value))return{unaryFilter:{field:ia(t.field),op:"IS_NAN"}};if(Rr(t.value))return{unaryFilter:{field:ia(t.field),op:"IS_NULL"}}}else if("!="===t.op){if(Lr(t.value))return{unaryFilter:{field:ia(t.field),op:"IS_NOT_NAN"}};if(Rr(t.value))return{unaryFilter:{field:ia(t.field),op:"IS_NOT_NULL"}}}return{fieldFilter:{field:ia(t.field),op:ra(t.op),value:t.value}}}(t)));return 1===e.length?e[0]:{compositeFilter:{op:"AND",filters:e}}}(e.filters);r&&(n.structuredQuery.where=r);const i=function(t){if(0!==t.length)return t.map((t=>function(t){return{field:ia(t.field),direction:sa(t.dir)}}(t)))}(e.orderBy);i&&(n.structuredQuery.orderBy=i);const o=function(t,e){return t.N||wr(e)?e:{value:e}}(t,e.limit);var a;return null!==o&&(n.structuredQuery.limit=o),e.startAt&&(n.structuredQuery.startAt={before:(a=e.startAt).inclusive,values:a.position}),e.endAt&&(n.structuredQuery.endAt=function(t){return{before:!t.inclusive,values:t.position}}(e.endAt)),n}function ea(t){let e=zo(t.parent);const n=t.structuredQuery,s=n.from?n.from.length:0;let r=null;if(s>0){Ds(1===s);const t=n.from[0];t.allDescendants?r=t.collectionId:e=e.child(t.collectionId)}let i=[];n.where&&(i=na(n.where));let o=[];n.orderBy&&(o=n.orderBy.map((t=>function(t){return new ii(oa(t.field),function(t){switch(t){case"ASCENDING":return"asc";case"DESCENDING":return"desc";default:return}}(t.direction))}(t))));let a=null;n.limit&&(a=function(t){let e;return e="object"==typeof t?t.value:t,wr(e)?null:e}(n.limit));let c=null;n.startAt&&(c=function(t){const e=!!t.before,n=t.values||[];return new ri(n,e)}(n.startAt));let u=null;return n.endAt&&(u=function(t){const e=!t.before,n=t.values||[];return new ri(n,e)}(n.endAt)),hi(e,r,o,i,a,"F",c,u)}function na(t){return t?void 0!==t.unaryFilter?[ca(t)]:void 0!==t.fieldFilter?[aa(t)]:void 0!==t.compositeFilter?t.compositeFilter.filters.map((t=>na(t))).reduce(((t,e)=>t.concat(e))):Cs():[]}function sa(t){return Lo[t]}function ra(t){return Mo[t]}function ia(t){return{fieldPath:t.canonicalString()}}function oa(t){return ir.fromServerFormat(t.fieldPath)}function aa(t){return Wr.create(oa(t.fieldFilter.field),function(t){switch(t){case"EQUAL":return"==";case"NOT_EQUAL":return"!=";case"GREATER_THAN":return">";case"GREATER_THAN_OR_EQUAL":return">=";case"LESS_THAN":return"<";case"LESS_THAN_OR_EQUAL":return"<=";case"ARRAY_CONTAINS":return"array-contains";case"IN":return"in";case"NOT_IN":return"not-in";case"ARRAY_CONTAINS_ANY":return"array-contains-any";default:return Cs()}}(t.fieldFilter.op),t.fieldFilter.value)}function ca(t){switch(t.unaryFilter.op){case"IS_NAN":const e=oa(t.unaryFilter.field);return Wr.create(e,"==",{doubleValue:NaN});case"IS_NULL":const n=oa(t.unaryFilter.field);return Wr.create(n,"==",{nullValue:"NULL_VALUE"});case"IS_NOT_NAN":const s=oa(t.unaryFilter.field);return Wr.create(s,"!=",{doubleValue:NaN});case"IS_NOT_NULL":const r=oa(t.unaryFilter.field);return Wr.create(r,"!=",{nullValue:"NULL_VALUE"});default:return Cs()}}function ua(t){const e=[];return t.fields.forEach((t=>e.push(t.canonicalString()))),{fieldPaths:e}}function ha(t){return t.length>=4&&"projects"===t.get(0)&&"databases"===t.get(2)}function la(t){let e="";for(let n=0;n<t.length;n++)e.length>0&&(e=fa(e)),e=da(t.get(n),e);return fa(e)}function da(t,e){let n=e;const s=t.length;for(let e=0;e<s;e++){const s=t.charAt(e);switch(s){case"\0":n+="";break;case"":n+="";break;default:n+=s}}return n}function fa(t){return t+""}function ma(t){const e=t.length;if(Ds(e>=2),2===e)return Ds(""===t.charAt(0)&&""===t.charAt(1)),sr.emptyPath();const n=e-2,s=[];let r="";for(let i=0;i<e;){const e=t.indexOf("",i);switch((e<0||e>n)&&Cs(),t.charAt(e+1)){case"":const n=t.substring(i,e);let o;0===r.length?o=n:(r+=n,o=r,r=""),s.push(o);break;case"":r+=t.substring(i,e),r+="\0";break;case"":r+=t.substring(i,e+1);break;default:Cs()}i=e+2}return new sr(s)}class ga{constructor(t,e){this.seconds=t,this.nanoseconds=e}}class pa{constructor(t,e,n){this.ownerId=t,this.allowTabSynchronization=e,this.leaseTimestampMs=n}}pa.store="owner",pa.key="owner";class ya{constructor(t,e,n){this.userId=t,this.lastAcknowledgedBatchId=e,this.lastStreamToken=n}}ya.store="mutationQueues",ya.keyPath="userId";class wa{constructor(t,e,n,s,r){this.userId=t,this.batchId=e,this.localWriteTimeMs=n,this.baseMutations=s,this.mutations=r}}wa.store="mutations",wa.keyPath="batchId",wa.userMutationsIndex="userMutationsIndex",wa.userMutationsKeyPath=["userId","batchId"];class va{constructor(){}static prefixForUser(t){return[t]}static prefixForPath(t,e){return[t,la(e)]}static key(t,e,n){return[t,la(e),n]}}va.store="documentMutations",va.PLACEHOLDER=new va;class Ia{constructor(t,e){this.path=t,this.readTime=e}}class ba{constructor(t,e){this.path=t,this.version=e}}class Ta{constructor(t,e,n,s,r,i){this.unknownDocument=t,this.noDocument=e,this.document=n,this.hasCommittedMutations=s,this.readTime=r,this.parentPath=i}}Ta.store="remoteDocuments",Ta.readTimeIndex="readTimeIndex",Ta.readTimeIndexPath="readTime",Ta.collectionReadTimeIndex="collectionReadTimeIndex",Ta.collectionReadTimeIndexPath=["parentPath","readTime"];class Ea{constructor(t){this.byteSize=t}}Ea.store="remoteDocumentGlobal",Ea.key="remoteDocumentGlobalKey";class Sa{constructor(t,e,n,s,r,i,o){this.targetId=t,this.canonicalId=e,this.readTime=n,this.resumeToken=s,this.lastListenSequenceNumber=r,this.lastLimboFreeSnapshotVersion=i,this.query=o}}Sa.store="targets",Sa.keyPath="targetId",Sa.queryTargetsIndexName="queryTargetsIndex",Sa.queryTargetsKeyPath=["canonicalId","targetId"];class xa{constructor(t,e,n){this.targetId=t,this.path=e,this.sequenceNumber=n}}xa.store="targetDocuments",xa.keyPath=["targetId","path"],xa.documentTargetsIndex="documentTargetsIndex",xa.documentTargetsKeyPath=["path","targetId"];class Aa{constructor(t,e,n,s){this.highestTargetId=t,this.highestListenSequenceNumber=e,this.lastRemoteSnapshotVersion=n,this.targetCount=s}}Aa.key="targetGlobalKey",Aa.store="targetGlobal";class _a{constructor(t,e){this.collectionId=t,this.parent=e}}_a.store="collectionParents",_a.keyPath=["collectionId","parent"];class Na{constructor(t,e,n,s){this.clientId=t,this.updateTimeMs=e,this.networkEnabled=n,this.inForeground=s}}Na.store="clientMetadata",Na.keyPath="clientId";class Ca{constructor(t,e,n){this.bundleId=t,this.createTime=e,this.version=n}}Ca.store="bundles",Ca.keyPath="bundleId";class Da{constructor(t,e,n){this.name=t,this.readTime=e,this.bundledQuery=n}}Da.store="namedQueries",Da.keyPath="name";class ka{constructor(t,e,n){this.indexId=t,this.collectionGroup=e,this.fields=n}}ka.store="indexConfiguration",ka.keyPath="indexId",ka.collectionGroupIndex="collectionGroupIndex",ka.collectionGroupIndexPath="collectionGroup";class Oa{constructor(t,e,n,s,r,i){this.indexId=t,this.uid=e,this.sequenceNumber=n,this.readTime=s,this.documentKey=r,this.largestBatchId=i}}Oa.store="indexState",Oa.keyPath=["indexId","uid"],Oa.sequenceNumberIndex="sequenceNumberIndex",Oa.sequenceNumberIndexPath=["uid","sequenceNumber"];class Ra{constructor(t,e,n,s,r){this.indexId=t,this.uid=e,this.arrayValue=n,this.directionalValue=s,this.documentKey=r}}Ra.store="indexEntries",Ra.keyPath=["indexId","uid","arrayValue","directionalValue","documentKey"],Ra.documentKeyIndex="documentKeyIndex",Ra.documentKeyIndexPath=["indexId","uid","documentKey"];class La{constructor(t,e,n,s,r,i){this.userId=t,this.collectionPath=e,this.documentId=n,this.collectionGroup=s,this.largestBatchId=r,this.overlayMutation=i}}La.store="documentOverlays",La.keyPath=["userId","collectionPath","documentId"],La.collectionPathOverlayIndex="collectionPathOverlayIndex",La.collectionPathOverlayIndexPath=["userId","collectionPath","largestBatchId"],La.collectionGroupOverlayIndex="collectionGroupOverlayIndex",La.collectionGroupOverlayIndexPath=["userId","collectionGroup","largestBatchId"];const Ma=[ya.store,wa.store,va.store,Ta.store,Sa.store,pa.store,Aa.store,xa.store,Na.store,Ea.store,_a.store,Ca.store,Da.store],Pa=[...Ma,La.store],Fa=[...Pa,ka.store,Oa.store,Ra.store],Va="The current tab is not in the required state to perform this operation. It might be necessary to refresh the browser tab.";class Ua{constructor(){this.onCommittedListeners=[]}addOnCommittedListener(t){this.onCommittedListeners.push(t)}raiseOnCommittedEvent(){this.onCommittedListeners.forEach((t=>t()))}}class qa{constructor(t){this.nextCallback=null,this.catchCallback=null,this.result=void 0,this.error=void 0,this.isDone=!1,this.callbackAttached=!1,t((t=>{this.isDone=!0,this.result=t,this.nextCallback&&this.nextCallback(t)}),(t=>{this.isDone=!0,this.error=t,this.catchCallback&&this.catchCallback(t)}))}catch(t){return this.next(void 0,t)}next(t,e){return this.callbackAttached&&Cs(),this.callbackAttached=!0,this.isDone?this.error?this.wrapFailure(e,this.error):this.wrapSuccess(t,this.result):new qa(((n,s)=>{this.nextCallback=e=>{this.wrapSuccess(t,e).next(n,s)},this.catchCallback=t=>{this.wrapFailure(e,t).next(n,s)}}))}toPromise(){return new Promise(((t,e)=>{this.next(t,e)}))}wrapUserFunction(t){try{const e=t();return e instanceof qa?e:qa.resolve(e)}catch(t){return qa.reject(t)}}wrapSuccess(t,e){return t?this.wrapUserFunction((()=>t(e))):qa.resolve(e)}wrapFailure(t,e){return t?this.wrapUserFunction((()=>t(e))):qa.reject(e)}static resolve(t){return new qa(((e,n)=>{e(t)}))}static reject(t){return new qa(((e,n)=>{n(t)}))}static waitFor(t){return new qa(((e,n)=>{let s=0,r=0,i=!1;t.forEach((t=>{++s,t.next((()=>{++r,i&&r===s&&e()}),(t=>n(t)))})),i=!0,r===s&&e()}))}static or(t){let e=qa.resolve(!1);for(const n of t)e=e.next((t=>t?qa.resolve(t):n()));return e}static forEach(t,e){const n=[];return t.forEach(((t,s)=>{n.push(e.call(this,t,s))})),this.waitFor(n)}}class Ba{constructor(t,e){this.action=t,this.transaction=e,this.aborted=!1,this.At=new Ms,this.transaction.oncomplete=()=>{this.At.resolve()},this.transaction.onabort=()=>{e.error?this.At.reject(new Ga(t,e.error)):this.At.resolve()},this.transaction.onerror=e=>{const n=Wa(e.target.error);this.At.reject(new Ga(t,n))}}static open(t,e,n,s){try{return new Ba(e,t.transaction(s,n))}catch(t){throw new Ga(e,t)}}get Rt(){return this.At.promise}abort(t){t&&this.At.reject(t),this.aborted||(xs("SimpleDb","Aborting transaction:",t?t.message:"Client-initiated abort"),this.aborted=!0,this.transaction.abort())}Pt(){const t=this.transaction;this.aborted||"function"!=typeof t.commit||t.commit()}store(t){const e=this.transaction.objectStore(t);return new za(e)}}class Ka{constructor(t,e,n){this.name=t,this.version=e,this.bt=n,12.2===Ka.vt((0,a.z$)())&&As("Firestore persistence suffers from a bug in iOS 12.2 Safari that may cause your app to stop working. See https://stackoverflow.com/q/56496296/110915 for details and a potential workaround.")}static delete(t){return xs("SimpleDb","Removing database:",t),Qa(window.indexedDB.deleteDatabase(t)).toPromise()}static Vt(){if(!(0,a.hl)())return!1;if(Ka.St())return!0;const t=(0,a.z$)(),e=Ka.vt(t),n=0<e&&e<10,s=Ka.Dt(t),r=0<s&&s<4.5;return!(t.indexOf("MSIE ")>0||t.indexOf("Trident/")>0||t.indexOf("Edge/")>0||n||r)}static St(){var t;return void 0!==ws&&"YES"===(null===(t=ws.env)||void 0===t?void 0:t.Ct)}static Nt(t,e){return t.store(e)}static vt(t){const e=t.match(/i(?:phone|pad|pod) os ([\d_]+)/i),n=e?e[1].split("_").slice(0,2).join("."):"-1";return Number(n)}static Dt(t){const e=t.match(/Android ([\d.]+)/i),n=e?e[1].split(".").slice(0,2).join("."):"-1";return Number(n)}async xt(t){return this.db||(xs("SimpleDb","Opening database:",this.name),this.db=await new Promise(((e,n)=>{const s=indexedDB.open(this.name,this.version);s.onsuccess=t=>{const n=t.target.result;e(n)},s.onblocked=()=>{n(new Ga(t,"Cannot upgrade IndexedDB schema while another tab is open. Close all tabs that access Firestore and reload this page to proceed."))},s.onerror=e=>{const s=e.target.error;"VersionError"===s.name?n(new Ls(Rs.FAILED_PRECONDITION,"A newer version of the Firestore SDK was previously used and so the persisted data is not compatible with the version of the SDK you are now using. The SDK will operate with persistence disabled. If you need persistence, please re-upgrade to a newer version of the SDK or else clear the persisted IndexedDB data for your app to start fresh.")):"InvalidStateError"===s.name?n(new Ls(Rs.FAILED_PRECONDITION,"Unable to open an IndexedDB connection. This could be due to running in a private browsing session on a browser whose private browsing sessions do not support IndexedDB: "+s)):n(new Ga(t,s))},s.onupgradeneeded=t=>{xs("SimpleDb",'Database "'+this.name+'" requires upgrade from version:',t.oldVersion);const e=t.target.result;this.bt.kt(e,s.transaction,t.oldVersion,this.version).next((()=>{xs("SimpleDb","Database upgrade to version "+this.version+" complete")}))}}))),this.Ot&&(this.db.onversionchange=t=>this.Ot(t)),this.db}Mt(t){this.Ot=t,this.db&&(this.db.onversionchange=e=>t(e))}async runTransaction(t,e,n,s){const r="readonly"===e;let i=0;for(;;){++i;try{this.db=await this.xt(t);const e=Ba.open(this.db,t,r?"readonly":"readwrite",n),i=s(e).next((t=>(e.Pt(),t))).catch((t=>(e.abort(t),qa.reject(t)))).toPromise();return i.catch((()=>{})),await e.Rt,i}catch(t){const e="FirebaseError"!==t.name&&i<3;if(xs("SimpleDb","Transaction failed with error:",t.message,"Retrying:",e),this.close(),!e)return Promise.reject(t)}}}close(){this.db&&this.db.close(),this.db=void 0}}class ja{constructor(t){this.$t=t,this.Ft=!1,this.Bt=null}get isDone(){return this.Ft}get Lt(){return this.Bt}set cursor(t){this.$t=t}done(){this.Ft=!0}Ut(t){this.Bt=t}delete(){return Qa(this.$t.delete())}}class Ga extends Ls{constructor(t,e){super(Rs.UNAVAILABLE,`IndexedDB transaction '${t}' failed: ${e}`),this.name="IndexedDbTransactionError"}}function $a(t){return"IndexedDbTransactionError"===t.name}class za{constructor(t){this.store=t}put(t,e){let n;return void 0!==e?(xs("SimpleDb","PUT",this.store.name,t,e),n=this.store.put(e,t)):(xs("SimpleDb","PUT",this.store.name,"<auto-key>",t),n=this.store.put(t)),Qa(n)}add(t){return xs("SimpleDb","ADD",this.store.name,t,t),Qa(this.store.add(t))}get(t){return Qa(this.store.get(t)).next((e=>(void 0===e&&(e=null),xs("SimpleDb","GET",this.store.name,t,e),e)))}delete(t){return xs("SimpleDb","DELETE",this.store.name,t),Qa(this.store.delete(t))}count(){return xs("SimpleDb","COUNT",this.store.name),Qa(this.store.count())}qt(t,e){const n=this.options(t,e);if(n.index||"function"!=typeof this.store.getAll){const t=this.cursor(n),e=[];return this.Kt(t,((t,n)=>{e.push(n)})).next((()=>e))}{const t=this.store.getAll(n.range);return new qa(((e,n)=>{t.onerror=t=>{n(t.target.error)},t.onsuccess=t=>{e(t.target.result)}}))}}Gt(t,e){xs("SimpleDb","DELETE ALL",this.store.name);const n=this.options(t,e);n.jt=!1;const s=this.cursor(n);return this.Kt(s,((t,e,n)=>n.delete()))}Qt(t,e){let n;e?n=t:(n={},e=t);const s=this.cursor(n);return this.Kt(s,e)}Wt(t){const e=this.cursor({});return new qa(((n,s)=>{e.onerror=t=>{const e=Wa(t.target.error);s(e)},e.onsuccess=e=>{const s=e.target.result;s?t(s.primaryKey,s.value).next((t=>{t?s.continue():n()})):n()}}))}Kt(t,e){const n=[];return new qa(((s,r)=>{t.onerror=t=>{r(t.target.error)},t.onsuccess=t=>{const r=t.target.result;if(!r)return void s();const i=new ja(r),o=e(r.primaryKey,r.value,i);if(o instanceof qa){const t=o.catch((t=>(i.done(),qa.reject(t))));n.push(t)}i.isDone?s():null===i.Lt?r.continue():r.continue(i.Lt)}})).next((()=>qa.waitFor(n)))}options(t,e){let n;return void 0!==t&&("string"==typeof t?n=t:e=t),{index:n,range:e}}cursor(t){let e="next";if(t.reverse&&(e="prev"),t.index){const n=this.store.index(t.index);return t.jt?n.openKeyCursor(t.range,e):n.openCursor(t.range,e)}return this.store.openCursor(t.range,e)}}function Qa(t){return new qa(((e,n)=>{t.onsuccess=t=>{const n=t.target.result;e(n)},t.onerror=t=>{const e=Wa(t.target.error);n(e)}}))}let Ha=!1;function Wa(t){const e=Ka.vt((0,a.z$)());if(e>=12.2&&e<13){const e="An internal error was encountered in the Indexed Database server";if(t.message.indexOf(e)>=0){const t=new Ls("internal",`IOS_INDEXEDDB_BUG1: IndexedDb has thrown '${e}'. This is likely due to an unavoidable bug in iOS. See https://stackoverflow.com/q/56496296/110915 for details and a potential workaround.`);return Ha||(Ha=!0,setTimeout((()=>{throw t}),0)),t}}return t}class Ya extends Ua{constructor(t,e){super(),this.zt=t,this.currentSequenceNumber=e}}function Xa(t,e){const n=Os(t);return Ka.Nt(n.zt,e)}class Ja{constructor(t,e,n,s){this.batchId=t,this.localWriteTime=e,this.baseMutations=n,this.mutations=s}applyToRemoteDocument(t,e){const n=e.mutationResults;for(let e=0;e<this.mutations.length;e++){const s=this.mutations[e];s.key.isEqual(t.key)&&zi(s,t,n[e])}}applyToLocalView(t){for(const e of this.baseMutations)e.key.isEqual(t.key)&&Qi(e,t,this.localWriteTime);for(const e of this.mutations)e.key.isEqual(t.key)&&Qi(e,t,this.localWriteTime)}applyToLocalDocumentSet(t){this.mutations.forEach((e=>{const n=t.get(e.key),s=n;this.applyToLocalView(s),n.isValidDocument()||s.convertToNoDocument(Js.min())}))}keys(){return this.mutations.reduce(((t,e)=>t.add(e.key)),To())}isEqual(t){return this.batchId===t.batchId&&Ws(this.mutations,t.mutations,((t,e)=>Wi(t,e)))&&Ws(this.baseMutations,t.baseMutations,((t,e)=>Wi(t,e)))}}class Za{constructor(t,e,n,s){this.batch=t,this.commitVersion=e,this.mutationResults=n,this.docVersions=s}static from(t,e,n){Ds(t.mutations.length===n.length);let s=Io;const r=t.mutations;for(let t=0;t<r.length;t++)s=s.insert(r[t].key,n[t].version);return new Za(t,e,n,s)}}class tc{constructor(t,e){this.largestBatchId=t,this.mutation=e}getKey(){return this.mutation.key}isEqual(t){return null!==t&&this.mutation===t.mutation}toString(){return`Overlay{\n      largestBatchId: ${this.largestBatchId},\n      mutation: ${this.mutation.toString()}\n    }`}}class ec{constructor(t,e,n,s,r=Js.min(),i=Js.min(),o=cr.EMPTY_BYTE_STRING){this.target=t,this.targetId=e,this.purpose=n,this.sequenceNumber=s,this.snapshotVersion=r,this.lastLimboFreeSnapshotVersion=i,this.resumeToken=o}withSequenceNumber(t){return new ec(this.target,this.targetId,this.purpose,t,this.snapshotVersion,this.lastLimboFreeSnapshotVersion,this.resumeToken)}withResumeToken(t,e){return new ec(this.target,this.targetId,this.purpose,this.sequenceNumber,e,this.lastLimboFreeSnapshotVersion,t)}withLastLimboFreeSnapshotVersion(t){return new ec(this.target,this.targetId,this.purpose,this.sequenceNumber,this.snapshotVersion,t,this.resumeToken)}}class nc{constructor(t){this.Ht=t}}function sc(t,e){let n;if(e.document)n=Yo(t.Ht,e.document,!!e.hasCommittedMutations);else if(e.noDocument){const t=br.fromSegments(e.noDocument.path),s=cc(e.noDocument.readTime);n=Ur.newNoDocument(t,s),e.hasCommittedMutations&&n.setHasCommittedMutations()}else{if(!e.unknownDocument)return Cs();{const t=br.fromSegments(e.unknownDocument.path),s=cc(e.unknownDocument.version);n=Ur.newUnknownDocument(t,s)}}return e.readTime&&n.setReadTime(oc(e.readTime)),n}function rc(t,e){const n=ic(e.readTime),s=e.key.path.popLast().toArray();if(e.isFoundDocument()){const r=function(t,e){return{name:jo(t,e.key),fields:e.data.value.mapValue.fields,updateTime:Fo(t,e.version.toTimestamp())}}(t.Ht,e),i=e.hasCommittedMutations;return new Ta(null,null,r,i,n,s)}if(e.isNoDocument()){const t=e.key.path.toArray(),r=ac(e.version),i=e.hasCommittedMutations;return new Ta(null,new Ia(t,r),null,i,n,s)}if(e.isUnknownDocument()){const t=e.key.path.toArray(),r=ac(e.version);return new Ta(new ba(t,r),null,null,!0,n,s)}return Cs()}function ic(t){const e=t.toTimestamp();return[e.seconds,e.nanoseconds]}function oc(t){const e=new Xs(t[0],t[1]);return Js.fromTimestamp(e)}function ac(t){const e=t.toTimestamp();return new ga(e.seconds,e.nanoseconds)}function cc(t){const e=new Xs(t.seconds,t.nanoseconds);return Js.fromTimestamp(e)}function uc(t,e){const n=(e.baseMutations||[]).map((e=>Jo(t.Ht,e)));for(let t=0;t<e.mutations.length-1;++t){const n=e.mutations[t];if(t+1<e.mutations.length&&void 0!==e.mutations[t+1].transform){const s=e.mutations[t+1];n.updateTransforms=s.transform.fieldTransforms,e.mutations.splice(t+1,1),++t}}const s=e.mutations.map((e=>Jo(t.Ht,e))),r=Xs.fromMillis(e.localWriteTimeMs);return new Ja(e.batchId,r,n,s)}function hc(t){const e=cc(t.readTime),n=void 0!==t.lastLimboFreeSnapshotVersion?cc(t.lastLimboFreeSnapshotVersion):Js.min();let s;var r;return void 0!==t.query.documents?(Ds(1===(r=t.query).documents.length),s=wi(li(zo(r.documents[0])))):s=function(t){return wi(ea(t))}(t.query),new ec(s,t.targetId,0,t.lastListenSequenceNumber,e,n,cr.fromBase64String(t.resumeToken))}function lc(t,e){const n=ac(e.snapshotVersion),s=ac(e.lastLimboFreeSnapshotVersion);let r;r=Hr(e.target)?Zo(t.Ht,e.target):ta(t.Ht,e.target);const i=e.resumeToken.toBase64();return new Sa(e.targetId,zr(e.target),n,i,e.sequenceNumber,s,r)}function dc(t){const e=ea({parent:t.parent,structuredQuery:t.structuredQuery});return"LAST"===t.limitType?vi(e,e.limit,"L"):e}function fc(t,e){return new tc(e.largestBatchId,Jo(t.Ht,e.overlayMutation))}function mc(t,e){const n=e.path.lastSegment();return[t,la(e.path.popLast()),n]}class gc{getBundleMetadata(t,e){return pc(t).get(e).next((t=>{if(t)return{id:(e=t).bundleId,createTime:cc(e.createTime),version:e.version};var e}))}saveBundleMetadata(t,e){return pc(t).put({bundleId:(n=e).id,createTime:ac(qo(n.createTime)),version:n.version});var n}getNamedQuery(t,e){return yc(t).get(e).next((t=>{if(t)return{name:(e=t).name,query:dc(e.bundledQuery),readTime:cc(e.readTime)};var e}))}saveNamedQuery(t,e){return yc(t).put(function(t){return{name:t.name,readTime:ac(qo(t.readTime)),bundledQuery:t.bundledQuery}}(e))}}function pc(t){return Xa(t,Ca.store)}function yc(t){return Xa(t,Da.store)}class wc{constructor(t,e){this.O=t,this.userId=e}static Jt(t,e){const n=e.uid||"";return new wc(t,n)}getOverlay(t,e){return vc(t).get(mc(this.userId,e)).next((t=>t?fc(this.O,t):null))}saveOverlays(t,e,n){const s=[];return n.forEach((n=>{const r=new tc(e,n);s.push(this.Yt(t,r))})),qa.waitFor(s)}removeOverlaysForBatchId(t,e,n){const s=new Set;e.forEach((t=>s.add(la(t.getCollectionPath()))));const r=[];return s.forEach((e=>{const s=IDBKeyRange.bound([this.userId,e,n],[this.userId,e,n+1],!1,!0);r.push(vc(t).Gt(La.collectionPathOverlayIndex,s))})),qa.waitFor(r)}getOverlaysForCollection(t,e,n){const s=new Map,r=la(e),i=IDBKeyRange.bound([this.userId,r,n],[this.userId,r,Number.POSITIVE_INFINITY],!0);return vc(t).qt(La.collectionPathOverlayIndex,i).next((t=>{for(const e of t){const t=fc(this.O,e);s.set(t.getKey(),t)}return s}))}getOverlaysForCollectionGroup(t,e,n,s){const r=new Map;let i;const o=IDBKeyRange.bound([this.userId,e,n],[this.userId,e,Number.POSITIVE_INFINITY],!0);return vc(t).Qt({index:La.collectionGroupOverlayIndex,range:o},((t,e,n)=>{const o=fc(this.O,e);r.size<s||o.largestBatchId===i?(r.set(o.getKey(),o),i=o.largestBatchId):n.done()})).next((()=>r))}Yt(t,e){return vc(t).put(function(t,e,n){const[s,r,i]=mc(e,n.mutation.key);return new La(e,r,i,n.mutation.key.getCollectionGroup(),n.largestBatchId,Xo(t.Ht,n.mutation))}(this.O,this.userId,e))}}function vc(t){return Xa(t,La.store)}class Ic{constructor(){}Xt(t,e){this.Zt(t,e),e.te()}Zt(t,e){if("nullValue"in t)this.ee(e,5);else if("booleanValue"in t)this.ee(e,10),e.ne(t.booleanValue?1:0);else if("integerValue"in t)this.ee(e,15),e.ne(lr(t.integerValue));else if("doubleValue"in t){const n=lr(t.doubleValue);isNaN(n)?this.ee(e,13):(this.ee(e,15),vr(n)?e.ne(0):e.ne(n))}else if("timestampValue"in t){const n=t.timestampValue;this.ee(e,20),"string"==typeof n?e.se(n):(e.se(`${n.seconds||""}`),e.ne(n.nanos||0))}else if("stringValue"in t)this.ie(t.stringValue,e),this.re(e);else if("bytesValue"in t)this.ee(e,30),e.oe(dr(t.bytesValue)),this.re(e);else if("referenceValue"in t)this.ce(t.referenceValue,e);else if("geoPointValue"in t){const n=t.geoPointValue;this.ee(e,45),e.ne(n.latitude||0),e.ne(n.longitude||0)}else"mapValue"in t?Sr(t,Tr)?this.ee(e,Number.MAX_SAFE_INTEGER):(this.ue(t.mapValue,e),this.re(e)):"arrayValue"in t?(this.ae(t.arrayValue,e),this.re(e)):Cs()}ie(t,e){this.ee(e,25),this.he(t,e)}he(t,e){e.se(t)}ue(t,e){const n=t.fields||{};this.ee(e,55);for(const t of Object.keys(n))this.ie(t,e),this.Zt(n[t],e)}ae(t,e){const n=t.values||[];this.ee(e,50);for(const t of n)this.Zt(t,e)}ce(t,e){this.ee(e,37),br.fromName(t).path.forEach((t=>{this.ee(e,60),this.he(t,e)}))}ee(t,e){t.ne(e)}re(t){t.ne(2)}}function bc(t){if(0===t)return 8;let e=0;return t>>4==0&&(e+=4,t<<=4),t>>6==0&&(e+=2,t<<=2),t>>7==0&&(e+=1),e}function Tc(t){const e=64-function(t){let e=0;for(let n=0;n<8;++n){const s=bc(255&t[n]);if(e+=s,8!==s)break}return e}(t);return Math.ceil(e/8)}Ic.le=new Ic;class Ec{constructor(){this.buffer=new Uint8Array(1024),this.position=0}fe(t){const e=t[Symbol.iterator]();let n=e.next();for(;!n.done;)this.de(n.value),n=e.next();this._e()}we(t){const e=t[Symbol.iterator]();let n=e.next();for(;!n.done;)this.me(n.value),n=e.next();this.ge()}ye(t){for(const e of t){const t=e.charCodeAt(0);if(t<128)this.de(t);else if(t<2048)this.de(960|t>>>6),this.de(128|63&t);else if(e<"\ud800"||"\udbff"<e)this.de(480|t>>>12),this.de(128|63&t>>>6),this.de(128|63&t);else{const t=e.codePointAt(0);this.de(240|t>>>18),this.de(128|63&t>>>12),this.de(128|63&t>>>6),this.de(128|63&t)}}this._e()}pe(t){for(const e of t){const t=e.charCodeAt(0);if(t<128)this.me(t);else if(t<2048)this.me(960|t>>>6),this.me(128|63&t);else if(e<"\ud800"||"\udbff"<e)this.me(480|t>>>12),this.me(128|63&t>>>6),this.me(128|63&t);else{const t=e.codePointAt(0);this.me(240|t>>>18),this.me(128|63&t>>>12),this.me(128|63&t>>>6),this.me(128|63&t)}}this.ge()}Ie(t){const e=this.Ee(t),n=Tc(e);this.Te(1+n),this.buffer[this.position++]=255&n;for(let t=e.length-n;t<e.length;++t)this.buffer[this.position++]=255&e[t]}Ae(t){const e=this.Ee(t),n=Tc(e);this.Te(1+n),this.buffer[this.position++]=~(255&n);for(let t=e.length-n;t<e.length;++t)this.buffer[this.position++]=~(255&e[t])}Re(){this.Pe(255),this.Pe(255)}be(){this.ve(255),this.ve(255)}reset(){this.position=0}seed(t){this.Te(t.length),this.buffer.set(t,this.position),this.position+=t.length}Ve(){return this.buffer.slice(0,this.position)}Ee(t){const e=function(t){const e=new DataView(new ArrayBuffer(8));return e.setFloat64(0,t,!1),new Uint8Array(e.buffer)}(t),n=0!=(128&e[0]);e[0]^=n?255:128;for(let t=1;t<e.length;++t)e[t]^=n?255:0;return e}de(t){const e=255&t;0===e?(this.Pe(0),this.Pe(255)):255===e?(this.Pe(255),this.Pe(0)):this.Pe(e)}me(t){const e=255&t;0===e?(this.ve(0),this.ve(255)):255===e?(this.ve(255),this.ve(0)):this.ve(t)}_e(){this.Pe(0),this.Pe(1)}ge(){this.ve(0),this.ve(1)}Pe(t){this.Te(1),this.buffer[this.position++]=t}ve(t){this.Te(1),this.buffer[this.position++]=~t}Te(t){const e=t+this.position;if(e<=this.buffer.length)return;let n=2*this.buffer.length;n<e&&(n=e);const s=new Uint8Array(n);s.set(this.buffer),this.buffer=s}}class Sc{constructor(t){this.Se=t}oe(t){this.Se.fe(t)}se(t){this.Se.ye(t)}ne(t){this.Se.Ie(t)}te(){this.Se.Re()}}class xc{constructor(t){this.Se=t}oe(t){this.Se.we(t)}se(t){this.Se.pe(t)}ne(t){this.Se.Ae(t)}te(){this.Se.be()}}class Ac{constructor(){this.Se=new Ec,this.De=new Sc(this.Se),this.Ce=new xc(this.Se)}seed(t){this.Se.seed(t)}Ne(t){return 0===t?this.De:this.Ce}Ve(){return this.Se.Ve()}reset(){this.Se.reset()}}class _c{constructor(t,e,n,s){this.indexId=t,this.documentKey=e,this.arrayValue=n,this.directionalValue=s}}function Nc(t,e){let n=t.indexId-e.indexId;return 0!==n?n:(n=br.comparator(t.documentKey,e.documentKey),0!==n?n:(n=Cc(t.arrayValue,e.arrayValue),0!==n?n:Cc(t.directionalValue,e.directionalValue)))}function Cc(t,e){for(let n=0;n<t.length&&n<e.length;++n){const s=t[n]-e[n];if(0!==s)return s}return t.length-e.length}class Dc{constructor(){this.xe=new kc}addToCollectionParentIndex(t,e){return this.xe.add(e),qa.resolve()}getCollectionParents(t,e){return qa.resolve(this.xe.getEntries(e))}addFieldIndex(t,e){return qa.resolve()}deleteFieldIndex(t,e){return qa.resolve()}getDocumentsMatchingTarget(t,e,n){return qa.resolve(To())}getFieldIndex(t,e){return qa.resolve(null)}getFieldIndexes(t,e){return qa.resolve([])}getNextCollectionGroupToUpdate(t){return qa.resolve(null)}updateCollectionGroup(t,e,n){return qa.resolve()}updateIndexEntries(t,e){return qa.resolve()}}class kc{constructor(){this.index={}}add(t){const e=t.lastSegment(),n=t.popLast(),s=this.index[e]||new fo(sr.comparator),r=!s.has(n);return this.index[e]=s.add(n),r}has(t){const e=t.lastSegment(),n=t.popLast(),s=this.index[e];return s&&s.has(n)}getEntries(t){return(this.index[t]||new fo(sr.comparator)).toArray()}}class Oc{constructor(t){this.user=t,this.ke=new kc,this.uid=t.uid||""}addToCollectionParentIndex(t,e){if(!this.ke.has(e)){const n=e.lastSegment(),s=e.popLast();t.addOnCommittedListener((()=>{this.ke.add(e)}));const r={collectionId:n,parent:la(s)};return Rc(t).put(r)}return qa.resolve()}getCollectionParents(t,e){const n=[],s=IDBKeyRange.bound([e,""],[Ys(e),""],!1,!0);return Rc(t).qt(s).next((t=>{for(const s of t){if(s.collectionId!==e)break;n.push(ma(s.parent))}return n}))}addFieldIndex(t,e){const n=Mc(t),s=function(t){return new ka(t.indexId,t.collectionGroup,t.fields.map((t=>[t.fieldPath.canonicalString(),t.kind])))}(e);return delete s.indexId,n.add(s).next()}deleteFieldIndex(t,e){const n=Mc(t),s=Pc(t),r=Lc(t);return n.delete(e.indexId).next((()=>s.delete(IDBKeyRange.bound([e.indexId],[e.indexId+1],!1,!0)))).next((()=>r.delete(IDBKeyRange.bound([e.indexId],[e.indexId+1],!1,!0))))}getDocumentsMatchingTarget(t,e,n){return qa.resolve(To())}getFieldIndex(t,e){return qa.resolve(null)}Oe(t,e){const n=new Ac;for(const s of function(t){return t.fields.filter((t=>2!==t.kind))}(t)){const t=e.data.field(s.fieldPath);if(null==t)return null;const r=n.Ne(s.kind);Ic.le.Xt(t,r)}return n.Ve()}Me(t){const e=new Ac;return Ic.le.Xt(t,e.Ne(0)),e.Ve()}getFieldIndexes(t,e){const n=Mc(t),s=Pc(t);return(e?n.qt(ka.collectionGroupIndex,IDBKeyRange.bound(e,e)):n.qt()).next((t=>{const e=[];return qa.forEach(t,(t=>s.get([t.indexId,this.uid]).next((n=>{e.push(function(t,e){const n=e?new Kr(e.sequenceNumber,new jr(cc(e.readTime),new br(ma(e.documentKey)),e.largestBatchId)):Kr.empty(),s=t.fields.map((([t,e])=>new Br(ir.fromServerFormat(t),e)));return new qr(t.indexId,t.collectionGroup,s,n)}(t,n))})))).next((()=>e))}))}getNextCollectionGroupToUpdate(t){return this.getFieldIndexes(t).next((t=>0===t.length?null:(t.sort(((t,e)=>t.indexState.sequenceNumber-e.indexState.sequenceNumber)),t[0].collectionGroup)))}updateCollectionGroup(t,e,n){const s=Mc(t),r=Pc(t);return this.$e(t).next((t=>s.qt(ka.collectionGroupIndex,IDBKeyRange.bound(e,e)).next((e=>qa.forEach(e,(e=>r.put(function(t,e,n,s){return new Oa(t,e.uid||"",n,ac(s.readTime),la(s.documentKey.path),s.largestBatchId)}(e.indexId,this.user,t,n))))))))}updateIndexEntries(t,e){const n=new Map;return qa.forEach(e,((e,s)=>{const r=n.get(e.collectionGroup);return(r?qa.resolve(r):this.getFieldIndexes(t,e.collectionGroup)).next((r=>(n.set(e.collectionGroup,r),qa.forEach(r,(n=>this.Fe(t,e,n).next((e=>{const r=this.Be(s,n);return e.isEqual(r)?qa.resolve():this.Le(t,s,e,r)})))))))}))}Ue(t,e,n){return Lc(t).put(new Ra(n.indexId,this.uid,n.arrayValue,n.directionalValue,la(e.key.path)))}qe(t,e,n){return Lc(t).delete([n.indexId,this.uid,n.arrayValue,n.directionalValue,la(e.key.path)])}Fe(t,e,n){const s=Lc(t);let r=new fo(Nc);return s.Qt({index:Ra.documentKeyIndex,range:IDBKeyRange.only([n.indexId,this.uid,la(e.path)])},((t,s)=>{r=r.add(new _c(n.indexId,e,s.arrayValue,s.directionalValue))})).next((()=>r))}Be(t,e){let n=new fo(Nc);const s=this.Oe(e,t);if(null==s)return n;const r=function(t){return t.fields.find((t=>2===t.kind))}(e);if(null!=r){const i=t.data.field(r.fieldPath);if(Or(i))for(const r of i.arrayValue.values||[])n=n.add(new _c(e.indexId,t.key,this.Me(r),s))}else n=n.add(new _c(e.indexId,t.key,new Uint8Array,s));return n}Le(t,e,n,s){xs("IndexedDbIndexManager","Updating index entries for document '%s'",e.key);const r=[];return function(t,e,n,s,r){const i=t.getIterator(),o=e.getIterator();let a=go(i),c=go(o);for(;a||c;){let t=!1,e=!1;if(a&&c){const s=n(a,c);s<0?e=!0:s>0&&(t=!0)}else null!=a?e=!0:t=!0;t?(s(c),c=go(o)):e?(r(a),a=go(i)):(a=go(i),c=go(o))}}(n,s,Nc,(n=>{r.push(this.Ue(t,e,n))}),(n=>{r.push(this.qe(t,e,n))})),qa.waitFor(r)}$e(t){let e=1;return Pc(t).Qt({index:Oa.sequenceNumberIndex,reverse:!0,range:IDBKeyRange.upperBound([this.uid,Number.MAX_SAFE_INTEGER])},((t,n,s)=>{s.done(),e=n.sequenceNumber+1})).next((()=>e))}}function Rc(t){return Xa(t,_a.store)}function Lc(t){return Xa(t,Ra.store)}function Mc(t){return Xa(t,ka.store)}function Pc(t){return Xa(t,Oa.store)}const Fc={didRun:!1,sequenceNumbersCollected:0,targetsRemoved:0,documentsRemoved:0};class Vc{constructor(t,e,n){this.cacheSizeCollectionThreshold=t,this.percentileToCollect=e,this.maximumSequenceNumbersToCollect=n}static withCacheSize(t){return new Vc(t,Vc.DEFAULT_COLLECTION_PERCENTILE,Vc.DEFAULT_MAX_SEQUENCE_NUMBERS_TO_COLLECT)}}function Uc(t,e,n){const s=t.store(wa.store),r=t.store(va.store),i=[],o=IDBKeyRange.only(n.batchId);let a=0;const c=s.Qt({range:o},((t,e,n)=>(a++,n.delete())));i.push(c.next((()=>{Ds(1===a)})));const u=[];for(const t of n.mutations){const s=va.key(e,t.key.path,n.batchId);i.push(r.delete(s)),u.push(t.key)}return qa.waitFor(i).next((()=>u))}function qc(t){if(!t)return 0;let e;if(t.document)e=t.document;else if(t.unknownDocument)e=t.unknownDocument;else{if(!t.noDocument)throw Cs();e=t.noDocument}return JSON.stringify(e).length}Vc.DEFAULT_COLLECTION_PERCENTILE=10,Vc.DEFAULT_MAX_SEQUENCE_NUMBERS_TO_COLLECT=1e3,Vc.DEFAULT=new Vc(41943040,Vc.DEFAULT_COLLECTION_PERCENTILE,Vc.DEFAULT_MAX_SEQUENCE_NUMBERS_TO_COLLECT),Vc.DISABLED=new Vc(-1,0,0);class Bc{constructor(t,e,n,s){this.userId=t,this.O=e,this.indexManager=n,this.referenceDelegate=s,this.Ke={}}static Jt(t,e,n,s){Ds(""!==t.uid);const r=t.isAuthenticated()?t.uid:"";return new Bc(r,e,n,s)}checkEmpty(t){let e=!0;const n=IDBKeyRange.bound([this.userId,Number.NEGATIVE_INFINITY],[this.userId,Number.POSITIVE_INFINITY]);return jc(t).Qt({index:wa.userMutationsIndex,range:n},((t,n,s)=>{e=!1,s.done()})).next((()=>e))}addMutationBatch(t,e,n,s){const r=Gc(t),i=jc(t);return i.add({}).next((o=>{Ds("number"==typeof o);const a=new Ja(o,e,n,s),c=function(t,e,n){const s=n.baseMutations.map((e=>Xo(t.Ht,e))),r=n.mutations.map((e=>Xo(t.Ht,e)));return new wa(e,n.batchId,n.localWriteTime.toMillis(),s,r)}(this.O,this.userId,a),u=[];let h=new fo(((t,e)=>Hs(t.canonicalString(),e.canonicalString())));for(const t of s){const e=va.key(this.userId,t.key.path,o);h=h.add(t.key.path.popLast()),u.push(i.put(c)),u.push(r.put(e,va.PLACEHOLDER))}return h.forEach((e=>{u.push(this.indexManager.addToCollectionParentIndex(t,e))})),t.addOnCommittedListener((()=>{this.Ke[o]=a.keys()})),qa.waitFor(u).next((()=>a))}))}lookupMutationBatch(t,e){return jc(t).get(e).next((t=>t?(Ds(t.userId===this.userId),uc(this.O,t)):null))}Ge(t,e){return this.Ke[e]?qa.resolve(this.Ke[e]):this.lookupMutationBatch(t,e).next((t=>{if(t){const n=t.keys();return this.Ke[e]=n,n}return null}))}getNextMutationBatchAfterBatchId(t,e){const n=e+1,s=IDBKeyRange.lowerBound([this.userId,n]);let r=null;return jc(t).Qt({index:wa.userMutationsIndex,range:s},((t,e,s)=>{e.userId===this.userId&&(Ds(e.batchId>=n),r=uc(this.O,e)),s.done()})).next((()=>r))}getHighestUnacknowledgedBatchId(t){const e=IDBKeyRange.upperBound([this.userId,Number.POSITIVE_INFINITY]);let n=-1;return jc(t).Qt({index:wa.userMutationsIndex,range:e,reverse:!0},((t,e,s)=>{n=e.batchId,s.done()})).next((()=>n))}getAllMutationBatches(t){const e=IDBKeyRange.bound([this.userId,-1],[this.userId,Number.POSITIVE_INFINITY]);return jc(t).qt(wa.userMutationsIndex,e).next((t=>t.map((t=>uc(this.O,t)))))}getAllMutationBatchesAffectingDocumentKey(t,e){const n=va.prefixForPath(this.userId,e.path),s=IDBKeyRange.lowerBound(n),r=[];return Gc(t).Qt({range:s},((n,s,i)=>{const[o,a,c]=n,u=ma(a);if(o===this.userId&&e.path.isEqual(u))return jc(t).get(c).next((t=>{if(!t)throw Cs();Ds(t.userId===this.userId),r.push(uc(this.O,t))}));i.done()})).next((()=>r))}getAllMutationBatchesAffectingDocumentKeys(t,e){let n=new fo(Hs);const s=[];return e.forEach((e=>{const r=va.prefixForPath(this.userId,e.path),i=IDBKeyRange.lowerBound(r),o=Gc(t).Qt({range:i},((t,s,r)=>{const[i,o,a]=t,c=ma(o);i===this.userId&&e.path.isEqual(c)?n=n.add(a):r.done()}));s.push(o)})),qa.waitFor(s).next((()=>this.je(t,n)))}getAllMutationBatchesAffectingQuery(t,e){const n=e.path,s=n.length+1,r=va.prefixForPath(this.userId,n),i=IDBKeyRange.lowerBound(r);let o=new fo(Hs);return Gc(t).Qt({range:i},((t,e,r)=>{const[i,a,c]=t,u=ma(a);i===this.userId&&n.isPrefixOf(u)?u.length===s&&(o=o.add(c)):r.done()})).next((()=>this.je(t,o)))}je(t,e){const n=[],s=[];return e.forEach((e=>{s.push(jc(t).get(e).next((t=>{if(null===t)throw Cs();Ds(t.userId===this.userId),n.push(uc(this.O,t))})))})),qa.waitFor(s).next((()=>n))}removeMutationBatch(t,e){return Uc(t.zt,this.userId,e).next((n=>(t.addOnCommittedListener((()=>{this.Qe(e.batchId)})),qa.forEach(n,(e=>this.referenceDelegate.markPotentiallyOrphaned(t,e))))))}Qe(t){delete this.Ke[t]}performConsistencyCheck(t){return this.checkEmpty(t).next((e=>{if(!e)return qa.resolve();const n=IDBKeyRange.lowerBound(va.prefixForUser(this.userId)),s=[];return Gc(t).Qt({range:n},((t,e,n)=>{if(t[0]===this.userId){const e=ma(t[1]);s.push(e)}else n.done()})).next((()=>{Ds(0===s.length)}))}))}containsKey(t,e){return Kc(t,this.userId,e)}We(t){return $c(t).get(this.userId).next((t=>t||new ya(this.userId,-1,"")))}}function Kc(t,e,n){const s=va.prefixForPath(e,n.path),r=s[1],i=IDBKeyRange.lowerBound(s);let o=!1;return Gc(t).Qt({range:i,jt:!0},((t,n,s)=>{const[i,a,c]=t;i===e&&a===r&&(o=!0),s.done()})).next((()=>o))}function jc(t){return Xa(t,wa.store)}function Gc(t){return Xa(t,va.store)}function $c(t){return Xa(t,ya.store)}class zc{constructor(t){this.ze=t}next(){return this.ze+=2,this.ze}static He(){return new zc(0)}static Je(){return new zc(-1)}}class Qc{constructor(t,e){this.referenceDelegate=t,this.O=e}allocateTargetId(t){return this.Ye(t).next((e=>{const n=new zc(e.highestTargetId);return e.highestTargetId=n.next(),this.Xe(t,e).next((()=>e.highestTargetId))}))}getLastRemoteSnapshotVersion(t){return this.Ye(t).next((t=>Js.fromTimestamp(new Xs(t.lastRemoteSnapshotVersion.seconds,t.lastRemoteSnapshotVersion.nanoseconds))))}getHighestSequenceNumber(t){return this.Ye(t).next((t=>t.highestListenSequenceNumber))}setTargetsMetadata(t,e,n){return this.Ye(t).next((s=>(s.highestListenSequenceNumber=e,n&&(s.lastRemoteSnapshotVersion=n.toTimestamp()),e>s.highestListenSequenceNumber&&(s.highestListenSequenceNumber=e),this.Xe(t,s))))}addTargetData(t,e){return this.Ze(t,e).next((()=>this.Ye(t).next((n=>(n.targetCount+=1,this.tn(e,n),this.Xe(t,n))))))}updateTargetData(t,e){return this.Ze(t,e)}removeTargetData(t,e){return this.removeMatchingKeysForTargetId(t,e.targetId).next((()=>Hc(t).delete(e.targetId))).next((()=>this.Ye(t))).next((e=>(Ds(e.targetCount>0),e.targetCount-=1,this.Xe(t,e))))}removeTargets(t,e,n){let s=0;const r=[];return Hc(t).Qt(((i,o)=>{const a=hc(o);a.sequenceNumber<=e&&null===n.get(a.targetId)&&(s++,r.push(this.removeTargetData(t,a)))})).next((()=>qa.waitFor(r))).next((()=>s))}forEachTarget(t,e){return Hc(t).Qt(((t,n)=>{const s=hc(n);e(s)}))}Ye(t){return Wc(t).get(Aa.key).next((t=>(Ds(null!==t),t)))}Xe(t,e){return Wc(t).put(Aa.key,e)}Ze(t,e){return Hc(t).put(lc(this.O,e))}tn(t,e){let n=!1;return t.targetId>e.highestTargetId&&(e.highestTargetId=t.targetId,n=!0),t.sequenceNumber>e.highestListenSequenceNumber&&(e.highestListenSequenceNumber=t.sequenceNumber,n=!0),n}getTargetCount(t){return this.Ye(t).next((t=>t.targetCount))}getTargetData(t,e){const n=zr(e),s=IDBKeyRange.bound([n,Number.NEGATIVE_INFINITY],[n,Number.POSITIVE_INFINITY]);let r=null;return Hc(t).Qt({range:s,index:Sa.queryTargetsIndexName},((t,n,s)=>{const i=hc(n);Qr(e,i.target)&&(r=i,s.done())})).next((()=>r))}addMatchingKeys(t,e,n){const s=[],r=Yc(t);return e.forEach((e=>{const i=la(e.path);s.push(r.put(new xa(n,i))),s.push(this.referenceDelegate.addReference(t,n,e))})),qa.waitFor(s)}removeMatchingKeys(t,e,n){const s=Yc(t);return qa.forEach(e,(e=>{const r=la(e.path);return qa.waitFor([s.delete([n,r]),this.referenceDelegate.removeReference(t,n,e)])}))}removeMatchingKeysForTargetId(t,e){const n=Yc(t),s=IDBKeyRange.bound([e],[e+1],!1,!0);return n.delete(s)}getMatchingKeysForTargetId(t,e){const n=IDBKeyRange.bound([e],[e+1],!1,!0),s=Yc(t);let r=To();return s.Qt({range:n,jt:!0},((t,e,n)=>{const s=ma(t[1]),i=new br(s);r=r.add(i)})).next((()=>r))}containsKey(t,e){const n=la(e.path),s=IDBKeyRange.bound([n],[Ys(n)],!1,!0);let r=0;return Yc(t).Qt({index:xa.documentTargetsIndex,jt:!0,range:s},(([t,e],n,s)=>{0!==t&&(r++,s.done())})).next((()=>r>0))}Tt(t,e){return Hc(t).get(e).next((t=>t?hc(t):null))}}function Hc(t){return Xa(t,Sa.store)}function Wc(t){return Xa(t,Aa.store)}function Yc(t){return Xa(t,xa.store)}async function Xc(t){if(t.code!==Rs.FAILED_PRECONDITION||t.message!==Va)throw t;xs("LocalStore","Unexpectedly lost primary lease")}function Jc([t,e],[n,s]){const r=Hs(t,n);return 0===r?Hs(e,s):r}class Zc{constructor(t){this.en=t,this.buffer=new fo(Jc),this.nn=0}sn(){return++this.nn}rn(t){const e=[t,this.sn()];if(this.buffer.size<this.en)this.buffer=this.buffer.add(e);else{const t=this.buffer.last();Jc(e,t)<0&&(this.buffer=this.buffer.delete(t).add(e))}}get maxValue(){return this.buffer.last()[0]}}class tu{constructor(t,e){this.garbageCollector=t,this.asyncQueue=e,this.on=!1,this.cn=null}start(t){-1!==this.garbageCollector.params.cacheSizeCollectionThreshold&&this.un(t)}stop(){this.cn&&(this.cn.cancel(),this.cn=null)}get started(){return null!==this.cn}un(t){const e=this.on?3e5:6e4;xs("LruGarbageCollector",`Garbage collection scheduled in ${e}ms`),this.cn=this.asyncQueue.enqueueAfterDelay("lru_garbage_collection",e,(async()=>{this.cn=null,this.on=!0;try{await t.collectGarbage(this.garbageCollector)}catch(t){$a(t)?xs("LruGarbageCollector","Ignoring IndexedDB error during garbage collection: ",t):await Xc(t)}await this.un(t)}))}}class eu{constructor(t,e){this.an=t,this.params=e}calculateTargetCount(t,e){return this.an.hn(t).next((t=>Math.floor(e/100*t)))}nthSequenceNumber(t,e){if(0===e)return qa.resolve($s.A);const n=new Zc(e);return this.an.forEachTarget(t,(t=>n.rn(t.sequenceNumber))).next((()=>this.an.ln(t,(t=>n.rn(t))))).next((()=>n.maxValue))}removeTargets(t,e,n){return this.an.removeTargets(t,e,n)}removeOrphanedDocuments(t,e){return this.an.removeOrphanedDocuments(t,e)}collect(t,e){return-1===this.params.cacheSizeCollectionThreshold?(xs("LruGarbageCollector","Garbage collection skipped; disabled"),qa.resolve(Fc)):this.getCacheSize(t).next((n=>n<this.params.cacheSizeCollectionThreshold?(xs("LruGarbageCollector",`Garbage collection skipped; Cache size ${n} is lower than threshold ${this.params.cacheSizeCollectionThreshold}`),Fc):this.fn(t,e)))}getCacheSize(t){return this.an.getCacheSize(t)}fn(t,e){let n,s,r,i,a,c,u;const h=Date.now();return this.calculateTargetCount(t,this.params.percentileToCollect).next((e=>(e>this.params.maximumSequenceNumbersToCollect?(xs("LruGarbageCollector",`Capping sequence numbers to collect down to the maximum of ${this.params.maximumSequenceNumbersToCollect} from ${e}`),s=this.params.maximumSequenceNumbersToCollect):s=e,i=Date.now(),this.nthSequenceNumber(t,s)))).next((s=>(n=s,a=Date.now(),this.removeTargets(t,n,e)))).next((e=>(r=e,c=Date.now(),this.removeOrphanedDocuments(t,n)))).next((t=>(u=Date.now(),Es()<=o.in.DEBUG&&xs("LruGarbageCollector",`LRU Garbage Collection\n\tCounted targets in ${i-h}ms\n\tDetermined least recently used ${s} in `+(a-i)+"ms\n"+`\tRemoved ${r} targets in `+(c-a)+"ms\n"+`\tRemoved ${t} documents in `+(u-c)+"ms\n"+`Total Duration: ${u-h}ms`),qa.resolve({didRun:!0,sequenceNumbersCollected:s,targetsRemoved:r,documentsRemoved:t}))))}}class nu{constructor(t,e){this.db=t,this.garbageCollector=function(t,e){return new eu(t,e)}(this,e)}hn(t){const e=this.dn(t);return this.db.getTargetCache().getTargetCount(t).next((t=>e.next((e=>t+e))))}dn(t){let e=0;return this.ln(t,(t=>{e++})).next((()=>e))}forEachTarget(t,e){return this.db.getTargetCache().forEachTarget(t,e)}ln(t,e){return this._n(t,((t,n)=>e(n)))}addReference(t,e,n){return su(t,n)}removeReference(t,e,n){return su(t,n)}removeTargets(t,e,n){return this.db.getTargetCache().removeTargets(t,e,n)}markPotentiallyOrphaned(t,e){return su(t,e)}wn(t,e){return function(t,e){let n=!1;return $c(t).Wt((s=>Kc(t,s,e).next((t=>(t&&(n=!0),qa.resolve(!t)))))).next((()=>n))}(t,e)}removeOrphanedDocuments(t,e){const n=this.db.getRemoteDocumentCache().newChangeBuffer(),s=[];let r=0;return this._n(t,((i,o)=>{if(o<=e){const e=this.wn(t,i).next((e=>{if(!e)return r++,n.getEntry(t,i).next((()=>(n.removeEntry(i,Js.min()),Yc(t).delete([0,la(i.path)]))))}));s.push(e)}})).next((()=>qa.waitFor(s))).next((()=>n.apply(t))).next((()=>r))}removeTarget(t,e){const n=e.withSequenceNumber(t.currentSequenceNumber);return this.db.getTargetCache().updateTargetData(t,n)}updateLimboDocument(t,e){return su(t,e)}_n(t,e){const n=Yc(t);let s,r=$s.A;return n.Qt({index:xa.documentTargetsIndex},(([t,n],{path:i,sequenceNumber:o})=>{0===t?(r!==$s.A&&e(new br(ma(s)),r),r=o,s=i):r=$s.A})).next((()=>{r!==$s.A&&e(new br(ma(s)),r)}))}getCacheSize(t){return this.db.getRemoteDocumentCache().getSize(t)}}function su(t,e){return Yc(t).put(function(t,e){return new xa(0,la(t.path),e)}(e,t.currentSequenceNumber))}class ru{constructor(t,e){this.mapKeyFn=t,this.equalsFn=e,this.inner={}}get(t){const e=this.mapKeyFn(t),n=this.inner[e];if(void 0!==n)for(const[e,s]of n)if(this.equalsFn(e,t))return s}has(t){return void 0!==this.get(t)}set(t,e){const n=this.mapKeyFn(t),s=this.inner[n];if(void 0!==s){for(let n=0;n<s.length;n++)if(this.equalsFn(s[n][0],t))return void(s[n]=[t,e]);s.push([t,e])}else this.inner[n]=[[t,e]]}delete(t){const e=this.mapKeyFn(t),n=this.inner[e];if(void 0===n)return!1;for(let s=0;s<n.length;s++)if(this.equalsFn(n[s][0],t))return 1===n.length?delete this.inner[e]:n.splice(s,1),!0;return!1}forEach(t){tr(this.inner,((e,n)=>{for(const[e,s]of n)t(e,s)}))}isEmpty(){return er(this.inner)}}class iu{constructor(){this.changes=new ru((t=>t.toString()),((t,e)=>t.isEqual(e))),this.changesApplied=!1}addEntry(t){this.assertNotApplied(),this.changes.set(t.key,t)}removeEntry(t,e){this.assertNotApplied(),this.changes.set(t,Ur.newInvalidDocument(t).setReadTime(e))}getEntry(t,e){this.assertNotApplied();const n=this.changes.get(e);return void 0!==n?qa.resolve(n):this.getFromCache(t,e)}getEntries(t,e){return this.getAllFromCache(t,e)}apply(t){return this.assertNotApplied(),this.changesApplied=!0,this.applyChanges(t)}assertNotApplied(){}}class ou{constructor(t){this.O=t}setIndexManager(t){this.indexManager=t}addEntry(t,e,n){return uu(t).put(hu(e),n)}removeEntry(t,e){const n=uu(t),s=hu(e);return n.delete(s)}updateMetadata(t,e){return this.getMetadata(t).next((n=>(n.byteSize+=e,this.mn(t,n))))}getEntry(t,e){return uu(t).get(hu(e)).next((t=>this.gn(e,t)))}yn(t,e){return uu(t).get(hu(e)).next((t=>({document:this.gn(e,t),size:qc(t)})))}getEntries(t,e){let n=yo();return this.pn(t,e,((t,e)=>{const s=this.gn(t,e);n=n.insert(t,s)})).next((()=>n))}In(t,e){let n=yo(),s=new uo(br.comparator);return this.pn(t,e,((t,e)=>{const r=this.gn(t,e);n=n.insert(t,r),s=s.insert(t,qc(e))})).next((()=>({documents:n,En:s})))}pn(t,e,n){if(e.isEmpty())return qa.resolve();const s=IDBKeyRange.bound(e.first().path.toArray(),e.last().path.toArray()),r=e.getIterator();let i=r.getNext();return uu(t).Qt({range:s},((t,e,s)=>{const o=br.fromSegments(t);for(;i&&br.comparator(i,o)<0;)n(i,null),i=r.getNext();i&&i.isEqual(o)&&(n(i,e),i=r.hasNext()?r.getNext():null),i?s.Ut(i.path.toArray()):s.done()})).next((()=>{for(;i;)n(i,null),i=r.hasNext()?r.getNext():null}))}getAll(t,e,n){let s=yo();const r=e.length+1,i={};if(n.isEqual(Js.min())){const t=e.toArray();i.range=IDBKeyRange.lowerBound(t)}else{const t=e.toArray(),s=ic(n);i.range=IDBKeyRange.lowerBound([t,s],!0),i.index=Ta.collectionReadTimeIndex}return uu(t).Qt(i,((t,n,i)=>{if(t.length!==r)return;const o=this.gn(br.fromSegments(t),n);e.isPrefixOf(o.key.path)?s=s.insert(o.key,o):i.done()})).next((()=>s))}newChangeBuffer(t){return new au(this,!!t&&t.trackRemovals)}getSize(t){return this.getMetadata(t).next((t=>t.byteSize))}getMetadata(t){return cu(t).get(Ea.key).next((t=>(Ds(!!t),t)))}mn(t,e){return cu(t).put(Ea.key,e)}gn(t,e){if(e){const t=sc(this.O,e);if(!t.isNoDocument()||!t.version.isEqual(Js.min()))return t}return Ur.newInvalidDocument(t)}}class au extends iu{constructor(t,e){super(),this.Tn=t,this.trackRemovals=e,this.An=new ru((t=>t.toString()),((t,e)=>t.isEqual(e)))}applyChanges(t){const e=[];let n=0,s=new fo(((t,e)=>Hs(t.canonicalString(),e.canonicalString())));return this.changes.forEach(((r,i)=>{const o=this.An.get(r);if(i.isValidDocument()){const a=rc(this.Tn.O,i);s=s.add(r.path.popLast());const c=qc(a);n+=c-o,e.push(this.Tn.addEntry(t,r,a))}else if(n-=o,this.trackRemovals){const n=rc(this.Tn.O,i.convertToNoDocument(Js.min()));e.push(this.Tn.addEntry(t,r,n))}else e.push(this.Tn.removeEntry(t,r))})),s.forEach((n=>{e.push(this.Tn.indexManager.addToCollectionParentIndex(t,n))})),e.push(this.Tn.updateMetadata(t,n)),qa.waitFor(e)}getFromCache(t,e){return this.Tn.yn(t,e).next((t=>(this.An.set(e,t.size),t.document)))}getAllFromCache(t,e){return this.Tn.In(t,e).next((({documents:t,En:e})=>(e.forEach(((t,e)=>{this.An.set(t,e)})),t)))}}function cu(t){return Xa(t,Ea.store)}function uu(t){return Xa(t,Ta.store)}function hu(t){return t.path.toArray()}class lu{constructor(t){this.O=t}kt(t,e,n,s){const r=new Ba("createOrUpgrade",e);n<1&&s>=1&&(function(t){t.createObjectStore(pa.store)}(t),function(t){t.createObjectStore(ya.store,{keyPath:ya.keyPath}),t.createObjectStore(wa.store,{keyPath:wa.keyPath,autoIncrement:!0}).createIndex(wa.userMutationsIndex,wa.userMutationsKeyPath,{unique:!0}),t.createObjectStore(va.store)}(t),du(t),function(t){t.createObjectStore(Ta.store)}(t));let i=qa.resolve();return n<3&&s>=3&&(0!==n&&(function(t){t.deleteObjectStore(xa.store),t.deleteObjectStore(Sa.store),t.deleteObjectStore(Aa.store)}(t),du(t)),i=i.next((()=>function(t){const e=t.store(Aa.store),n=new Aa(0,0,Js.min().toTimestamp(),0);return e.put(Aa.key,n)}(r)))),n<4&&s>=4&&(0!==n&&(i=i.next((()=>function(t,e){return e.store(wa.store).qt().next((n=>{t.deleteObjectStore(wa.store),t.createObjectStore(wa.store,{keyPath:wa.keyPath,autoIncrement:!0}).createIndex(wa.userMutationsIndex,wa.userMutationsKeyPath,{unique:!0});const s=e.store(wa.store),r=n.map((t=>s.put(t)));return qa.waitFor(r)}))}(t,r)))),i=i.next((()=>{!function(t){t.createObjectStore(Na.store,{keyPath:Na.keyPath})}(t)}))),n<5&&s>=5&&(i=i.next((()=>this.Rn(r)))),n<6&&s>=6&&(i=i.next((()=>(function(t){t.createObjectStore(Ea.store)}(t),this.Pn(r))))),n<7&&s>=7&&(i=i.next((()=>this.bn(r)))),n<8&&s>=8&&(i=i.next((()=>this.vn(t,r)))),n<9&&s>=9&&(i=i.next((()=>{!function(t){t.objectStoreNames.contains("remoteDocumentChanges")&&t.deleteObjectStore("remoteDocumentChanges")}(t),function(t){const e=t.objectStore(Ta.store);e.createIndex(Ta.readTimeIndex,Ta.readTimeIndexPath,{unique:!1}),e.createIndex(Ta.collectionReadTimeIndex,Ta.collectionReadTimeIndexPath,{unique:!1})}(e)}))),n<10&&s>=10&&(i=i.next((()=>this.Vn(r)))),n<11&&s>=11&&(i=i.next((()=>{!function(t){t.createObjectStore(Ca.store,{keyPath:Ca.keyPath})}(t),function(t){t.createObjectStore(Da.store,{keyPath:Da.keyPath})}(t)}))),n<12&&s>=12&&(i=i.next((()=>{!function(t){const e=t.createObjectStore(La.store,{keyPath:La.keyPath});e.createIndex(La.collectionPathOverlayIndex,La.collectionPathOverlayIndexPath,{unique:!1}),e.createIndex(La.collectionGroupOverlayIndex,La.collectionGroupOverlayIndexPath,{unique:!1})}(t)}))),n<13&&s>=13&&(i=i.next((()=>{!function(t){t.createObjectStore(ka.store,{keyPath:ka.keyPath,autoIncrement:!0}).createIndex(ka.collectionGroupIndex,ka.collectionGroupIndexPath,{unique:!1}),t.createObjectStore(Oa.store,{keyPath:Oa.keyPath}).createIndex(Oa.sequenceNumberIndex,Oa.sequenceNumberIndexPath,{unique:!1}),t.createObjectStore(Ra.store,{keyPath:Ra.keyPath}).createIndex(Ra.documentKeyIndex,Ra.documentKeyIndexPath,{unique:!1})}(t)}))),i}Pn(t){let e=0;return t.store(Ta.store).Qt(((t,n)=>{e+=qc(n)})).next((()=>{const n=new Ea(e);return t.store(Ea.store).put(Ea.key,n)}))}Rn(t){const e=t.store(ya.store),n=t.store(wa.store);return e.qt().next((e=>qa.forEach(e,(e=>{const s=IDBKeyRange.bound([e.userId,-1],[e.userId,e.lastAcknowledgedBatchId]);return n.qt(wa.userMutationsIndex,s).next((n=>qa.forEach(n,(n=>{Ds(n.userId===e.userId);const s=uc(this.O,n);return Uc(t,e.userId,s).next((()=>{}))}))))}))))}bn(t){const e=t.store(xa.store),n=t.store(Ta.store);return t.store(Aa.store).get(Aa.key).next((t=>{const s=[];return n.Qt(((n,r)=>{const i=new sr(n),o=function(t){return[0,la(t)]}(i);s.push(e.get(o).next((n=>n?qa.resolve():(n=>e.put(new xa(0,la(n),t.highestListenSequenceNumber)))(i))))})).next((()=>qa.waitFor(s)))}))}vn(t,e){t.createObjectStore(_a.store,{keyPath:_a.keyPath});const n=e.store(_a.store),s=new kc,r=t=>{if(s.add(t)){const e=t.lastSegment(),s=t.popLast();return n.put({collectionId:e,parent:la(s)})}};return e.store(Ta.store).Qt({jt:!0},((t,e)=>{const n=new sr(t);return r(n.popLast())})).next((()=>e.store(va.store).Qt({jt:!0},(([t,e,n],s)=>{const i=ma(e);return r(i.popLast())}))))}Vn(t){const e=t.store(Sa.store);return e.Qt(((t,n)=>{const s=hc(n),r=lc(this.O,s);return e.put(r)}))}}function du(t){t.createObjectStore(xa.store,{keyPath:xa.keyPath}).createIndex(xa.documentTargetsIndex,xa.documentTargetsKeyPath,{unique:!0}),t.createObjectStore(Sa.store,{keyPath:Sa.keyPath}).createIndex(Sa.queryTargetsIndexName,Sa.queryTargetsKeyPath,{unique:!0}),t.createObjectStore(Aa.store)}const fu="Failed to obtain exclusive access to the persistence layer. To allow shared access, multi-tab synchronization has to be enabled in all tabs. If you are using `experimentalForceOwningTab:true`, make sure that only one tab has persistence enabled at any given time.";class mu{constructor(t,e,n,s,r,i,o,a,c,u,h=12){if(this.allowTabSynchronization=t,this.persistenceKey=e,this.clientId=n,this.Sn=r,this.window=i,this.document=o,this.Dn=c,this.Cn=u,this.schemaVersion=h,this.Nn=null,this.xn=!1,this.isPrimary=!1,this.networkEnabled=!0,this.kn=null,this.inForeground=!1,this.On=null,this.Mn=null,this.$n=Number.NEGATIVE_INFINITY,this.Fn=t=>Promise.resolve(),!mu.Vt())throw new Ls(Rs.UNIMPLEMENTED,"This platform is either missing IndexedDB or is known to have an incomplete implementation. Offline persistence has been disabled.");this.referenceDelegate=new nu(this,s),this.Bn=e+"main",this.O=new nc(a),this.Ln=new Ka(this.Bn,this.schemaVersion,new lu(this.O)),this.Un=new Qc(this.referenceDelegate,this.O),this.qn=function(t){return new ou(t)}(this.O),this.Kn=new gc,this.window&&this.window.localStorage?this.Gn=this.window.localStorage:(this.Gn=null,!1===u&&As("IndexedDbPersistence","LocalStorage is unavailable. As a result, persistence may not work reliably. In particular enablePersistence() could fail immediately after refreshing the page."))}start(){return this.jn().then((()=>{if(!this.isPrimary&&!this.allowTabSynchronization)throw new Ls(Rs.FAILED_PRECONDITION,fu);return this.Qn(),this.Wn(),this.zn(),this.runTransaction("getHighestListenSequenceNumber","readonly",(t=>this.Un.getHighestSequenceNumber(t)))})).then((t=>{this.Nn=new $s(t,this.Dn)})).then((()=>{this.xn=!0})).catch((t=>(this.Ln&&this.Ln.close(),Promise.reject(t))))}Hn(t){return this.Fn=async e=>{if(this.started)return t(e)},t(this.isPrimary)}setDatabaseDeletedListener(t){this.Ln.Mt((async e=>{null===e.newVersion&&await t()}))}setNetworkEnabled(t){this.networkEnabled!==t&&(this.networkEnabled=t,this.Sn.enqueueAndForget((async()=>{this.started&&await this.jn()})))}jn(){return this.runTransaction("updateClientMetadataAndTryBecomePrimary","readwrite",(t=>pu(t).put(new Na(this.clientId,Date.now(),this.networkEnabled,this.inForeground)).next((()=>{if(this.isPrimary)return this.Jn(t).next((t=>{t||(this.isPrimary=!1,this.Sn.enqueueRetryable((()=>this.Fn(!1))))}))})).next((()=>this.Yn(t))).next((e=>this.isPrimary&&!e?this.Xn(t).next((()=>!1)):!!e&&this.Zn(t).next((()=>!0)))))).catch((t=>{if($a(t))return xs("IndexedDbPersistence","Failed to extend owner lease: ",t),this.isPrimary;if(!this.allowTabSynchronization)throw t;return xs("IndexedDbPersistence","Releasing owner lease after error during lease refresh",t),!1})).then((t=>{this.isPrimary!==t&&this.Sn.enqueueRetryable((()=>this.Fn(t))),this.isPrimary=t}))}Jn(t){return gu(t).get(pa.key).next((t=>qa.resolve(this.ts(t))))}es(t){return pu(t).delete(this.clientId)}async ns(){if(this.isPrimary&&!this.ss(this.$n,18e5)){this.$n=Date.now();const t=await this.runTransaction("maybeGarbageCollectMultiClientState","readwrite-primary",(t=>{const e=Xa(t,Na.store);return e.qt().next((t=>{const n=this.rs(t,18e5),s=t.filter((t=>-1===n.indexOf(t)));return qa.forEach(s,(t=>e.delete(t.clientId))).next((()=>s))}))})).catch((()=>[]));if(this.Gn)for(const e of t)this.Gn.removeItem(this.os(e.clientId))}}zn(){this.Mn=this.Sn.enqueueAfterDelay("client_metadata_refresh",4e3,(()=>this.jn().then((()=>this.ns())).then((()=>this.zn()))))}ts(t){return!!t&&t.ownerId===this.clientId}Yn(t){return this.Cn?qa.resolve(!0):gu(t).get(pa.key).next((e=>{if(null!==e&&this.ss(e.leaseTimestampMs,5e3)&&!this.cs(e.ownerId)){if(this.ts(e)&&this.networkEnabled)return!0;if(!this.ts(e)){if(!e.allowTabSynchronization)throw new Ls(Rs.FAILED_PRECONDITION,fu);return!1}}return!(!this.networkEnabled||!this.inForeground)||pu(t).qt().next((t=>void 0===this.rs(t,5e3).find((t=>{if(this.clientId!==t.clientId){const e=!this.networkEnabled&&t.networkEnabled,n=!this.inForeground&&t.inForeground,s=this.networkEnabled===t.networkEnabled;if(e||n&&s)return!0}return!1}))))})).next((t=>(this.isPrimary!==t&&xs("IndexedDbPersistence",`Client ${t?"is":"is not"} eligible for a primary lease.`),t)))}async shutdown(){this.xn=!1,this.us(),this.Mn&&(this.Mn.cancel(),this.Mn=null),this.hs(),this.ls(),await this.Ln.runTransaction("shutdown","readwrite",[pa.store,Na.store],(t=>{const e=new Ya(t,$s.A);return this.Xn(e).next((()=>this.es(e)))})),this.Ln.close(),this.fs()}rs(t,e){return t.filter((t=>this.ss(t.updateTimeMs,e)&&!this.cs(t.clientId)))}ds(){return this.runTransaction("getActiveClients","readonly",(t=>pu(t).qt().next((t=>this.rs(t,18e5).map((t=>t.clientId))))))}get started(){return this.xn}getMutationQueue(t,e){return Bc.Jt(t,this.O,e,this.referenceDelegate)}getTargetCache(){return this.Un}getRemoteDocumentCache(){return this.qn}getIndexManager(t){return new Oc(t)}getDocumentOverlayCache(t){return wc.Jt(this.O,t)}getBundleCache(){return this.Kn}runTransaction(t,e,n){xs("IndexedDbPersistence","Starting transaction:",t);const s="readonly"===e?"readonly":"readwrite",r=13===(i=this.schemaVersion)?Fa:12===i?Pa:11===i?Ma:void Cs();var i;let o;return this.Ln.runTransaction(t,s,r,(s=>(o=new Ya(s,this.Nn?this.Nn.next():$s.A),"readwrite-primary"===e?this.Jn(o).next((t=>!!t||this.Yn(o))).next((e=>{if(!e)throw As(`Failed to obtain primary lease for action '${t}'.`),this.isPrimary=!1,this.Sn.enqueueRetryable((()=>this.Fn(!1))),new Ls(Rs.FAILED_PRECONDITION,Va);return n(o)})).next((t=>this.Zn(o).next((()=>t)))):this._s(o).next((()=>n(o)))))).then((t=>(o.raiseOnCommittedEvent(),t)))}_s(t){return gu(t).get(pa.key).next((t=>{if(null!==t&&this.ss(t.leaseTimestampMs,5e3)&&!this.cs(t.ownerId)&&!this.ts(t)&&!(this.Cn||this.allowTabSynchronization&&t.allowTabSynchronization))throw new Ls(Rs.FAILED_PRECONDITION,fu)}))}Zn(t){const e=new pa(this.clientId,this.allowTabSynchronization,Date.now());return gu(t).put(pa.key,e)}static Vt(){return Ka.Vt()}Xn(t){const e=gu(t);return e.get(pa.key).next((t=>this.ts(t)?(xs("IndexedDbPersistence","Releasing primary lease."),e.delete(pa.key)):qa.resolve()))}ss(t,e){const n=Date.now();return!(t<n-e||t>n&&(As(`Detected an update time that is in the future: ${t} > ${n}`),1))}Qn(){null!==this.document&&"function"==typeof this.document.addEventListener&&(this.On=()=>{this.Sn.enqueueAndForget((()=>(this.inForeground="visible"===this.document.visibilityState,this.jn())))},this.document.addEventListener("visibilitychange",this.On),this.inForeground="visible"===this.document.visibilityState)}hs(){this.On&&(this.document.removeEventListener("visibilitychange",this.On),this.On=null)}Wn(){var t;"function"==typeof(null===(t=this.window)||void 0===t?void 0:t.addEventListener)&&(this.kn=()=>{this.us(),(0,a.G6)()&&navigator.appVersion.match(/Version\/1[45]/)&&this.Sn.enterRestrictedMode(!0),this.Sn.enqueueAndForget((()=>this.shutdown()))},this.window.addEventListener("pagehide",this.kn))}ls(){this.kn&&(this.window.removeEventListener("pagehide",this.kn),this.kn=null)}cs(t){var e;try{const n=null!==(null===(e=this.Gn)||void 0===e?void 0:e.getItem(this.os(t)));return xs("IndexedDbPersistence",`Client '${t}' ${n?"is":"is not"} zombied in LocalStorage`),n}catch(t){return As("IndexedDbPersistence","Failed to get zombied client id.",t),!1}}us(){if(this.Gn)try{this.Gn.setItem(this.os(this.clientId),String(Date.now()))}catch(t){As("Failed to set zombie client id.",t)}}fs(){if(this.Gn)try{this.Gn.removeItem(this.os(this.clientId))}catch(t){}}os(t){return`firestore_zombie_${this.persistenceKey}_${t}`}}function gu(t){return Xa(t,pa.store)}function pu(t){return Xa(t,Na.store)}function yu(t,e){let n=t.projectId;return t.isDefaultDatabase||(n+="."+t.database),"firestore/"+e+"/"+n+"/"}class wu{constructor(t,e){this.progress=t,this.ws=e}}class vu{constructor(t,e,n){this.qn=t,this.gs=e,this.indexManager=n}ys(t,e){return this.gs.getAllMutationBatchesAffectingDocumentKey(t,e).next((n=>this.ps(t,e,n)))}ps(t,e,n){return this.qn.getEntry(t,e).next((t=>{for(const e of n)e.applyToLocalView(t);return t}))}Is(t,e){t.forEach(((t,n)=>{for(const t of e)t.applyToLocalView(n)}))}Es(t,e){return this.qn.getEntries(t,e).next((e=>this.Ts(t,e).next((()=>e))))}Ts(t,e){return this.gs.getAllMutationBatchesAffectingDocumentKeys(t,e).next((t=>this.Is(e,t)))}As(t,e,n){return function(t){return br.isDocumentKey(t.path)&&null===t.collectionGroup&&0===t.filters.length}(e)?this.Rs(t,e.path):pi(e)?this.Ps(t,e,n):this.bs(t,e,n)}Rs(t,e){return this.ys(t,new br(e)).next((t=>{let e=vo();return t.isFoundDocument()&&(e=e.insert(t.key,t)),e}))}Ps(t,e,n){const s=e.collectionGroup;let r=vo();return this.indexManager.getCollectionParents(t,s).next((i=>qa.forEach(i,(i=>{const o=function(t,e){return new ui(e,null,t.explicitOrderBy.slice(),t.filters.slice(),t.limit,t.limitType,t.startAt,t.endAt)}(e,i.child(s));return this.bs(t,o,n).next((t=>{t.forEach(((t,e)=>{r=r.insert(t,e)}))}))})).next((()=>r))))}bs(t,e,n){let s;return this.qn.getAll(t,e.path,n).next((n=>(s=n,this.gs.getAllMutationBatchesAffectingQuery(t,e)))).next((t=>{for(const e of t)for(const t of e.mutations){const n=t.key;let r=s.get(n);null==r&&(r=Ur.newInvalidDocument(n),s=s.insert(n,r)),Qi(t,r,e.localWriteTime),r.isFoundDocument()||(s=s.remove(n))}})).next((()=>(s.forEach(((t,n)=>{Ei(e,n)||(s=s.remove(t))})),s)))}}class Iu{constructor(t,e,n,s){this.targetId=t,this.fromCache=e,this.vs=n,this.Vs=s}static Ss(t,e){let n=To(),s=To();for(const t of e.docChanges)switch(t.type){case 0:n=n.add(t.doc.key);break;case 1:s=s.add(t.doc.key)}return new Iu(t,e.fromCache,n,s)}}class bu{Ds(t){this.Cs=t}As(t,e,n,s){return function(t){return 0===t.filters.length&&null===t.limit&&null==t.startAt&&null==t.endAt&&(0===t.explicitOrderBy.length||1===t.explicitOrderBy.length&&t.explicitOrderBy[0].field.isKeyField())}(e)||n.isEqual(Js.min())?this.Ns(t,e):this.Cs.Es(t,s).next((r=>{const i=this.xs(e,r);return(di(e)||fi(e))&&this.ks(e.limitType,i,s,n)?this.Ns(t,e):(Es()<=o.in.DEBUG&&xs("QueryEngine","Re-using previous result from %s to execute query: %s",n.toString(),Ti(e)),this.Cs.As(t,e,n).next((t=>(i.forEach((e=>{t=t.insert(e.key,e)})),t))))}))}xs(t,e){let n=new fo(Si(t));return e.forEach(((e,s)=>{Ei(t,s)&&(n=n.add(s))})),n}ks(t,e,n,s){if(n.size!==e.size)return!0;const r="F"===t?e.last():e.first();return!!r&&(r.hasPendingWrites||r.version.compareTo(s)>0)}Ns(t,e){return Es()<=o.in.DEBUG&&xs("QueryEngine","Using full collection scan to execute query:",Ti(e)),this.Cs.As(t,e,Js.min())}}class Tu{constructor(t,e,n,s){this.persistence=t,this.Os=e,this.O=s,this.Ms=new uo(Hs),this.$s=new ru((t=>zr(t)),Qr),this.Fs=Js.min(),this.Bs=t.getRemoteDocumentCache(),this.Un=t.getTargetCache(),this.Kn=t.getBundleCache(),this.Ls(n)}Ls(t){this.indexManager=this.persistence.getIndexManager(t),this.gs=this.persistence.getMutationQueue(t,this.indexManager),this.Us=new vu(this.Bs,this.gs,this.indexManager),this.Bs.setIndexManager(this.indexManager),this.Os.Ds(this.Us)}collectGarbage(t){return this.persistence.runTransaction("Collect garbage","readwrite-primary",(e=>t.collect(e,this.Ms)))}}function Eu(t,e,n,s){return new Tu(t,e,n,s)}async function Su(t,e){const n=Os(t);return await n.persistence.runTransaction("Handle user change","readonly",(t=>{let s;return n.gs.getAllMutationBatches(t).next((r=>(s=r,n.Ls(e),n.gs.getAllMutationBatches(t)))).next((e=>{const r=[],i=[];let o=To();for(const t of s){r.push(t.batchId);for(const e of t.mutations)o=o.add(e.key)}for(const t of e){i.push(t.batchId);for(const e of t.mutations)o=o.add(e.key)}return n.Us.Es(t,o).next((t=>({qs:t,removedBatchIds:r,addedBatchIds:i})))}))}))}function xu(t){const e=Os(t);return e.persistence.runTransaction("Get last remote snapshot version","readonly",(t=>e.Un.getLastRemoteSnapshotVersion(t)))}function Au(t,e,n){let s=To();return n.forEach((t=>s=s.add(t))),e.getEntries(t,s).next((t=>{let s=yo();return n.forEach(((n,r)=>{const i=t.get(n);r.isNoDocument()&&r.version.isEqual(Js.min())?(e.removeEntry(n,r.readTime),s=s.insert(n,r)):!i.isValidDocument()||r.version.compareTo(i.version)>0||0===r.version.compareTo(i.version)&&i.hasPendingWrites?(e.addEntry(r),s=s.insert(n,r)):xs("LocalStore","Ignoring outdated watch update for ",n,". Current version:",i.version," Watch version:",r.version)})),s}))}function _u(t,e){const n=Os(t);return n.persistence.runTransaction("Get next mutation batch","readonly",(t=>(void 0===e&&(e=-1),n.gs.getNextMutationBatchAfterBatchId(t,e))))}function Nu(t,e){const n=Os(t);return n.persistence.runTransaction("Allocate target","readwrite",(t=>{let s;return n.Un.getTargetData(t,e).next((r=>r?(s=r,qa.resolve(s)):n.Un.allocateTargetId(t).next((r=>(s=new ec(e,r,0,t.currentSequenceNumber),n.Un.addTargetData(t,s).next((()=>s)))))))})).then((t=>{const s=n.Ms.get(t.targetId);return(null===s||t.snapshotVersion.compareTo(s.snapshotVersion)>0)&&(n.Ms=n.Ms.insert(t.targetId,t),n.$s.set(e,t.targetId)),t}))}async function Cu(t,e,n){const s=Os(t),r=s.Ms.get(e),i=n?"readwrite":"readwrite-primary";try{n||await s.persistence.runTransaction("Release target",i,(t=>s.persistence.referenceDelegate.removeTarget(t,r)))}catch(t){if(!$a(t))throw t;xs("LocalStore",`Failed to update sequence numbers for target ${e}: ${t}`)}s.Ms=s.Ms.remove(e),s.$s.delete(r.target)}function Du(t,e,n){const s=Os(t);let r=Js.min(),i=To();return s.persistence.runTransaction("Execute query","readonly",(t=>function(t,e,n){const s=Os(t),r=s.$s.get(n);return void 0!==r?qa.resolve(s.Ms.get(r)):s.Un.getTargetData(e,n)}(s,t,wi(e)).next((e=>{if(e)return r=e.lastLimboFreeSnapshotVersion,s.Un.getMatchingKeysForTargetId(t,e.targetId).next((t=>{i=t}))})).next((()=>s.Os.As(t,e,n?r:Js.min(),n?i:To()))).next((t=>({documents:t,Ks:i})))))}function ku(t,e){const n=Os(t),s=Os(n.Un),r=n.Ms.get(e);return r?Promise.resolve(r.target):n.persistence.runTransaction("Get target data","readonly",(t=>s.Tt(t,e).next((t=>t?t.target:null))))}function Ou(t){const e=Os(t);return e.persistence.runTransaction("Get new document changes","readonly",(t=>function(t,e,n){const s=Os(t);let r=yo(),i=ic(n);const o=uu(e),a=IDBKeyRange.lowerBound(i,!0);return o.Qt({index:Ta.readTimeIndex,range:a},((t,e)=>{const n=sc(s.O,e);r=r.insert(n.key,n),i=e.readTime})).next((()=>({ws:r,readTime:oc(i)})))}(e.Bs,t,e.Fs))).then((({ws:t,readTime:n})=>(e.Fs=n,t)))}async function Ru(t,e,n=To()){const s=await Nu(t,wi(dc(e.bundledQuery))),r=Os(t);return r.persistence.runTransaction("Save named query","readwrite",(t=>{const i=qo(e.readTime);if(s.snapshotVersion.compareTo(i)>=0)return r.Kn.saveNamedQuery(t,e);const o=s.withResumeToken(cr.EMPTY_BYTE_STRING,i);return r.Ms=r.Ms.insert(o.targetId,o),r.Un.updateTargetData(t,o).next((()=>r.Un.removeMatchingKeysForTargetId(t,s.targetId))).next((()=>r.Un.addMatchingKeys(t,n,s.targetId))).next((()=>r.Kn.saveNamedQuery(t,e)))}))}class Lu{constructor(t){this.O=t,this.Ws=new Map,this.zs=new Map}getBundleMetadata(t,e){return qa.resolve(this.Ws.get(e))}saveBundleMetadata(t,e){var n;return this.Ws.set(e.id,{id:(n=e).id,version:n.version,createTime:qo(n.createTime)}),qa.resolve()}getNamedQuery(t,e){return qa.resolve(this.zs.get(e))}saveNamedQuery(t,e){return this.zs.set(e.name,function(t){return{name:t.name,query:dc(t.bundledQuery),readTime:qo(t.readTime)}}(e)),qa.resolve()}}class Mu{constructor(){this.overlays=new uo(br.comparator),this.Hs=new Map}getOverlay(t,e){return qa.resolve(this.overlays.get(e))}saveOverlays(t,e,n){return n.forEach((n=>{this.Yt(t,e,n)})),qa.resolve()}removeOverlaysForBatchId(t,e,n){const s=this.Hs.get(n);return void 0!==s&&(s.forEach((t=>this.overlays=this.overlays.remove(t))),this.Hs.delete(n)),qa.resolve()}getOverlaysForCollection(t,e,n){const s=new Map,r=e.length+1,i=new br(e.child("")),o=this.overlays.getIteratorFrom(i);for(;o.hasNext();){const t=o.getNext().value,i=t.getKey();if(!e.isPrefixOf(i.path))break;i.path.length===r&&t.largestBatchId>n&&s.set(t.getKey(),t)}return qa.resolve(s)}getOverlaysForCollectionGroup(t,e,n,s){let r=new uo(((t,e)=>t-e));const i=this.overlays.getIterator();for(;i.hasNext();){const t=i.getNext().value;if(t.getKey().getCollectionGroup()===e&&t.largestBatchId>n){let e=r.get(t.largestBatchId);null===e&&(e=new Map,r=r.insert(t.largestBatchId,e)),e.set(t.getKey(),t)}}const o=new Map,a=r.getIterator();for(;a.hasNext()&&(a.getNext().value.forEach(((t,e)=>o.set(e,t))),!(o.size>=s)););return qa.resolve(o)}Yt(t,e,n){if(null===n)return;const s=this.overlays.get(n.key);null!==s&&this.Hs.get(s.largestBatchId).delete(n.key),this.overlays=this.overlays.insert(n.key,new tc(e,n));let r=this.Hs.get(e);void 0===r&&(r=new Set,this.Hs.set(e,r)),r.add(n.key)}}class Pu{constructor(){this.Js=new fo(Fu.Ys),this.Xs=new fo(Fu.Zs)}isEmpty(){return this.Js.isEmpty()}addReference(t,e){const n=new Fu(t,e);this.Js=this.Js.add(n),this.Xs=this.Xs.add(n)}ti(t,e){t.forEach((t=>this.addReference(t,e)))}removeReference(t,e){this.ei(new Fu(t,e))}ni(t,e){t.forEach((t=>this.removeReference(t,e)))}si(t){const e=new br(new sr([])),n=new Fu(e,t),s=new Fu(e,t+1),r=[];return this.Xs.forEachInRange([n,s],(t=>{this.ei(t),r.push(t.key)})),r}ii(){this.Js.forEach((t=>this.ei(t)))}ei(t){this.Js=this.Js.delete(t),this.Xs=this.Xs.delete(t)}ri(t){const e=new br(new sr([])),n=new Fu(e,t),s=new Fu(e,t+1);let r=To();return this.Xs.forEachInRange([n,s],(t=>{r=r.add(t.key)})),r}containsKey(t){const e=new Fu(t,0),n=this.Js.firstAfterOrEqual(e);return null!==n&&t.isEqual(n.key)}}class Fu{constructor(t,e){this.key=t,this.oi=e}static Ys(t,e){return br.comparator(t.key,e.key)||Hs(t.oi,e.oi)}static Zs(t,e){return Hs(t.oi,e.oi)||br.comparator(t.key,e.key)}}class Vu{constructor(t,e){this.indexManager=t,this.referenceDelegate=e,this.gs=[],this.ci=1,this.ui=new fo(Fu.Ys)}checkEmpty(t){return qa.resolve(0===this.gs.length)}addMutationBatch(t,e,n,s){const r=this.ci;this.ci++,this.gs.length>0&&this.gs[this.gs.length-1];const i=new Ja(r,e,n,s);this.gs.push(i);for(const e of s)this.ui=this.ui.add(new Fu(e.key,r)),this.indexManager.addToCollectionParentIndex(t,e.key.path.popLast());return qa.resolve(i)}lookupMutationBatch(t,e){return qa.resolve(this.ai(e))}getNextMutationBatchAfterBatchId(t,e){const n=e+1,s=this.hi(n),r=s<0?0:s;return qa.resolve(this.gs.length>r?this.gs[r]:null)}getHighestUnacknowledgedBatchId(){return qa.resolve(0===this.gs.length?-1:this.ci-1)}getAllMutationBatches(t){return qa.resolve(this.gs.slice())}getAllMutationBatchesAffectingDocumentKey(t,e){const n=new Fu(e,0),s=new Fu(e,Number.POSITIVE_INFINITY),r=[];return this.ui.forEachInRange([n,s],(t=>{const e=this.ai(t.oi);r.push(e)})),qa.resolve(r)}getAllMutationBatchesAffectingDocumentKeys(t,e){let n=new fo(Hs);return e.forEach((t=>{const e=new Fu(t,0),s=new Fu(t,Number.POSITIVE_INFINITY);this.ui.forEachInRange([e,s],(t=>{n=n.add(t.oi)}))})),qa.resolve(this.li(n))}getAllMutationBatchesAffectingQuery(t,e){const n=e.path,s=n.length+1;let r=n;br.isDocumentKey(r)||(r=r.child(""));const i=new Fu(new br(r),0);let o=new fo(Hs);return this.ui.forEachWhile((t=>{const e=t.key.path;return!!n.isPrefixOf(e)&&(e.length===s&&(o=o.add(t.oi)),!0)}),i),qa.resolve(this.li(o))}li(t){const e=[];return t.forEach((t=>{const n=this.ai(t);null!==n&&e.push(n)})),e}removeMutationBatch(t,e){Ds(0===this.fi(e.batchId,"removed")),this.gs.shift();let n=this.ui;return qa.forEach(e.mutations,(s=>{const r=new Fu(s.key,e.batchId);return n=n.delete(r),this.referenceDelegate.markPotentiallyOrphaned(t,s.key)})).next((()=>{this.ui=n}))}Qe(t){}containsKey(t,e){const n=new Fu(e,0),s=this.ui.firstAfterOrEqual(n);return qa.resolve(e.isEqual(s&&s.key))}performConsistencyCheck(t){return this.gs.length,qa.resolve()}fi(t,e){return this.hi(t)}hi(t){return 0===this.gs.length?0:t-this.gs[0].batchId}ai(t){const e=this.hi(t);return e<0||e>=this.gs.length?null:this.gs[e]}}class Uu{constructor(t){this.di=t,this.docs=new uo(br.comparator),this.size=0}setIndexManager(t){this.indexManager=t}addEntry(t,e){const n=e.key,s=this.docs.get(n),r=s?s.size:0,i=this.di(e);return this.docs=this.docs.insert(n,{document:e.mutableCopy(),size:i}),this.size+=i-r,this.indexManager.addToCollectionParentIndex(t,n.path.popLast())}removeEntry(t){const e=this.docs.get(t);e&&(this.docs=this.docs.remove(t),this.size-=e.size)}getEntry(t,e){const n=this.docs.get(e);return qa.resolve(n?n.document.mutableCopy():Ur.newInvalidDocument(e))}getEntries(t,e){let n=yo();return e.forEach((t=>{const e=this.docs.get(t);n=n.insert(t,e?e.document.mutableCopy():Ur.newInvalidDocument(t))})),qa.resolve(n)}getAll(t,e,n){let s=yo();const r=new br(e.child("")),i=this.docs.getIteratorFrom(r);for(;i.hasNext();){const{key:t,value:{document:r}}=i.getNext();if(!e.isPrefixOf(t.path))break;t.path.length>e.length+1||r.readTime.compareTo(n)<=0||(s=s.insert(r.key,r.mutableCopy()))}return qa.resolve(s)}_i(t,e){return qa.forEach(this.docs,(t=>e(t)))}newChangeBuffer(t){return new qu(this)}getSize(t){return qa.resolve(this.size)}}class qu extends iu{constructor(t){super(),this.Tn=t}applyChanges(t){const e=[];return this.changes.forEach(((n,s)=>{s.isValidDocument()?e.push(this.Tn.addEntry(t,s)):this.Tn.removeEntry(n)})),qa.waitFor(e)}getFromCache(t,e){return this.Tn.getEntry(t,e)}getAllFromCache(t,e){return this.Tn.getEntries(t,e)}}class Bu{constructor(t){this.persistence=t,this.wi=new ru((t=>zr(t)),Qr),this.lastRemoteSnapshotVersion=Js.min(),this.highestTargetId=0,this.mi=0,this.gi=new Pu,this.targetCount=0,this.yi=zc.He()}forEachTarget(t,e){return this.wi.forEach(((t,n)=>e(n))),qa.resolve()}getLastRemoteSnapshotVersion(t){return qa.resolve(this.lastRemoteSnapshotVersion)}getHighestSequenceNumber(t){return qa.resolve(this.mi)}allocateTargetId(t){return this.highestTargetId=this.yi.next(),qa.resolve(this.highestTargetId)}setTargetsMetadata(t,e,n){return n&&(this.lastRemoteSnapshotVersion=n),e>this.mi&&(this.mi=e),qa.resolve()}Ze(t){this.wi.set(t.target,t);const e=t.targetId;e>this.highestTargetId&&(this.yi=new zc(e),this.highestTargetId=e),t.sequenceNumber>this.mi&&(this.mi=t.sequenceNumber)}addTargetData(t,e){return this.Ze(e),this.targetCount+=1,qa.resolve()}updateTargetData(t,e){return this.Ze(e),qa.resolve()}removeTargetData(t,e){return this.wi.delete(e.target),this.gi.si(e.targetId),this.targetCount-=1,qa.resolve()}removeTargets(t,e,n){let s=0;const r=[];return this.wi.forEach(((i,o)=>{o.sequenceNumber<=e&&null===n.get(o.targetId)&&(this.wi.delete(i),r.push(this.removeMatchingKeysForTargetId(t,o.targetId)),s++)})),qa.waitFor(r).next((()=>s))}getTargetCount(t){return qa.resolve(this.targetCount)}getTargetData(t,e){const n=this.wi.get(e)||null;return qa.resolve(n)}addMatchingKeys(t,e,n){return this.gi.ti(e,n),qa.resolve()}removeMatchingKeys(t,e,n){this.gi.ni(e,n);const s=this.persistence.referenceDelegate,r=[];return s&&e.forEach((e=>{r.push(s.markPotentiallyOrphaned(t,e))})),qa.waitFor(r)}removeMatchingKeysForTargetId(t,e){return this.gi.si(e),qa.resolve()}getMatchingKeysForTargetId(t,e){const n=this.gi.ri(e);return qa.resolve(n)}containsKey(t,e){return qa.resolve(this.gi.containsKey(e))}}class Ku{constructor(t,e){this.pi={},this.overlays={},this.Nn=new $s(0),this.xn=!1,this.xn=!0,this.referenceDelegate=t(this),this.Un=new Bu(this),this.indexManager=new Dc,this.qn=function(t){return new Uu(t)}((t=>this.referenceDelegate.Ii(t))),this.O=new nc(e),this.Kn=new Lu(this.O)}start(){return Promise.resolve()}shutdown(){return this.xn=!1,Promise.resolve()}get started(){return this.xn}setDatabaseDeletedListener(){}setNetworkEnabled(){}getIndexManager(t){return this.indexManager}getDocumentOverlayCache(t){let e=this.overlays[t.toKey()];return e||(e=new Mu,this.overlays[t.toKey()]=e),e}getMutationQueue(t,e){let n=this.pi[t.toKey()];return n||(n=new Vu(e,this.referenceDelegate),this.pi[t.toKey()]=n),n}getTargetCache(){return this.Un}getRemoteDocumentCache(){return this.qn}getBundleCache(){return this.Kn}runTransaction(t,e,n){xs("MemoryPersistence","Starting transaction:",t);const s=new ju(this.Nn.next());return this.referenceDelegate.Ei(),n(s).next((t=>this.referenceDelegate.Ti(s).next((()=>t)))).toPromise().then((t=>(s.raiseOnCommittedEvent(),t)))}Ai(t,e){return qa.or(Object.values(this.pi).map((n=>()=>n.containsKey(t,e))))}}class ju extends Ua{constructor(t){super(),this.currentSequenceNumber=t}}class Gu{constructor(t){this.persistence=t,this.Ri=new Pu,this.Pi=null}static bi(t){return new Gu(t)}get vi(){if(this.Pi)return this.Pi;throw Cs()}addReference(t,e,n){return this.Ri.addReference(n,e),this.vi.delete(n.toString()),qa.resolve()}removeReference(t,e,n){return this.Ri.removeReference(n,e),this.vi.add(n.toString()),qa.resolve()}markPotentiallyOrphaned(t,e){return this.vi.add(e.toString()),qa.resolve()}removeTarget(t,e){this.Ri.si(e.targetId).forEach((t=>this.vi.add(t.toString())));const n=this.persistence.getTargetCache();return n.getMatchingKeysForTargetId(t,e.targetId).next((t=>{t.forEach((t=>this.vi.add(t.toString())))})).next((()=>n.removeTargetData(t,e)))}Ei(){this.Pi=new Set}Ti(t){const e=this.persistence.getRemoteDocumentCache().newChangeBuffer();return qa.forEach(this.vi,(n=>{const s=br.fromPath(n);return this.Vi(t,s).next((t=>{t||e.removeEntry(s,Js.min())}))})).next((()=>(this.Pi=null,e.apply(t))))}updateLimboDocument(t,e){return this.Vi(t,e).next((t=>{t?this.vi.delete(e.toString()):this.vi.add(e.toString())}))}Ii(t){return 0}Vi(t,e){return qa.or([()=>qa.resolve(this.Ri.containsKey(e)),()=>this.persistence.getTargetCache().containsKey(t,e),()=>this.persistence.Ai(t,e)])}}function $u(t,e){return`firestore_clients_${t}_${e}`}function zu(t,e,n){let s=`firestore_mutations_${t}_${n}`;return e.isAuthenticated()&&(s+=`_${e.uid}`),s}function Qu(t,e){return`firestore_targets_${t}_${e}`}class Hu{constructor(t,e,n,s){this.user=t,this.batchId=e,this.state=n,this.error=s}static Si(t,e,n){const s=JSON.parse(n);let r,i="object"==typeof s&&-1!==["pending","acknowledged","rejected"].indexOf(s.state)&&(void 0===s.error||"object"==typeof s.error);return i&&s.error&&(i="string"==typeof s.error.message&&"string"==typeof s.error.code,i&&(r=new Ls(s.error.code,s.error.message))),i?new Hu(t,e,s.state,r):(As("SharedClientState",`Failed to parse mutation state for ID '${e}': ${n}`),null)}Di(){const t={state:this.state,updateTimeMs:Date.now()};return this.error&&(t.error={code:this.error.code,message:this.error.message}),JSON.stringify(t)}}class Wu{constructor(t,e,n){this.targetId=t,this.state=e,this.error=n}static Si(t,e){const n=JSON.parse(e);let s,r="object"==typeof n&&-1!==["not-current","current","rejected"].indexOf(n.state)&&(void 0===n.error||"object"==typeof n.error);return r&&n.error&&(r="string"==typeof n.error.message&&"string"==typeof n.error.code,r&&(s=new Ls(n.error.code,n.error.message))),r?new Wu(t,n.state,s):(As("SharedClientState",`Failed to parse target state for ID '${t}': ${e}`),null)}Di(){const t={state:this.state,updateTimeMs:Date.now()};return this.error&&(t.error={code:this.error.code,message:this.error.message}),JSON.stringify(t)}}class Yu{constructor(t,e){this.clientId=t,this.activeTargetIds=e}static Si(t,e){const n=JSON.parse(e);let s="object"==typeof n&&n.activeTargetIds instanceof Array,r=So();for(let t=0;s&&t<n.activeTargetIds.length;++t)s=Ir(n.activeTargetIds[t]),r=r.add(n.activeTargetIds[t]);return s?new Yu(t,r):(As("SharedClientState",`Failed to parse client data for instance '${t}': ${e}`),null)}}class Xu{constructor(t,e){this.clientId=t,this.onlineState=e}static Si(t){const e=JSON.parse(t);return"object"==typeof e&&-1!==["Unknown","Online","Offline"].indexOf(e.onlineState)&&"string"==typeof e.clientId?new Xu(e.clientId,e.onlineState):(As("SharedClientState",`Failed to parse online state: ${t}`),null)}}class Ju{constructor(){this.activeTargetIds=So()}Ci(t){this.activeTargetIds=this.activeTargetIds.add(t)}Ni(t){this.activeTargetIds=this.activeTargetIds.delete(t)}Di(){const t={activeTargetIds:this.activeTargetIds.toArray(),updateTimeMs:Date.now()};return JSON.stringify(t)}}class Zu{constructor(t,e,n,s,r){this.window=t,this.Sn=e,this.persistenceKey=n,this.xi=s,this.syncEngine=null,this.onlineStateHandler=null,this.sequenceNumberHandler=null,this.ki=this.Oi.bind(this),this.Mi=new uo(Hs),this.started=!1,this.$i=[];const i=n.replace(/[.*+?^${}()|[\]\\]/g,"\\$&");this.storage=this.window.localStorage,this.currentUser=r,this.Fi=$u(this.persistenceKey,this.xi),this.Bi=function(t){return`firestore_sequence_number_${t}`}(this.persistenceKey),this.Mi=this.Mi.insert(this.xi,new Ju),this.Li=new RegExp(`^firestore_clients_${i}_([^_]*)$`),this.Ui=new RegExp(`^firestore_mutations_${i}_(\\d+)(?:_(.*))?$`),this.qi=new RegExp(`^firestore_targets_${i}_(\\d+)$`),this.Ki=function(t){return`firestore_online_state_${t}`}(this.persistenceKey),this.Gi=function(t){return`firestore_bundle_loaded_${t}`}(this.persistenceKey),this.window.addEventListener("storage",this.ki)}static Vt(t){return!(!t||!t.localStorage)}async start(){const t=await this.syncEngine.ds();for(const e of t){if(e===this.xi)continue;const t=this.getItem($u(this.persistenceKey,e));if(t){const n=Yu.Si(e,t);n&&(this.Mi=this.Mi.insert(n.clientId,n))}}this.ji();const e=this.storage.getItem(this.Ki);if(e){const t=this.Qi(e);t&&this.Wi(t)}for(const t of this.$i)this.Oi(t);this.$i=[],this.window.addEventListener("pagehide",(()=>this.shutdown())),this.started=!0}writeSequenceNumber(t){this.setItem(this.Bi,JSON.stringify(t))}getAllActiveQueryTargets(){return this.zi(this.Mi)}isActiveQueryTarget(t){let e=!1;return this.Mi.forEach(((n,s)=>{s.activeTargetIds.has(t)&&(e=!0)})),e}addPendingMutation(t){this.Hi(t,"pending")}updateMutationState(t,e,n){this.Hi(t,e,n),this.Ji(t)}addLocalQueryTarget(t){let e="not-current";if(this.isActiveQueryTarget(t)){const n=this.storage.getItem(Qu(this.persistenceKey,t));if(n){const s=Wu.Si(t,n);s&&(e=s.state)}}return this.Yi.Ci(t),this.ji(),e}removeLocalQueryTarget(t){this.Yi.Ni(t),this.ji()}isLocalQueryTarget(t){return this.Yi.activeTargetIds.has(t)}clearQueryState(t){this.removeItem(Qu(this.persistenceKey,t))}updateQueryState(t,e,n){this.Xi(t,e,n)}handleUserChange(t,e,n){e.forEach((t=>{this.Ji(t)})),this.currentUser=t,n.forEach((t=>{this.addPendingMutation(t)}))}setOnlineState(t){this.Zi(t)}notifyBundleLoaded(){this.tr()}shutdown(){this.started&&(this.window.removeEventListener("storage",this.ki),this.removeItem(this.Fi),this.started=!1)}getItem(t){const e=this.storage.getItem(t);return xs("SharedClientState","READ",t,e),e}setItem(t,e){xs("SharedClientState","SET",t,e),this.storage.setItem(t,e)}removeItem(t){xs("SharedClientState","REMOVE",t),this.storage.removeItem(t)}Oi(t){const e=t;if(e.storageArea===this.storage){if(xs("SharedClientState","EVENT",e.key,e.newValue),e.key===this.Fi)return void As("Received WebStorage notification for local change. Another client might have garbage-collected our state");this.Sn.enqueueRetryable((async()=>{if(this.started){if(null!==e.key)if(this.Li.test(e.key)){if(null==e.newValue){const t=this.er(e.key);return this.nr(t,null)}{const t=this.sr(e.key,e.newValue);if(t)return this.nr(t.clientId,t)}}else if(this.Ui.test(e.key)){if(null!==e.newValue){const t=this.ir(e.key,e.newValue);if(t)return this.rr(t)}}else if(this.qi.test(e.key)){if(null!==e.newValue){const t=this.cr(e.key,e.newValue);if(t)return this.ur(t)}}else if(e.key===this.Ki){if(null!==e.newValue){const t=this.Qi(e.newValue);if(t)return this.Wi(t)}}else if(e.key===this.Bi){const t=function(t){let e=$s.A;if(null!=t)try{const n=JSON.parse(t);Ds("number"==typeof n),e=n}catch(t){As("SharedClientState","Failed to read sequence number from WebStorage",t)}return e}(e.newValue);t!==$s.A&&this.sequenceNumberHandler(t)}else if(e.key===this.Gi)return this.syncEngine.ar()}else this.$i.push(e)}))}}get Yi(){return this.Mi.get(this.xi)}ji(){this.setItem(this.Fi,this.Yi.Di())}Hi(t,e,n){const s=new Hu(this.currentUser,t,e,n),r=zu(this.persistenceKey,this.currentUser,t);this.setItem(r,s.Di())}Ji(t){const e=zu(this.persistenceKey,this.currentUser,t);this.removeItem(e)}Zi(t){const e={clientId:this.xi,onlineState:t};this.storage.setItem(this.Ki,JSON.stringify(e))}Xi(t,e,n){const s=Qu(this.persistenceKey,t),r=new Wu(t,e,n);this.setItem(s,r.Di())}tr(){this.setItem(this.Gi,"value-not-used")}er(t){const e=this.Li.exec(t);return e?e[1]:null}sr(t,e){const n=this.er(t);return Yu.Si(n,e)}ir(t,e){const n=this.Ui.exec(t),s=Number(n[1]),r=void 0!==n[2]?n[2]:null;return Hu.Si(new Is(r),s,e)}cr(t,e){const n=this.qi.exec(t),s=Number(n[1]);return Wu.Si(s,e)}Qi(t){return Xu.Si(t)}async rr(t){if(t.user.uid===this.currentUser.uid)return this.syncEngine.hr(t.batchId,t.state,t.error);xs("SharedClientState",`Ignoring mutation for non-active user ${t.user.uid}`)}ur(t){return this.syncEngine.lr(t.targetId,t.state,t.error)}nr(t,e){const n=e?this.Mi.insert(t,e):this.Mi.remove(t),s=this.zi(this.Mi),r=this.zi(n),i=[],o=[];return r.forEach((t=>{s.has(t)||i.push(t)})),s.forEach((t=>{r.has(t)||o.push(t)})),this.syncEngine.dr(i,o).then((()=>{this.Mi=n}))}Wi(t){this.Mi.get(t.clientId)&&this.onlineStateHandler(t.onlineState)}zi(t){let e=So();return t.forEach(((t,n)=>{e=e.unionWith(n.activeTargetIds)})),e}}class th{constructor(){this._r=new Ju,this.wr={},this.onlineStateHandler=null,this.sequenceNumberHandler=null}addPendingMutation(t){}updateMutationState(t,e,n){}addLocalQueryTarget(t){return this._r.Ci(t),this.wr[t]||"not-current"}updateQueryState(t,e,n){this.wr[t]=e}removeLocalQueryTarget(t){this._r.Ni(t)}isLocalQueryTarget(t){return this._r.activeTargetIds.has(t)}clearQueryState(t){delete this.wr[t]}getAllActiveQueryTargets(){return this._r.activeTargetIds}isActiveQueryTarget(t){return this._r.activeTargetIds.has(t)}start(){return this._r=new Ju,Promise.resolve()}handleUserChange(t,e,n){}setOnlineState(t){}shutdown(){}writeSequenceNumber(t){}notifyBundleLoaded(){}}class eh{mr(t){}shutdown(){}}class nh{constructor(){this.gr=()=>this.yr(),this.pr=()=>this.Ir(),this.Er=[],this.Tr()}mr(t){this.Er.push(t)}shutdown(){window.removeEventListener("online",this.gr),window.removeEventListener("offline",this.pr)}Tr(){window.addEventListener("online",this.gr),window.addEventListener("offline",this.pr)}yr(){xs("ConnectivityMonitor","Network connectivity changed: AVAILABLE");for(const t of this.Er)t(0)}Ir(){xs("ConnectivityMonitor","Network connectivity changed: UNAVAILABLE");for(const t of this.Er)t(1)}static Vt(){return"undefined"!=typeof window&&void 0!==window.addEventListener&&void 0!==window.removeEventListener}}const sh={BatchGetDocuments:"batchGet",Commit:"commit",RunQuery:"runQuery"};class rh{constructor(t){this.Ar=t.Ar,this.Rr=t.Rr}Pr(t){this.br=t}vr(t){this.Vr=t}onMessage(t){this.Sr=t}close(){this.Rr()}send(t){this.Ar(t)}Dr(){this.br()}Cr(t){this.Vr(t)}Nr(t){this.Sr(t)}}class ih extends class{constructor(t){this.databaseInfo=t,this.databaseId=t.databaseId;const e=t.ssl?"https":"http";this.kr=e+"://"+t.host,this.Or="projects/"+this.databaseId.projectId+"/databases/"+this.databaseId.database+"/documents"}Mr(t,e,n,s,r){const i=this.$r(t,e);xs("RestConnection","Sending: ",i,n);const o={};return this.Fr(o,s,r),this.Br(t,i,o,n).then((t=>(xs("RestConnection","Received: ",t),t)),(e=>{throw _s("RestConnection",`${t} failed with error: `,e,"url: ",i,"request:",n),e}))}Lr(t,e,n,s,r){return this.Mr(t,e,n,s,r)}Fr(t,e,n){t["X-Goog-Api-Client"]="gl-js/ fire/"+bs,t["Content-Type"]="text/plain",this.databaseInfo.appId&&(t["X-Firebase-GMPID"]=this.databaseInfo.appId),e&&e.headers.forEach(((e,n)=>t[n]=e)),n&&n.headers.forEach(((e,n)=>t[n]=e))}$r(t,e){const n=sh[t];return`${this.kr}/v1/${e}:${n}`}}{constructor(t){super(t),this.forceLongPolling=t.forceLongPolling,this.autoDetectLongPolling=t.autoDetectLongPolling,this.useFetchStreams=t.useFetchStreams}Br(t,e,n,s){return new Promise(((r,i)=>{const o=new ys;o.listenOnce(ds.COMPLETE,(()=>{try{switch(o.getLastErrorCode()){case ls.NO_ERROR:const e=o.getResponseJson();xs("Connection","XHR received:",JSON.stringify(e)),r(e);break;case ls.TIMEOUT:xs("Connection",'RPC "'+t+'" timed out'),i(new Ls(Rs.DEADLINE_EXCEEDED,"Request time out"));break;case ls.HTTP_ERROR:const n=o.getStatus();if(xs("Connection",'RPC "'+t+'" failed with status:',n,"response text:",o.getResponseText()),n>0){const t=o.getResponseJson().error;if(t&&t.status&&t.message){const e=function(t){const e=t.toLowerCase().replace(/_/g,"-");return Object.values(Rs).indexOf(e)>=0?e:Rs.UNKNOWN}(t.status);i(new Ls(e,t.message))}else i(new Ls(Rs.UNKNOWN,"Server responded with status "+o.getStatus()))}else i(new Ls(Rs.UNAVAILABLE,"Connection failed."));break;default:Cs()}}finally{xs("Connection",'RPC "'+t+'" completed.')}}));const a=JSON.stringify(s);o.send(e,"POST",a,n,15)}))}Ur(t,e,n){const s=[this.kr,"/","google.firestore.v1.Firestore","/",t,"/channel"],r=us(),i=hs(),o={httpSessionIdParam:"gsessionid",initMessageHeaders:{},messageUrlParams:{database:`projects/${this.databaseId.projectId}/databases/${this.databaseId.database}`},sendRawJson:!0,supportsCrossDomainXhr:!0,internalChannelParams:{forwardChannelRequestTimeoutMs:6e5},forceLongPolling:this.forceLongPolling,detectBufferingProxy:this.autoDetectLongPolling};this.useFetchStreams&&(o.xmlHttpFactory=new gs({})),this.Fr(o.initMessageHeaders,e,n),(0,a.uI)()||(0,a.b$)()||(0,a.d)()||(0,a.w1)()||(0,a.Mn)()||(0,a.ru)()||(o.httpHeadersOverwriteParam="$httpHeaders");const c=s.join("");xs("Connection","Creating WebChannel: "+c,o);const u=r.createWebChannel(c,o);let h=!1,l=!1;const d=new rh({Ar:t=>{l?xs("Connection","Not sending because WebChannel is closed:",t):(h||(xs("Connection","Opening WebChannel transport."),u.open(),h=!0),xs("Connection","WebChannel sending:",t),u.send(t))},Rr:()=>u.close()}),f=(t,e,n)=>{t.listen(e,(t=>{try{n(t)}catch(t){setTimeout((()=>{throw t}),0)}}))};return f(u,ps.EventType.OPEN,(()=>{l||xs("Connection","WebChannel transport opened.")})),f(u,ps.EventType.CLOSE,(()=>{l||(l=!0,xs("Connection","WebChannel transport closed"),d.Cr())})),f(u,ps.EventType.ERROR,(t=>{l||(l=!0,_s("Connection","WebChannel transport errored:",t),d.Cr(new Ls(Rs.UNAVAILABLE,"The operation could not be completed")))})),f(u,ps.EventType.MESSAGE,(t=>{var e;if(!l){const n=t.data[0];Ds(!!n);const s=n,r=s.error||(null===(e=s[0])||void 0===e?void 0:e.error);if(r){xs("Connection","WebChannel received error:",r);const t=r.status;let e=function(t){const e=io[t];if(void 0!==e)return co(e)}(t),n=r.message;void 0===e&&(e=Rs.INTERNAL,n="Unknown error status: "+t+" with message "+r.message),l=!0,d.Cr(new Ls(e,n)),u.close()}else xs("Connection","WebChannel received:",n),d.Nr(n)}})),f(i,fs.STAT_EVENT,(t=>{t.stat===ms.PROXY?xs("Connection","Detected buffering proxy"):t.stat===ms.NOPROXY&&xs("Connection","Detected no buffering proxy")})),setTimeout((()=>{d.Dr()}),0),d}}function oh(){return"undefined"!=typeof window?window:null}function ah(){return"undefined"!=typeof document?document:null}function ch(t){return new Po(t,!0)}class uh{constructor(t,e,n=1e3,s=1.5,r=6e4){this.Sn=t,this.timerId=e,this.qr=n,this.Kr=s,this.Gr=r,this.jr=0,this.Qr=null,this.Wr=Date.now(),this.reset()}reset(){this.jr=0}zr(){this.jr=this.Gr}Hr(t){this.cancel();const e=Math.floor(this.jr+this.Jr()),n=Math.max(0,Date.now()-this.Wr),s=Math.max(0,e-n);s>0&&xs("ExponentialBackoff",`Backing off for ${s} ms (base delay: ${this.jr} ms, delay with jitter: ${e} ms, last attempt: ${n} ms ago)`),this.Qr=this.Sn.enqueueAfterDelay(this.timerId,s,(()=>(this.Wr=Date.now(),t()))),this.jr*=this.Kr,this.jr<this.qr&&(this.jr=this.qr),this.jr>this.Gr&&(this.jr=this.Gr)}Yr(){null!==this.Qr&&(this.Qr.skipDelay(),this.Qr=null)}cancel(){null!==this.Qr&&(this.Qr.cancel(),this.Qr=null)}Jr(){return(Math.random()-.5)*this.jr}}class hh{constructor(t,e,n,s,r,i,o,a){this.Sn=t,this.Xr=n,this.Zr=s,this.eo=r,this.authCredentialsProvider=i,this.appCheckCredentialsProvider=o,this.listener=a,this.state=0,this.no=0,this.so=null,this.io=null,this.stream=null,this.ro=new uh(t,e)}oo(){return 1===this.state||5===this.state||this.co()}co(){return 2===this.state||3===this.state}start(){4!==this.state?this.auth():this.uo()}async stop(){this.oo()&&await this.close(0)}ao(){this.state=0,this.ro.reset()}ho(){this.co()&&null===this.so&&(this.so=this.Sn.enqueueAfterDelay(this.Xr,6e4,(()=>this.lo())))}fo(t){this._o(),this.stream.send(t)}async lo(){if(this.co())return this.close(0)}_o(){this.so&&(this.so.cancel(),this.so=null)}wo(){this.io&&(this.io.cancel(),this.io=null)}async close(t,e){this._o(),this.wo(),this.ro.cancel(),this.no++,4!==t?this.ro.reset():e&&e.code===Rs.RESOURCE_EXHAUSTED?(As(e.toString()),As("Using maximum backoff delay to prevent overloading the backend."),this.ro.zr()):e&&e.code===Rs.UNAUTHENTICATED&&3!==this.state&&(this.authCredentialsProvider.invalidateToken(),this.appCheckCredentialsProvider.invalidateToken()),null!==this.stream&&(this.mo(),this.stream.close(),this.stream=null),this.state=t,await this.listener.vr(e)}mo(){}auth(){this.state=1;const t=this.yo(this.no),e=this.no;Promise.all([this.authCredentialsProvider.getToken(),this.appCheckCredentialsProvider.getToken()]).then((([t,n])=>{this.no===e&&this.po(t,n)}),(e=>{t((()=>{const t=new Ls(Rs.UNKNOWN,"Fetching auth token failed: "+e.message);return this.Io(t)}))}))}po(t,e){const n=this.yo(this.no);this.stream=this.Eo(t,e),this.stream.Pr((()=>{n((()=>(this.state=2,this.io=this.Sn.enqueueAfterDelay(this.Zr,1e4,(()=>(this.co()&&(this.state=3),Promise.resolve()))),this.listener.Pr())))})),this.stream.vr((t=>{n((()=>this.Io(t)))})),this.stream.onMessage((t=>{n((()=>this.onMessage(t)))}))}uo(){this.state=5,this.ro.Hr((async()=>{this.state=0,this.start()}))}Io(t){return xs("PersistentStream",`close with error: ${t}`),this.stream=null,this.close(4,t)}yo(t){return e=>{this.Sn.enqueueAndForget((()=>this.no===t?e():(xs("PersistentStream","stream callback skipped by getCloseGuardedDispatcher."),Promise.resolve())))}}}class lh extends hh{constructor(t,e,n,s,r,i){super(t,"listen_stream_connection_backoff","listen_stream_idle","health_check_timeout",e,n,s,i),this.O=r}Eo(t,e){return this.eo.Ur("Listen",t,e)}onMessage(t){this.ro.reset();const e=function(t,e){let n;if("targetChange"in e){e.targetChange;const s=function(t){return"NO_CHANGE"===t?0:"ADD"===t?1:"REMOVE"===t?2:"CURRENT"===t?3:"RESET"===t?4:Cs()}(e.targetChange.targetChangeType||"NO_CHANGE"),r=e.targetChange.targetIds||[],i=function(t,e){return t.N?(Ds(void 0===e||"string"==typeof e),cr.fromBase64String(e||"")):(Ds(void 0===e||e instanceof Uint8Array),cr.fromUint8Array(e||new Uint8Array))}(t,e.targetChange.resumeToken),o=e.targetChange.cause,a=o&&function(t){const e=void 0===t.code?Rs.UNKNOWN:co(t.code);return new Ls(e,t.message||"")}(o);n=new Co(s,r,i,a||null)}else if("documentChange"in e){e.documentChange;const s=e.documentChange;s.document,s.document.name,s.document.updateTime;const r=Go(t,s.document.name),i=qo(s.document.updateTime),o=new Fr({mapValue:{fields:s.document.fields}}),a=Ur.newFoundDocument(r,i,o),c=s.targetIds||[],u=s.removedTargetIds||[];n=new _o(c,u,a.key,a)}else if("documentDelete"in e){e.documentDelete;const s=e.documentDelete;s.document;const r=Go(t,s.document),i=s.readTime?qo(s.readTime):Js.min(),o=Ur.newNoDocument(r,i),a=s.removedTargetIds||[];n=new _o([],a,o.key,o)}else if("documentRemove"in e){e.documentRemove;const s=e.documentRemove;s.document;const r=Go(t,s.document),i=s.removedTargetIds||[];n=new _o([],i,r,null)}else{if(!("filter"in e))return Cs();{e.filter;const t=e.filter;t.targetId;const s=t.count||0,r=new ro(s),i=t.targetId;n=new No(i,r)}}return n}(this.O,t),n=function(t){if(!("targetChange"in t))return Js.min();const e=t.targetChange;return e.targetIds&&e.targetIds.length?Js.min():e.readTime?qo(e.readTime):Js.min()}(t);return this.listener.To(e,n)}Ao(t){const e={};e.database=Qo(this.O),e.addTarget=function(t,e){let n;const s=e.target;return n=Hr(s)?{documents:Zo(t,s)}:{query:ta(t,s)},n.targetId=e.targetId,e.resumeToken.approximateByteSize()>0?n.resumeToken=Vo(t,e.resumeToken):e.snapshotVersion.compareTo(Js.min())>0&&(n.readTime=Fo(t,e.snapshotVersion.toTimestamp())),n}(this.O,t);const n=function(t,e){const n=function(t,e){switch(e){case 0:return null;case 1:return"existence-filter-mismatch";case 2:return"limbo-document";default:return Cs()}}(0,e.purpose);return null==n?null:{"goog-listen-tags":n}}(this.O,t);n&&(e.labels=n),this.fo(e)}Ro(t){const e={};e.database=Qo(this.O),e.removeTarget=t,this.fo(e)}}class dh extends hh{constructor(t,e,n,s,r,i){super(t,"write_stream_connection_backoff","write_stream_idle","health_check_timeout",e,n,s,i),this.O=r,this.Po=!1}get bo(){return this.Po}start(){this.Po=!1,this.lastStreamToken=void 0,super.start()}mo(){this.Po&&this.vo([])}Eo(t,e){return this.eo.Ur("Write",t,e)}onMessage(t){if(Ds(!!t.streamToken),this.lastStreamToken=t.streamToken,this.Po){this.ro.reset();const e=function(t,e){return t&&t.length>0?(Ds(void 0!==e),t.map((t=>function(t,e){let n=t.updateTime?qo(t.updateTime):qo(e);return n.isEqual(Js.min())&&(n=qo(e)),new Ki(n,t.transformResults||[])}(t,e)))):[]}(t.writeResults,t.commitTime),n=qo(t.commitTime);return this.listener.Vo(n,e)}return Ds(!t.writeResults||0===t.writeResults.length),this.Po=!0,this.listener.So()}Do(){const t={};t.database=Qo(this.O),this.fo(t)}vo(t){const e={streamToken:this.lastStreamToken,writes:t.map((t=>Xo(this.O,t)))};this.fo(e)}}class fh extends class{}{constructor(t,e,n,s){super(),this.authCredentials=t,this.appCheckCredentials=e,this.eo=n,this.O=s,this.Co=!1}No(){if(this.Co)throw new Ls(Rs.FAILED_PRECONDITION,"The client has already been terminated.")}Mr(t,e,n){return this.No(),Promise.all([this.authCredentials.getToken(),this.appCheckCredentials.getToken()]).then((([s,r])=>this.eo.Mr(t,e,n,s,r))).catch((t=>{throw"FirebaseError"===t.name?(t.code===Rs.UNAUTHENTICATED&&(this.authCredentials.invalidateToken(),this.appCheckCredentials.invalidateToken()),t):new Ls(Rs.UNKNOWN,t.toString())}))}Lr(t,e,n){return this.No(),Promise.all([this.authCredentials.getToken(),this.appCheckCredentials.getToken()]).then((([s,r])=>this.eo.Lr(t,e,n,s,r))).catch((t=>{throw"FirebaseError"===t.name?(t.code===Rs.UNAUTHENTICATED&&(this.authCredentials.invalidateToken(),this.appCheckCredentials.invalidateToken()),t):new Ls(Rs.UNKNOWN,t.toString())}))}terminate(){this.Co=!0}}class mh{constructor(t,e){this.asyncQueue=t,this.onlineStateHandler=e,this.state="Unknown",this.xo=0,this.ko=null,this.Oo=!0}Mo(){0===this.xo&&(this.$o("Unknown"),this.ko=this.asyncQueue.enqueueAfterDelay("online_state_timeout",1e4,(()=>(this.ko=null,this.Fo("Backend didn't respond within 10 seconds."),this.$o("Offline"),Promise.resolve()))))}Bo(t){"Online"===this.state?this.$o("Unknown"):(this.xo++,this.xo>=1&&(this.Lo(),this.Fo(`Connection failed 1 times. Most recent error: ${t.toString()}`),this.$o("Offline")))}set(t){this.Lo(),this.xo=0,"Online"===t&&(this.Oo=!1),this.$o(t)}$o(t){t!==this.state&&(this.state=t,this.onlineStateHandler(t))}Fo(t){const e=`Could not reach Cloud Firestore backend. ${t}\nThis typically indicates that your device does not have a healthy Internet connection at the moment. The client will operate in offline mode until it is able to successfully connect to the backend.`;this.Oo?(As(e),this.Oo=!1):xs("OnlineStateTracker",e)}Lo(){null!==this.ko&&(this.ko.cancel(),this.ko=null)}}class gh{constructor(t,e,n,s,r){this.localStore=t,this.datastore=e,this.asyncQueue=n,this.remoteSyncer={},this.Uo=[],this.qo=new Map,this.Ko=new Set,this.Go=[],this.jo=r,this.jo.mr((t=>{n.enqueueAndForget((async()=>{Sh(this)&&(xs("RemoteStore","Restarting streams for network reachability change."),await async function(t){const e=Os(t);e.Ko.add(4),await yh(e),e.Qo.set("Unknown"),e.Ko.delete(4),await ph(e)}(this))}))})),this.Qo=new mh(n,s)}}async function ph(t){if(Sh(t))for(const e of t.Go)await e(!0)}async function yh(t){for(const e of t.Go)await e(!1)}function wh(t,e){const n=Os(t);n.qo.has(e.targetId)||(n.qo.set(e.targetId,e),Eh(n)?Th(n):Kh(n).co()&&Ih(n,e))}function vh(t,e){const n=Os(t),s=Kh(n);n.qo.delete(e),s.co()&&bh(n,e),0===n.qo.size&&(s.co()?s.ho():Sh(n)&&n.Qo.set("Unknown"))}function Ih(t,e){t.Wo.Z(e.targetId),Kh(t).Ao(e)}function bh(t,e){t.Wo.Z(e),Kh(t).Ro(e)}function Th(t){t.Wo=new ko({getRemoteKeysForTarget:e=>t.remoteSyncer.getRemoteKeysForTarget(e),Tt:e=>t.qo.get(e)||null}),Kh(t).start(),t.Qo.Mo()}function Eh(t){return Sh(t)&&!Kh(t).oo()&&t.qo.size>0}function Sh(t){return 0===Os(t).Ko.size}function xh(t){t.Wo=void 0}async function Ah(t){t.qo.forEach(((e,n)=>{Ih(t,e)}))}async function _h(t,e){xh(t),Eh(t)?(t.Qo.Bo(e),Th(t)):t.Qo.set("Unknown")}async function Nh(t,e,n){if(t.Qo.set("Online"),e instanceof Co&&2===e.state&&e.cause)try{await async function(t,e){const n=e.cause;for(const s of e.targetIds)t.qo.has(s)&&(await t.remoteSyncer.rejectListen(s,n),t.qo.delete(s),t.Wo.removeTarget(s))}(t,e)}catch(n){xs("RemoteStore","Failed to remove targets %s: %s ",e.targetIds.join(","),n),await Ch(t,n)}else if(e instanceof _o?t.Wo.ct(e):e instanceof No?t.Wo._t(e):t.Wo.ht(e),!n.isEqual(Js.min()))try{const e=await xu(t.localStore);n.compareTo(e)>=0&&await function(t,e){const n=t.Wo.yt(e);return n.targetChanges.forEach(((n,s)=>{if(n.resumeToken.approximateByteSize()>0){const r=t.qo.get(s);r&&t.qo.set(s,r.withResumeToken(n.resumeToken,e))}})),n.targetMismatches.forEach((e=>{const n=t.qo.get(e);if(!n)return;t.qo.set(e,n.withResumeToken(cr.EMPTY_BYTE_STRING,n.snapshotVersion)),bh(t,e);const s=new ec(n.target,e,1,n.sequenceNumber);Ih(t,s)})),t.remoteSyncer.applyRemoteEvent(n)}(t,n)}catch(e){xs("RemoteStore","Failed to raise snapshot:",e),await Ch(t,e)}}async function Ch(t,e,n){if(!$a(e))throw e;t.Ko.add(1),await yh(t),t.Qo.set("Offline"),n||(n=()=>xu(t.localStore)),t.asyncQueue.enqueueRetryable((async()=>{xs("RemoteStore","Retrying IndexedDB access"),await n(),t.Ko.delete(1),await ph(t)}))}function Dh(t,e){return e().catch((n=>Ch(t,n,e)))}async function kh(t){const e=Os(t),n=jh(e);let s=e.Uo.length>0?e.Uo[e.Uo.length-1].batchId:-1;for(;Oh(e);)try{const t=await _u(e.localStore,s);if(null===t){0===e.Uo.length&&n.ho();break}s=t.batchId,Rh(e,t)}catch(t){await Ch(e,t)}Lh(e)&&Mh(e)}function Oh(t){return Sh(t)&&t.Uo.length<10}function Rh(t,e){t.Uo.push(e);const n=jh(t);n.co()&&n.bo&&n.vo(e.mutations)}function Lh(t){return Sh(t)&&!jh(t).oo()&&t.Uo.length>0}function Mh(t){jh(t).start()}async function Ph(t){jh(t).Do()}async function Fh(t){const e=jh(t);for(const n of t.Uo)e.vo(n.mutations)}async function Vh(t,e,n){const s=t.Uo.shift(),r=Za.from(s,e,n);await Dh(t,(()=>t.remoteSyncer.applySuccessfulWrite(r))),await kh(t)}async function Uh(t,e){e&&jh(t).bo&&await async function(t,e){if(ao(n=e.code)&&n!==Rs.ABORTED){const n=t.Uo.shift();jh(t).ao(),await Dh(t,(()=>t.remoteSyncer.rejectFailedWrite(n.batchId,e))),await kh(t)}var n}(t,e),Lh(t)&&Mh(t)}async function qh(t,e){const n=Os(t);n.asyncQueue.verifyOperationInProgress(),xs("RemoteStore","RemoteStore received new credentials");const s=Sh(n);n.Ko.add(3),await yh(n),s&&n.Qo.set("Unknown"),await n.remoteSyncer.handleCredentialChange(e),n.Ko.delete(3),await ph(n)}async function Bh(t,e){const n=Os(t);e?(n.Ko.delete(2),await ph(n)):e||(n.Ko.add(2),await yh(n),n.Qo.set("Unknown"))}function Kh(t){return t.zo||(t.zo=function(t,e,n){const s=Os(t);return s.No(),new lh(e,s.eo,s.authCredentials,s.appCheckCredentials,s.O,n)}(t.datastore,t.asyncQueue,{Pr:Ah.bind(null,t),vr:_h.bind(null,t),To:Nh.bind(null,t)}),t.Go.push((async e=>{e?(t.zo.ao(),Eh(t)?Th(t):t.Qo.set("Unknown")):(await t.zo.stop(),xh(t))}))),t.zo}function jh(t){return t.Ho||(t.Ho=function(t,e,n){const s=Os(t);return s.No(),new dh(e,s.eo,s.authCredentials,s.appCheckCredentials,s.O,n)}(t.datastore,t.asyncQueue,{Pr:Ph.bind(null,t),vr:Uh.bind(null,t),So:Fh.bind(null,t),Vo:Vh.bind(null,t)}),t.Go.push((async e=>{e?(t.Ho.ao(),await kh(t)):(await t.Ho.stop(),t.Uo.length>0&&(xs("RemoteStore",`Stopping write stream with ${t.Uo.length} pending writes`),t.Uo=[]))}))),t.Ho}class Gh{constructor(t,e,n,s,r){this.asyncQueue=t,this.timerId=e,this.targetTimeMs=n,this.op=s,this.removalCallback=r,this.deferred=new Ms,this.then=this.deferred.promise.then.bind(this.deferred.promise),this.deferred.promise.catch((t=>{}))}static createAndSchedule(t,e,n,s,r){const i=Date.now()+n,o=new Gh(t,e,i,s,r);return o.start(n),o}start(t){this.timerHandle=setTimeout((()=>this.handleDelayElapsed()),t)}skipDelay(){return this.handleDelayElapsed()}cancel(t){null!==this.timerHandle&&(this.clearTimeout(),this.deferred.reject(new Ls(Rs.CANCELLED,"Operation cancelled"+(t?": "+t:""))))}handleDelayElapsed(){this.asyncQueue.enqueueAndForget((()=>null!==this.timerHandle?(this.clearTimeout(),this.op().then((t=>this.deferred.resolve(t)))):Promise.resolve()))}clearTimeout(){null!==this.timerHandle&&(this.removalCallback(this),clearTimeout(this.timerHandle),this.timerHandle=null)}}function $h(t,e){if(As("AsyncQueue",`${e}: ${t}`),$a(t))return new Ls(Rs.UNAVAILABLE,`${e}: ${t}`);throw t}class zh{constructor(t){this.comparator=t?(e,n)=>t(e,n)||br.comparator(e.key,n.key):(t,e)=>br.comparator(t.key,e.key),this.keyedMap=vo(),this.sortedSet=new uo(this.comparator)}static emptySet(t){return new zh(t.comparator)}has(t){return null!=this.keyedMap.get(t)}get(t){return this.keyedMap.get(t)}first(){return this.sortedSet.minKey()}last(){return this.sortedSet.maxKey()}isEmpty(){return this.sortedSet.isEmpty()}indexOf(t){const e=this.keyedMap.get(t);return e?this.sortedSet.indexOf(e):-1}get size(){return this.sortedSet.size}forEach(t){this.sortedSet.inorderTraversal(((e,n)=>(t(e),!1)))}add(t){const e=this.delete(t.key);return e.copy(e.keyedMap.insert(t.key,t),e.sortedSet.insert(t,null))}delete(t){const e=this.get(t);return e?this.copy(this.keyedMap.remove(t),this.sortedSet.remove(e)):this}isEqual(t){if(!(t instanceof zh))return!1;if(this.size!==t.size)return!1;const e=this.sortedSet.getIterator(),n=t.sortedSet.getIterator();for(;e.hasNext();){const t=e.getNext().key,s=n.getNext().key;if(!t.isEqual(s))return!1}return!0}toString(){const t=[];return this.forEach((e=>{t.push(e.toString())})),0===t.length?"DocumentSet ()":"DocumentSet (\n  "+t.join("  \n")+"\n)"}copy(t,e){const n=new zh;return n.comparator=this.comparator,n.keyedMap=t,n.sortedSet=e,n}}class Qh{constructor(){this.Jo=new uo(br.comparator)}track(t){const e=t.doc.key,n=this.Jo.get(e);n?0!==t.type&&3===n.type?this.Jo=this.Jo.insert(e,t):3===t.type&&1!==n.type?this.Jo=this.Jo.insert(e,{type:n.type,doc:t.doc}):2===t.type&&2===n.type?this.Jo=this.Jo.insert(e,{type:2,doc:t.doc}):2===t.type&&0===n.type?this.Jo=this.Jo.insert(e,{type:0,doc:t.doc}):1===t.type&&0===n.type?this.Jo=this.Jo.remove(e):1===t.type&&2===n.type?this.Jo=this.Jo.insert(e,{type:1,doc:n.doc}):0===t.type&&1===n.type?this.Jo=this.Jo.insert(e,{type:2,doc:t.doc}):Cs():this.Jo=this.Jo.insert(e,t)}Yo(){const t=[];return this.Jo.inorderTraversal(((e,n)=>{t.push(n)})),t}}class Hh{constructor(t,e,n,s,r,i,o,a){this.query=t,this.docs=e,this.oldDocs=n,this.docChanges=s,this.mutatedKeys=r,this.fromCache=i,this.syncStateChanged=o,this.excludesMetadataChanges=a}static fromInitialDocuments(t,e,n,s){const r=[];return e.forEach((t=>{r.push({type:0,doc:t})})),new Hh(t,e,zh.emptySet(e),r,n,s,!0,!1)}get hasPendingWrites(){return!this.mutatedKeys.isEmpty()}isEqual(t){if(!(this.fromCache===t.fromCache&&this.syncStateChanged===t.syncStateChanged&&this.mutatedKeys.isEqual(t.mutatedKeys)&&Ii(this.query,t.query)&&this.docs.isEqual(t.docs)&&this.oldDocs.isEqual(t.oldDocs)))return!1;const e=this.docChanges,n=t.docChanges;if(e.length!==n.length)return!1;for(let t=0;t<e.length;t++)if(e[t].type!==n[t].type||!e[t].doc.isEqual(n[t].doc))return!1;return!0}}class Wh{constructor(){this.Xo=void 0,this.listeners=[]}}class Yh{constructor(){this.queries=new ru((t=>bi(t)),Ii),this.onlineState="Unknown",this.Zo=new Set}}async function Xh(t,e){const n=Os(t),s=e.query;let r=!1,i=n.queries.get(s);if(i||(r=!0,i=new Wh),r)try{i.Xo=await n.onListen(s)}catch(t){const n=$h(t,`Initialization of query '${Ti(e.query)}' failed`);return void e.onError(n)}n.queries.set(s,i),i.listeners.push(e),e.tc(n.onlineState),i.Xo&&e.ec(i.Xo)&&el(n)}async function Jh(t,e){const n=Os(t),s=e.query;let r=!1;const i=n.queries.get(s);if(i){const t=i.listeners.indexOf(e);t>=0&&(i.listeners.splice(t,1),r=0===i.listeners.length)}if(r)return n.queries.delete(s),n.onUnlisten(s)}function Zh(t,e){const n=Os(t);let s=!1;for(const t of e){const e=t.query,r=n.queries.get(e);if(r){for(const e of r.listeners)e.ec(t)&&(s=!0);r.Xo=t}}s&&el(n)}function tl(t,e,n){const s=Os(t),r=s.queries.get(e);if(r)for(const t of r.listeners)t.onError(n);s.queries.delete(e)}function el(t){t.Zo.forEach((t=>{t.next()}))}class nl{constructor(t,e,n){this.query=t,this.nc=e,this.sc=!1,this.ic=null,this.onlineState="Unknown",this.options=n||{}}ec(t){if(!this.options.includeMetadataChanges){const e=[];for(const n of t.docChanges)3!==n.type&&e.push(n);t=new Hh(t.query,t.docs,t.oldDocs,e,t.mutatedKeys,t.fromCache,t.syncStateChanged,!0)}let e=!1;return this.sc?this.rc(t)&&(this.nc.next(t),e=!0):this.oc(t,this.onlineState)&&(this.cc(t),e=!0),this.ic=t,e}onError(t){this.nc.error(t)}tc(t){this.onlineState=t;let e=!1;return this.ic&&!this.sc&&this.oc(this.ic,t)&&(this.cc(this.ic),e=!0),e}oc(t,e){if(!t.fromCache)return!0;const n="Offline"!==e;return!(this.options.uc&&n||t.docs.isEmpty()&&"Offline"!==e)}rc(t){if(t.docChanges.length>0)return!0;const e=this.ic&&this.ic.hasPendingWrites!==t.hasPendingWrites;return!(!t.syncStateChanged&&!e)&&!0===this.options.includeMetadataChanges}cc(t){t=Hh.fromInitialDocuments(t.query,t.docs,t.mutatedKeys,t.fromCache),this.sc=!0,this.nc.next(t)}}class sl{constructor(t,e){this.payload=t,this.byteLength=e}ac(){return"metadata"in this.payload}}class rl{constructor(t){this.O=t}Gs(t){return Go(this.O,t)}js(t){return t.metadata.exists?Yo(this.O,t.document,!1):Ur.newNoDocument(this.Gs(t.metadata.name),this.Qs(t.metadata.readTime))}Qs(t){return qo(t)}}class il{constructor(t,e,n){this.hc=t,this.localStore=e,this.O=n,this.queries=[],this.documents=[],this.progress=ol(t)}lc(t){this.progress.bytesLoaded+=t.byteLength;let e=this.progress.documentsLoaded;return t.payload.namedQuery?this.queries.push(t.payload.namedQuery):t.payload.documentMetadata?(this.documents.push({metadata:t.payload.documentMetadata}),t.payload.documentMetadata.exists||++e):t.payload.document&&(this.documents[this.documents.length-1].document=t.payload.document,++e),e!==this.progress.documentsLoaded?(this.progress.documentsLoaded=e,Object.assign({},this.progress)):null}fc(t){const e=new Map,n=new rl(this.O);for(const s of t)if(s.metadata.queries){const t=n.Gs(s.metadata.name);for(const n of s.metadata.queries){const s=(e.get(n)||To()).add(t);e.set(n,s)}}return e}async complete(){const t=await async function(t,e,n,s){const r=Os(t);let i=To(),o=yo();for(const t of n){const n=e.Gs(t.metadata.name);t.document&&(i=i.add(n));const s=e.js(t);s.setReadTime(e.Qs(t.metadata.readTime)),o=o.insert(n,s)}const a=r.Bs.newChangeBuffer({trackRemovals:!0}),c=await Nu(r,function(t){return wi(li(sr.fromString(`__bundle__/docs/${t}`)))}(s));return r.persistence.runTransaction("Apply bundle documents","readwrite",(t=>Au(t,a,o).next((e=>(a.apply(t),e))).next((e=>r.Un.removeMatchingKeysForTargetId(t,c.targetId).next((()=>r.Un.addMatchingKeys(t,i,c.targetId))).next((()=>r.Us.Ts(t,e))).next((()=>e))))))}(this.localStore,new rl(this.O),this.documents,this.hc.id),e=this.fc(this.documents);for(const t of this.queries)await Ru(this.localStore,t,e.get(t.name));return this.progress.taskState="Success",new wu(Object.assign({},this.progress),t)}}function ol(t){return{taskState:"Running",documentsLoaded:0,bytesLoaded:0,totalDocuments:t.totalDocuments,totalBytes:t.totalBytes}}class al{constructor(t){this.key=t}}class cl{constructor(t){this.key=t}}class ul{constructor(t,e){this.query=t,this.dc=e,this._c=null,this.current=!1,this.wc=To(),this.mutatedKeys=To(),this.mc=Si(t),this.gc=new zh(this.mc)}get yc(){return this.dc}Ic(t,e){const n=e?e.Ec:new Qh,s=e?e.gc:this.gc;let r=e?e.mutatedKeys:this.mutatedKeys,i=s,o=!1;const a=di(this.query)&&s.size===this.query.limit?s.last():null,c=fi(this.query)&&s.size===this.query.limit?s.first():null;if(t.inorderTraversal(((t,e)=>{const u=s.get(t),h=Ei(this.query,e)?e:null,l=!!u&&this.mutatedKeys.has(u.key),d=!!h&&(h.hasLocalMutations||this.mutatedKeys.has(h.key)&&h.hasCommittedMutations);let f=!1;u&&h?u.data.isEqual(h.data)?l!==d&&(n.track({type:3,doc:h}),f=!0):this.Tc(u,h)||(n.track({type:2,doc:h}),f=!0,(a&&this.mc(h,a)>0||c&&this.mc(h,c)<0)&&(o=!0)):!u&&h?(n.track({type:0,doc:h}),f=!0):u&&!h&&(n.track({type:1,doc:u}),f=!0,(a||c)&&(o=!0)),f&&(h?(i=i.add(h),r=d?r.add(t):r.delete(t)):(i=i.delete(t),r=r.delete(t)))})),di(this.query)||fi(this.query))for(;i.size>this.query.limit;){const t=di(this.query)?i.last():i.first();i=i.delete(t.key),r=r.delete(t.key),n.track({type:1,doc:t})}return{gc:i,Ec:n,ks:o,mutatedKeys:r}}Tc(t,e){return t.hasLocalMutations&&e.hasCommittedMutations&&!e.hasLocalMutations}applyChanges(t,e,n){const s=this.gc;this.gc=t.gc,this.mutatedKeys=t.mutatedKeys;const r=t.Ec.Yo();r.sort(((t,e)=>function(t,e){const n=t=>{switch(t){case 0:return 1;case 2:case 3:return 2;case 1:return 0;default:return Cs()}};return n(t)-n(e)}(t.type,e.type)||this.mc(t.doc,e.doc))),this.Ac(n);const i=e?this.Rc():[],o=0===this.wc.size&&this.current?1:0,a=o!==this._c;return this._c=o,0!==r.length||a?{snapshot:new Hh(this.query,t.gc,s,r,t.mutatedKeys,0===o,a,!1),Pc:i}:{Pc:i}}tc(t){return this.current&&"Offline"===t?(this.current=!1,this.applyChanges({gc:this.gc,Ec:new Qh,mutatedKeys:this.mutatedKeys,ks:!1},!1)):{Pc:[]}}bc(t){return!this.dc.has(t)&&!!this.gc.has(t)&&!this.gc.get(t).hasLocalMutations}Ac(t){t&&(t.addedDocuments.forEach((t=>this.dc=this.dc.add(t))),t.modifiedDocuments.forEach((t=>{})),t.removedDocuments.forEach((t=>this.dc=this.dc.delete(t))),this.current=t.current)}Rc(){if(!this.current)return[];const t=this.wc;this.wc=To(),this.gc.forEach((t=>{this.bc(t.key)&&(this.wc=this.wc.add(t.key))}));const e=[];return t.forEach((t=>{this.wc.has(t)||e.push(new cl(t))})),this.wc.forEach((n=>{t.has(n)||e.push(new al(n))})),e}vc(t){this.dc=t.Ks,this.wc=To();const e=this.Ic(t.documents);return this.applyChanges(e,!0)}Vc(){return Hh.fromInitialDocuments(this.query,this.gc,this.mutatedKeys,0===this._c)}}class hl{constructor(t,e,n){this.query=t,this.targetId=e,this.view=n}}class ll{constructor(t){this.key=t,this.Sc=!1}}class dl{constructor(t,e,n,s,r,i){this.localStore=t,this.remoteStore=e,this.eventManager=n,this.sharedClientState=s,this.currentUser=r,this.maxConcurrentLimboResolutions=i,this.Dc={},this.Cc=new ru((t=>bi(t)),Ii),this.Nc=new Map,this.xc=new Set,this.kc=new uo(br.comparator),this.Oc=new Map,this.Mc=new Pu,this.$c={},this.Fc=new Map,this.Bc=zc.Je(),this.onlineState="Unknown",this.Lc=void 0}get isPrimaryClient(){return!0===this.Lc}}async function fl(t,e){const n=Ul(t);let s,r;const i=n.Cc.get(e);if(i)s=i.targetId,n.sharedClientState.addLocalQueryTarget(s),r=i.view.Vc();else{const t=await Nu(n.localStore,wi(e));n.isPrimaryClient&&wh(n.remoteStore,t);const i=n.sharedClientState.addLocalQueryTarget(t.targetId);s=t.targetId,r=await ml(n,e,s,"current"===i)}return r}async function ml(t,e,n,s){t.Uc=(e,n,s)=>async function(t,e,n,s){let r=e.view.Ic(n);r.ks&&(r=await Du(t.localStore,e.query,!1).then((({documents:t})=>e.view.Ic(t,r))));const i=s&&s.targetChanges.get(e.targetId),o=e.view.applyChanges(r,t.isPrimaryClient,i);return xl(t,e.targetId,o.Pc),o.snapshot}(t,e,n,s);const r=await Du(t.localStore,e,!0),i=new ul(e,r.Ks),o=i.Ic(r.documents),a=Ao.createSynthesizedTargetChangeForCurrentChange(n,s&&"Offline"!==t.onlineState),c=i.applyChanges(o,t.isPrimaryClient,a);xl(t,n,c.Pc);const u=new hl(e,n,i);return t.Cc.set(e,u),t.Nc.has(n)?t.Nc.get(n).push(e):t.Nc.set(n,[e]),c.snapshot}async function gl(t,e){const n=Os(t),s=n.Cc.get(e),r=n.Nc.get(s.targetId);if(r.length>1)return n.Nc.set(s.targetId,r.filter((t=>!Ii(t,e)))),void n.Cc.delete(e);n.isPrimaryClient?(n.sharedClientState.removeLocalQueryTarget(s.targetId),n.sharedClientState.isActiveQueryTarget(s.targetId)||await Cu(n.localStore,s.targetId,!1).then((()=>{n.sharedClientState.clearQueryState(s.targetId),vh(n.remoteStore,s.targetId),El(n,s.targetId)})).catch(Xc)):(El(n,s.targetId),await Cu(n.localStore,s.targetId,!0))}async function pl(t,e){const n=Os(t);try{const t=await function(t,e){const n=Os(t),s=e.snapshotVersion;let r=n.Ms;return n.persistence.runTransaction("Apply remote event","readwrite-primary",(t=>{const i=n.Bs.newChangeBuffer({trackRemovals:!0});r=n.Ms;const o=[];e.targetChanges.forEach(((i,a)=>{const c=r.get(a);if(!c)return;o.push(n.Un.removeMatchingKeys(t,i.removedDocuments,a).next((()=>n.Un.addMatchingKeys(t,i.addedDocuments,a))));let u=c.withSequenceNumber(t.currentSequenceNumber);e.targetMismatches.has(a)?u=u.withResumeToken(cr.EMPTY_BYTE_STRING,Js.min()).withLastLimboFreeSnapshotVersion(Js.min()):i.resumeToken.approximateByteSize()>0&&(u=u.withResumeToken(i.resumeToken,s)),r=r.insert(a,u),function(t,e,n){return 0===t.resumeToken.approximateByteSize()||e.snapshotVersion.toMicroseconds()-t.snapshotVersion.toMicroseconds()>=3e8||n.addedDocuments.size+n.modifiedDocuments.size+n.removedDocuments.size>0}(c,u,i)&&o.push(n.Un.updateTargetData(t,u))}));let a=yo();if(e.documentUpdates.forEach((s=>{e.resolvedLimboDocuments.has(s)&&o.push(n.persistence.referenceDelegate.updateLimboDocument(t,s))})),o.push(Au(t,i,e.documentUpdates).next((t=>{a=t}))),!s.isEqual(Js.min())){const e=n.Un.getLastRemoteSnapshotVersion(t).next((e=>n.Un.setTargetsMetadata(t,t.currentSequenceNumber,s)));o.push(e)}return qa.waitFor(o).next((()=>i.apply(t))).next((()=>n.Us.Ts(t,a))).next((()=>a))})).then((t=>(n.Ms=r,t)))}(n.localStore,e);e.targetChanges.forEach(((t,e)=>{const s=n.Oc.get(e);s&&(Ds(t.addedDocuments.size+t.modifiedDocuments.size+t.removedDocuments.size<=1),t.addedDocuments.size>0?s.Sc=!0:t.modifiedDocuments.size>0?Ds(s.Sc):t.removedDocuments.size>0&&(Ds(s.Sc),s.Sc=!1))})),await Nl(n,t,e)}catch(t){await Xc(t)}}function yl(t,e,n){const s=Os(t);if(s.isPrimaryClient&&0===n||!s.isPrimaryClient&&1===n){const t=[];s.Cc.forEach(((n,s)=>{const r=s.view.tc(e);r.snapshot&&t.push(r.snapshot)})),function(t,e){const n=Os(t);n.onlineState=e;let s=!1;n.queries.forEach(((t,n)=>{for(const t of n.listeners)t.tc(e)&&(s=!0)})),s&&el(n)}(s.eventManager,e),t.length&&s.Dc.To(t),s.onlineState=e,s.isPrimaryClient&&s.sharedClientState.setOnlineState(e)}}async function wl(t,e,n){const s=Os(t);s.sharedClientState.updateQueryState(e,"rejected",n);const r=s.Oc.get(e),i=r&&r.key;if(i){let t=new uo(br.comparator);t=t.insert(i,Ur.newNoDocument(i,Js.min()));const n=To().add(i),r=new xo(Js.min(),new Map,new fo(Hs),t,n);await pl(s,r),s.kc=s.kc.remove(i),s.Oc.delete(e),_l(s)}else await Cu(s.localStore,e,!1).then((()=>El(s,e,n))).catch(Xc)}async function vl(t,e){const n=Os(t),s=e.batch.batchId;try{const t=await function(t,e){const n=Os(t);return n.persistence.runTransaction("Acknowledge batch","readwrite-primary",(t=>{const s=e.batch.keys(),r=n.Bs.newChangeBuffer({trackRemovals:!0});return function(t,e,n,s){const r=n.batch,i=r.keys();let o=qa.resolve();return i.forEach((t=>{o=o.next((()=>s.getEntry(e,t))).next((e=>{const i=n.docVersions.get(t);Ds(null!==i),e.version.compareTo(i)<0&&(r.applyToRemoteDocument(e,n),e.isValidDocument()&&(e.setReadTime(n.commitVersion),s.addEntry(e)))}))})),o.next((()=>t.gs.removeMutationBatch(e,r)))}(n,t,e,r).next((()=>r.apply(t))).next((()=>n.gs.performConsistencyCheck(t))).next((()=>n.Us.Es(t,s)))}))}(n.localStore,e);Tl(n,s,null),bl(n,s),n.sharedClientState.updateMutationState(s,"acknowledged"),await Nl(n,t)}catch(t){await Xc(t)}}async function Il(t,e,n){const s=Os(t);try{const t=await function(t,e){const n=Os(t);return n.persistence.runTransaction("Reject batch","readwrite-primary",(t=>{let s;return n.gs.lookupMutationBatch(t,e).next((e=>(Ds(null!==e),s=e.keys(),n.gs.removeMutationBatch(t,e)))).next((()=>n.gs.performConsistencyCheck(t))).next((()=>n.Us.Es(t,s)))}))}(s.localStore,e);Tl(s,e,n),bl(s,e),s.sharedClientState.updateMutationState(e,"rejected",n),await Nl(s,t)}catch(n){await Xc(n)}}function bl(t,e){(t.Fc.get(e)||[]).forEach((t=>{t.resolve()})),t.Fc.delete(e)}function Tl(t,e,n){const s=Os(t);let r=s.$c[s.currentUser.toKey()];if(r){const t=r.get(e);t&&(n?t.reject(n):t.resolve(),r=r.remove(e)),s.$c[s.currentUser.toKey()]=r}}function El(t,e,n=null){t.sharedClientState.removeLocalQueryTarget(e);for(const s of t.Nc.get(e))t.Cc.delete(s),n&&t.Dc.qc(s,n);t.Nc.delete(e),t.isPrimaryClient&&t.Mc.si(e).forEach((e=>{t.Mc.containsKey(e)||Sl(t,e)}))}function Sl(t,e){t.xc.delete(e.path.canonicalString());const n=t.kc.get(e);null!==n&&(vh(t.remoteStore,n),t.kc=t.kc.remove(e),t.Oc.delete(n),_l(t))}function xl(t,e,n){for(const s of n)s instanceof al?(t.Mc.addReference(s.key,e),Al(t,s)):s instanceof cl?(xs("SyncEngine","Document no longer in limbo: "+s.key),t.Mc.removeReference(s.key,e),t.Mc.containsKey(s.key)||Sl(t,s.key)):Cs()}function Al(t,e){const n=e.key,s=n.path.canonicalString();t.kc.get(n)||t.xc.has(s)||(xs("SyncEngine","New document in limbo: "+n),t.xc.add(s),_l(t))}function _l(t){for(;t.xc.size>0&&t.kc.size<t.maxConcurrentLimboResolutions;){const e=t.xc.values().next().value;t.xc.delete(e);const n=new br(sr.fromString(e)),s=t.Bc.next();t.Oc.set(s,new ll(n)),t.kc=t.kc.insert(n,s),wh(t.remoteStore,new ec(wi(li(n.path)),s,2,$s.A))}}async function Nl(t,e,n){const s=Os(t),r=[],i=[],o=[];s.Cc.isEmpty()||(s.Cc.forEach(((t,a)=>{o.push(s.Uc(a,e,n).then((t=>{if(t){s.isPrimaryClient&&s.sharedClientState.updateQueryState(a.targetId,t.fromCache?"not-current":"current"),r.push(t);const e=Iu.Ss(a.targetId,t);i.push(e)}})))})),await Promise.all(o),s.Dc.To(r),await async function(t,e){const n=Os(t);try{await n.persistence.runTransaction("notifyLocalViewChanges","readwrite",(t=>qa.forEach(e,(e=>qa.forEach(e.vs,(s=>n.persistence.referenceDelegate.addReference(t,e.targetId,s))).next((()=>qa.forEach(e.Vs,(s=>n.persistence.referenceDelegate.removeReference(t,e.targetId,s)))))))))}catch(t){if(!$a(t))throw t;xs("LocalStore","Failed to update sequence numbers: "+t)}for(const t of e){const e=t.targetId;if(!t.fromCache){const t=n.Ms.get(e),s=t.snapshotVersion,r=t.withLastLimboFreeSnapshotVersion(s);n.Ms=n.Ms.insert(e,r)}}}(s.localStore,i))}async function Cl(t,e){const n=Os(t);if(!n.currentUser.isEqual(e)){xs("SyncEngine","User change. New user:",e.toKey());const t=await Su(n.localStore,e);n.currentUser=e,function(t,e){t.Fc.forEach((t=>{t.forEach((t=>{t.reject(new Ls(Rs.CANCELLED,"'waitForPendingWrites' promise is rejected due to a user change."))}))})),t.Fc.clear()}(n),n.sharedClientState.handleUserChange(e,t.removedBatchIds,t.addedBatchIds),await Nl(n,t.qs)}}function Dl(t,e){const n=Os(t),s=n.Oc.get(e);if(s&&s.Sc)return To().add(s.key);{let t=To();const s=n.Nc.get(e);if(!s)return t;for(const e of s){const s=n.Cc.get(e);t=t.unionWith(s.view.yc)}return t}}async function kl(t,e){const n=Os(t),s=await Du(n.localStore,e.query,!0),r=e.view.vc(s);return n.isPrimaryClient&&xl(n,e.targetId,r.Pc),r}async function Ol(t){const e=Os(t);return Ou(e.localStore).then((t=>Nl(e,t)))}async function Rl(t,e,n,s){const r=Os(t),i=await function(t,e){const n=Os(t),s=Os(n.gs);return n.persistence.runTransaction("Lookup mutation documents","readonly",(t=>s.Ge(t,e).next((e=>e?n.Us.Es(t,e):qa.resolve(null)))))}(r.localStore,e);null!==i?("pending"===n?await kh(r.remoteStore):"acknowledged"===n||"rejected"===n?(Tl(r,e,s||null),bl(r,e),function(t,e){Os(Os(t).gs).Qe(e)}(r.localStore,e)):Cs(),await Nl(r,i)):xs("SyncEngine","Cannot apply mutation batch with id: "+e)}async function Ll(t,e,n){const s=Os(t),r=[],i=[];for(const t of e){let e;const n=s.Nc.get(t);if(n&&0!==n.length){e=await Nu(s.localStore,wi(n[0]));for(const t of n){const e=s.Cc.get(t),n=await kl(s,e);n.snapshot&&i.push(n.snapshot)}}else{const n=await ku(s.localStore,t);e=await Nu(s.localStore,n),await ml(s,Ml(n),t,!1)}r.push(e)}return s.Dc.To(i),r}function Ml(t){return hi(t.path,t.collectionGroup,t.orderBy,t.filters,t.limit,"F",t.startAt,t.endAt)}function Pl(t){const e=Os(t);return Os(Os(e.localStore).persistence).ds()}async function Fl(t,e,n,s){const r=Os(t);if(r.Lc)xs("SyncEngine","Ignoring unexpected query state notification.");else if(r.Nc.has(e))switch(n){case"current":case"not-current":{const t=await Ou(r.localStore),s=xo.createSynthesizedRemoteEventForCurrentChange(e,"current"===n);await Nl(r,t,s);break}case"rejected":await Cu(r.localStore,e,!0),El(r,e,s);break;default:Cs()}}async function Vl(t,e,n){const s=Ul(t);if(s.Lc){for(const t of e){if(s.Nc.has(t)){xs("SyncEngine","Adding an already active target "+t);continue}const e=await ku(s.localStore,t),n=await Nu(s.localStore,e);await ml(s,Ml(e),n.targetId,!1),wh(s.remoteStore,n)}for(const t of n)s.Nc.has(t)&&await Cu(s.localStore,t,!1).then((()=>{vh(s.remoteStore,t),El(s,t)})).catch(Xc)}}function Ul(t){const e=Os(t);return e.remoteStore.remoteSyncer.applyRemoteEvent=pl.bind(null,e),e.remoteStore.remoteSyncer.getRemoteKeysForTarget=Dl.bind(null,e),e.remoteStore.remoteSyncer.rejectListen=wl.bind(null,e),e.Dc.To=Zh.bind(null,e.eventManager),e.Dc.qc=tl.bind(null,e.eventManager),e}function ql(t){const e=Os(t);return e.remoteStore.remoteSyncer.applySuccessfulWrite=vl.bind(null,e),e.remoteStore.remoteSyncer.rejectFailedWrite=Il.bind(null,e),e}class Bl{constructor(){this.synchronizeTabs=!1}async initialize(t){this.O=ch(t.databaseInfo.databaseId),this.sharedClientState=this.Gc(t),this.persistence=this.jc(t),await this.persistence.start(),this.gcScheduler=this.Qc(t),this.localStore=this.Wc(t)}Qc(t){return null}Wc(t){return Eu(this.persistence,new bu,t.initialUser,this.O)}jc(t){return new Ku(Gu.bi,this.O)}Gc(t){return new th}async terminate(){this.gcScheduler&&this.gcScheduler.stop(),await this.sharedClientState.shutdown(),await this.persistence.shutdown()}}class Kl extends Bl{constructor(t,e,n){super(),this.zc=t,this.cacheSizeBytes=e,this.forceOwnership=n,this.synchronizeTabs=!1}async initialize(t){await super.initialize(t),await async function(t){const e=Os(t);return e.persistence.runTransaction("Synchronize last document change read time","readonly",(t=>function(t){const e=uu(t);let n=Js.min();return e.Qt({index:Ta.readTimeIndex,reverse:!0},((t,e,s)=>{e.readTime&&(n=oc(e.readTime)),s.done()})).next((()=>n))}(t))).then((t=>{e.Fs=t}))}(this.localStore),await this.zc.initialize(this,t),await ql(this.zc.syncEngine),await kh(this.zc.remoteStore),await this.persistence.Hn((()=>(this.gcScheduler&&!this.gcScheduler.started&&this.gcScheduler.start(this.localStore),Promise.resolve())))}Wc(t){return Eu(this.persistence,new bu,t.initialUser,this.O)}Qc(t){const e=this.persistence.referenceDelegate.garbageCollector;return new tu(e,t.asyncQueue)}jc(t){const e=yu(t.databaseInfo.databaseId,t.databaseInfo.persistenceKey),n=void 0!==this.cacheSizeBytes?Vc.withCacheSize(this.cacheSizeBytes):Vc.DEFAULT;return new mu(this.synchronizeTabs,e,t.clientId,n,t.asyncQueue,oh(),ah(),this.O,this.sharedClientState,!!this.forceOwnership)}Gc(t){return new th}}class jl extends Kl{constructor(t,e){super(t,e,!1),this.zc=t,this.cacheSizeBytes=e,this.synchronizeTabs=!0}async initialize(t){await super.initialize(t);const e=this.zc.syncEngine;this.sharedClientState instanceof Zu&&(this.sharedClientState.syncEngine={hr:Rl.bind(null,e),lr:Fl.bind(null,e),dr:Vl.bind(null,e),ds:Pl.bind(null,e),ar:Ol.bind(null,e)},await this.sharedClientState.start()),await this.persistence.Hn((async t=>{await async function(t,e){const n=Os(t);if(Ul(n),ql(n),!0===e&&!0!==n.Lc){const t=n.sharedClientState.getAllActiveQueryTargets(),e=await Ll(n,t.toArray());n.Lc=!0,await Bh(n.remoteStore,!0);for(const t of e)wh(n.remoteStore,t)}else if(!1===e&&!1!==n.Lc){const t=[];let e=Promise.resolve();n.Nc.forEach(((s,r)=>{n.sharedClientState.isLocalQueryTarget(r)?t.push(r):e=e.then((()=>(El(n,r),Cu(n.localStore,r,!0)))),vh(n.remoteStore,r)})),await e,await Ll(n,t),function(t){const e=Os(t);e.Oc.forEach(((t,n)=>{vh(e.remoteStore,n)})),e.Mc.ii(),e.Oc=new Map,e.kc=new uo(br.comparator)}(n),n.Lc=!1,await Bh(n.remoteStore,!1)}}(this.zc.syncEngine,t),this.gcScheduler&&(t&&!this.gcScheduler.started?this.gcScheduler.start(this.localStore):t||this.gcScheduler.stop())}))}Gc(t){const e=oh();if(!Zu.Vt(e))throw new Ls(Rs.UNIMPLEMENTED,"IndexedDB persistence is only available on platforms that support LocalStorage.");const n=yu(t.databaseInfo.databaseId,t.databaseInfo.persistenceKey);return new Zu(e,t.asyncQueue,n,t.clientId,t.initialUser)}}class Gl{async initialize(t,e){this.localStore||(this.localStore=t.localStore,this.sharedClientState=t.sharedClientState,this.datastore=this.createDatastore(e),this.remoteStore=this.createRemoteStore(e),this.eventManager=this.createEventManager(e),this.syncEngine=this.createSyncEngine(e,!t.synchronizeTabs),this.sharedClientState.onlineStateHandler=t=>yl(this.syncEngine,t,1),this.remoteStore.remoteSyncer.handleCredentialChange=Cl.bind(null,this.syncEngine),await Bh(this.remoteStore,this.syncEngine.isPrimaryClient))}createEventManager(t){return new Yh}createDatastore(t){const e=ch(t.databaseInfo.databaseId),n=(s=t.databaseInfo,new ih(s));var s;return function(t,e,n,s){return new fh(t,e,n,s)}(t.authCredentials,t.appCheckCredentials,n,e)}createRemoteStore(t){return e=this.localStore,n=this.datastore,s=t.asyncQueue,r=t=>yl(this.syncEngine,t,0),i=nh.Vt()?new nh:new eh,new gh(e,n,s,r,i);var e,n,s,r,i}createSyncEngine(t,e){return function(t,e,n,s,r,i,o){const a=new dl(t,e,n,s,r,i);return o&&(a.Lc=!0),a}(this.localStore,this.remoteStore,this.eventManager,this.sharedClientState,t.initialUser,t.maxConcurrentLimboResolutions,e)}terminate(){return async function(t){const e=Os(t);xs("RemoteStore","RemoteStore shutting down."),e.Ko.add(5),await yh(e),e.jo.shutdown(),e.Qo.set("Unknown")}(this.remoteStore)}}function $l(t,e=10240){let n=0;return{async read(){if(n<t.byteLength){const s={value:t.slice(n,n+e),done:!1};return n+=e,s}return{done:!0}},async cancel(){},releaseLock(){},closed:Promise.reject("unimplemented")}}class zl{constructor(t){this.observer=t,this.muted=!1}next(t){this.observer.next&&this.Hc(this.observer.next,t)}error(t){this.observer.error?this.Hc(this.observer.error,t):console.error("Uncaught Error in snapshot listener:",t)}Jc(){this.muted=!0}Hc(t,e){this.muted||setTimeout((()=>{this.muted||t(e)}),0)}}class Ql{constructor(t,e){this.Yc=t,this.O=e,this.metadata=new Ms,this.buffer=new Uint8Array,this.Xc=new TextDecoder("utf-8"),this.Zc().then((t=>{t&&t.ac()?this.metadata.resolve(t.payload.metadata):this.metadata.reject(new Error(`The first element of the bundle is not a metadata, it is\n             ${JSON.stringify(null==t?void 0:t.payload)}`))}),(t=>this.metadata.reject(t)))}close(){return this.Yc.cancel()}async getMetadata(){return this.metadata.promise}async Kc(){return await this.getMetadata(),this.Zc()}async Zc(){const t=await this.tu();if(null===t)return null;const e=this.Xc.decode(t),n=Number(e);isNaN(n)&&this.eu(`length string (${e}) is not valid number`);const s=await this.nu(n);return new sl(JSON.parse(s),t.length+n)}su(){return this.buffer.findIndex((t=>t==="{".charCodeAt(0)))}async tu(){for(;this.su()<0&&!await this.iu(););if(0===this.buffer.length)return null;const t=this.su();t<0&&this.eu("Reached the end of bundle when a length string is expected.");const e=this.buffer.slice(0,t);return this.buffer=this.buffer.slice(t),e}async nu(t){for(;this.buffer.length<t;)await this.iu()&&this.eu("Reached the end of bundle when more is expected.");const e=this.Xc.decode(this.buffer.slice(0,t));return this.buffer=this.buffer.slice(t),e}eu(t){throw this.Yc.cancel(),new Error(`Invalid bundle format: ${t}`)}async iu(){const t=await this.Yc.read();if(!t.done){const e=new Uint8Array(this.buffer.length+t.value.length);e.set(this.buffer),e.set(t.value,this.buffer.length),this.buffer=e}return t.done}}class Hl{constructor(t){this.datastore=t,this.readVersions=new Map,this.mutations=[],this.committed=!1,this.lastWriteError=null,this.writtenDocs=new Set}async lookup(t){if(this.ensureCommitNotCalled(),this.mutations.length>0)throw new Ls(Rs.INVALID_ARGUMENT,"Firestore transactions require all reads to be executed before all writes.");const e=await async function(t,e){const n=Os(t),s=Qo(n.O)+"/documents",r={documents:e.map((t=>jo(n.O,t)))},i=await n.Lr("BatchGetDocuments",s,r),o=new Map;i.forEach((t=>{const e=function(t,e){return"found"in e?function(t,e){Ds(!!e.found),e.found.name,e.found.updateTime;const n=Go(t,e.found.name),s=qo(e.found.updateTime),r=new Fr({mapValue:{fields:e.found.fields}});return Ur.newFoundDocument(n,s,r)}(t,e):"missing"in e?function(t,e){Ds(!!e.missing),Ds(!!e.readTime);const n=Go(t,e.missing),s=qo(e.readTime);return Ur.newNoDocument(n,s)}(t,e):Cs()}(n.O,t);o.set(e.key.toString(),e)}));const a=[];return e.forEach((t=>{const e=o.get(t.toString());Ds(!!e),a.push(e)})),a}(this.datastore,t);return e.forEach((t=>this.recordVersion(t))),e}set(t,e){this.write(e.toMutation(t,this.precondition(t))),this.writtenDocs.add(t.toString())}update(t,e){try{this.write(e.toMutation(t,this.preconditionForUpdate(t)))}catch(t){this.lastWriteError=t}this.writtenDocs.add(t.toString())}delete(t){this.write(new no(t,this.precondition(t))),this.writtenDocs.add(t.toString())}async commit(){if(this.ensureCommitNotCalled(),this.lastWriteError)throw this.lastWriteError;const t=this.readVersions;this.mutations.forEach((e=>{t.delete(e.key.toString())})),t.forEach(((t,e)=>{const n=br.fromPath(e);this.mutations.push(new so(n,this.precondition(n)))})),await async function(t,e){const n=Os(t),s=Qo(n.O)+"/documents",r={writes:e.map((t=>Xo(n.O,t)))};await n.Mr("Commit",s,r)}(this.datastore,this.mutations),this.committed=!0}recordVersion(t){let e;if(t.isFoundDocument())e=t.version;else{if(!t.isNoDocument())throw Cs();e=Js.min()}const n=this.readVersions.get(t.key.toString());if(n){if(!e.isEqual(n))throw new Ls(Rs.ABORTED,"Document version changed between two reads.")}else this.readVersions.set(t.key.toString(),e)}precondition(t){const e=this.readVersions.get(t.toString());return!this.writtenDocs.has(t.toString())&&e?ji.updateTime(e):ji.none()}preconditionForUpdate(t){const e=this.readVersions.get(t.toString());if(!this.writtenDocs.has(t.toString())&&e){if(e.isEqual(Js.min()))throw new Ls(Rs.INVALID_ARGUMENT,"Can't update a document that doesn't exist.");return ji.updateTime(e)}return ji.exists(!0)}write(t){this.ensureCommitNotCalled(),this.mutations.push(t)}ensureCommitNotCalled(){}}class Wl{constructor(t,e,n,s){this.asyncQueue=t,this.datastore=e,this.updateFunction=n,this.deferred=s,this.ru=5,this.ro=new uh(this.asyncQueue,"transaction_retry")}run(){this.ru-=1,this.ou()}ou(){this.ro.Hr((async()=>{const t=new Hl(this.datastore),e=this.cu(t);e&&e.then((e=>{this.asyncQueue.enqueueAndForget((()=>t.commit().then((()=>{this.deferred.resolve(e)})).catch((t=>{this.uu(t)}))))})).catch((t=>{this.uu(t)}))}))}cu(t){try{const e=this.updateFunction(t);return!wr(e)&&e.catch&&e.then?e:(this.deferred.reject(Error("Transaction callback must return a Promise")),null)}catch(t){return this.deferred.reject(t),null}}uu(t){this.ru>0&&this.au(t)?(this.ru-=1,this.asyncQueue.enqueueAndForget((()=>(this.ou(),Promise.resolve())))):this.deferred.reject(t)}au(t){if("FirebaseError"===t.name){const e=t.code;return"aborted"===e||"failed-precondition"===e||!ao(e)}return!1}}class Yl{constructor(t,e,n,s){this.authCredentials=t,this.appCheckCredentials=e,this.asyncQueue=n,this.databaseInfo=s,this.user=Is.UNAUTHENTICATED,this.clientId=Qs.R(),this.authCredentialListener=()=>Promise.resolve(),this.appCheckCredentialListener=()=>Promise.resolve(),this.authCredentials.start(n,(async t=>{xs("FirestoreClient","Received user=",t.uid),await this.authCredentialListener(t),this.user=t})),this.appCheckCredentials.start(n,(t=>(xs("FirestoreClient","Received new app check token=",t),this.appCheckCredentialListener(t,this.user))))}async getConfiguration(){return{asyncQueue:this.asyncQueue,databaseInfo:this.databaseInfo,clientId:this.clientId,authCredentials:this.authCredentials,appCheckCredentials:this.appCheckCredentials,initialUser:this.user,maxConcurrentLimboResolutions:100}}setCredentialChangeListener(t){this.authCredentialListener=t}setAppCheckTokenChangeListener(t){this.appCheckCredentialListener=t}verifyNotTerminated(){if(this.asyncQueue.isShuttingDown)throw new Ls(Rs.FAILED_PRECONDITION,"The client has already been terminated.")}terminate(){this.asyncQueue.enterRestrictedMode();const t=new Ms;return this.asyncQueue.enqueueAndForgetEvenWhileRestricted((async()=>{try{this.onlineComponents&&await this.onlineComponents.terminate(),this.offlineComponents&&await this.offlineComponents.terminate(),this.authCredentials.shutdown(),this.appCheckCredentials.shutdown(),t.resolve()}catch(e){const n=$h(e,"Failed to shutdown persistence");t.reject(n)}})),t.promise}}async function Xl(t,e){t.asyncQueue.verifyOperationInProgress(),xs("FirestoreClient","Initializing OfflineComponentProvider");const n=await t.getConfiguration();await e.initialize(n);let s=n.initialUser;t.setCredentialChangeListener((async t=>{s.isEqual(t)||(await Su(e.localStore,t),s=t)})),e.persistence.setDatabaseDeletedListener((()=>t.terminate())),t.offlineComponents=e}async function Jl(t,e){t.asyncQueue.verifyOperationInProgress();const n=await Zl(t);xs("FirestoreClient","Initializing OnlineComponentProvider");const s=await t.getConfiguration();await e.initialize(n,s),t.setCredentialChangeListener((t=>qh(e.remoteStore,t))),t.setAppCheckTokenChangeListener(((t,n)=>qh(e.remoteStore,n))),t.onlineComponents=e}async function Zl(t){return t.offlineComponents||(xs("FirestoreClient","Using default OfflineComponentProvider"),await Xl(t,new Bl)),t.offlineComponents}async function td(t){return t.onlineComponents||(xs("FirestoreClient","Using default OnlineComponentProvider"),await Jl(t,new Gl)),t.onlineComponents}function ed(t){return Zl(t).then((t=>t.persistence))}function nd(t){return Zl(t).then((t=>t.localStore))}function sd(t){return td(t).then((t=>t.remoteStore))}function rd(t){return td(t).then((t=>t.syncEngine))}async function id(t){const e=await td(t),n=e.eventManager;return n.onListen=fl.bind(null,e.syncEngine),n.onUnlisten=gl.bind(null,e.syncEngine),n}function od(t,e,n={}){const s=new Ms;return t.asyncQueue.enqueueAndForget((async()=>function(t,e,n,s,r){const i=new zl({next:i=>{e.enqueueAndForget((()=>Jh(t,o)));const a=i.docs.has(n);!a&&i.fromCache?r.reject(new Ls(Rs.UNAVAILABLE,"Failed to get document because the client is offline.")):a&&i.fromCache&&s&&"server"===s.source?r.reject(new Ls(Rs.UNAVAILABLE,'Failed to get document from server. (However, this document does exist in the local cache. Run again without setting source to "server" to retrieve the cached document.)')):r.resolve(i)},error:t=>r.reject(t)}),o=new nl(li(n.path),i,{includeMetadataChanges:!0,uc:!0});return Xh(t,o)}(await id(t),t.asyncQueue,e,n,s))),s.promise}function ad(t,e,n={}){const s=new Ms;return t.asyncQueue.enqueueAndForget((async()=>function(t,e,n,s,r){const i=new zl({next:n=>{e.enqueueAndForget((()=>Jh(t,o))),n.fromCache&&"server"===s.source?r.reject(new Ls(Rs.UNAVAILABLE,'Failed to get documents from server. (However, these documents may exist in the local cache. Run again without setting source to "server" to retrieve the cached documents.)')):r.resolve(n)},error:t=>r.reject(t)}),o=new nl(n,i,{includeMetadataChanges:!0,uc:!0});return Xh(t,o)}(await id(t),t.asyncQueue,e,n,s))),s.promise}const cd=new Map;function ud(t,e,n){if(!n)throw new Ls(Rs.INVALID_ARGUMENT,`Function ${t}() cannot be called with an empty ${e}.`)}function hd(t,e,n,s){if(!0===e&&!0===s)throw new Ls(Rs.INVALID_ARGUMENT,`${t} and ${n} cannot be used together.`)}function ld(t){if(!br.isDocumentKey(t))throw new Ls(Rs.INVALID_ARGUMENT,`Invalid document reference. Document references must have an even number of segments, but ${t} has ${t.length}.`)}function dd(t){if(br.isDocumentKey(t))throw new Ls(Rs.INVALID_ARGUMENT,`Invalid collection reference. Collection references must have an odd number of segments, but ${t} has ${t.length}.`)}function fd(t){if(void 0===t)return"undefined";if(null===t)return"null";if("string"==typeof t)return t.length>20&&(t=`${t.substring(0,20)}...`),JSON.stringify(t);if("number"==typeof t||"boolean"==typeof t)return""+t;if("object"==typeof t){if(t instanceof Array)return"an array";{const e=function(t){return t.constructor?t.constructor.name:null}(t);return e?`a custom ${e} object`:"an object"}}return"function"==typeof t?"a function":Cs()}function md(t,e){if("_delegate"in t&&(t=t._delegate),!(t instanceof e)){if(e.name===t.constructor.name)throw new Ls(Rs.INVALID_ARGUMENT,"Type does not match the expected instance. Did you pass a reference from a different Firestore SDK?");{const n=fd(t);throw new Ls(Rs.INVALID_ARGUMENT,`Expected type '${e.name}', but it was: ${n}`)}}return t}function gd(t,e){if(e<=0)throw new Ls(Rs.INVALID_ARGUMENT,`Function ${t}() requires a positive number, but it was: ${e}.`)}class pd{constructor(t){var e;if(void 0===t.host){if(void 0!==t.ssl)throw new Ls(Rs.INVALID_ARGUMENT,"Can't provide ssl option if host option is not set");this.host="firestore.googleapis.com",this.ssl=!0}else this.host=t.host,this.ssl=null===(e=t.ssl)||void 0===e||e;if(this.credentials=t.credentials,this.ignoreUndefinedProperties=!!t.ignoreUndefinedProperties,void 0===t.cacheSizeBytes)this.cacheSizeBytes=41943040;else{if(-1!==t.cacheSizeBytes&&t.cacheSizeBytes<1048576)throw new Ls(Rs.INVALID_ARGUMENT,"cacheSizeBytes must be at least 1048576");this.cacheSizeBytes=t.cacheSizeBytes}this.experimentalForceLongPolling=!!t.experimentalForceLongPolling,this.experimentalAutoDetectLongPolling=!!t.experimentalAutoDetectLongPolling,this.useFetchStreams=!!t.useFetchStreams,hd("experimentalForceLongPolling",t.experimentalForceLongPolling,"experimentalAutoDetectLongPolling",t.experimentalAutoDetectLongPolling)}isEqual(t){return this.host===t.host&&this.ssl===t.ssl&&this.credentials===t.credentials&&this.cacheSizeBytes===t.cacheSizeBytes&&this.experimentalForceLongPolling===t.experimentalForceLongPolling&&this.experimentalAutoDetectLongPolling===t.experimentalAutoDetectLongPolling&&this.ignoreUndefinedProperties===t.ignoreUndefinedProperties&&this.useFetchStreams===t.useFetchStreams}}class yd{constructor(t,e,n){this._authCredentials=e,this._appCheckCredentials=n,this.type="firestore-lite",this._persistenceKey="(lite)",this._settings=new pd({}),this._settingsFrozen=!1,t instanceof yr?this._databaseId=t:(this._app=t,this._databaseId=function(t){if(!Object.prototype.hasOwnProperty.apply(t.options,["projectId"]))throw new Ls(Rs.INVALID_ARGUMENT,'"projectId" not provided in firebase.initializeApp.');return new yr(t.options.projectId)}(t))}get app(){if(!this._app)throw new Ls(Rs.FAILED_PRECONDITION,"Firestore was not initialized using the Firebase SDK. 'app' is not available");return this._app}get _initialized(){return this._settingsFrozen}get _terminated(){return void 0!==this._terminateTask}_setSettings(t){if(this._settingsFrozen)throw new Ls(Rs.FAILED_PRECONDITION,"Firestore has already been started and its settings can no longer be changed. You can only modify settings before calling any other methods on a Firestore object.");this._settings=new pd(t),void 0!==t.credentials&&(this._authCredentials=function(t){if(!t)return new Fs;switch(t.type){case"gapi":const e=t.client;return Ds(!("object"!=typeof e||null===e||!e.auth||!e.auth.getAuthHeaderValueForFirstParty)),new Bs(e,t.sessionIndex||"0",t.iamToken||null);case"provider":return t.client;default:throw new Ls(Rs.INVALID_ARGUMENT,"makeAuthCredentialsProvider failed due to invalid credential type")}}(t.credentials))}_getSettings(){return this._settings}_freezeSettings(){return this._settingsFrozen=!0,this._settings}_delete(){return this._terminateTask||(this._terminateTask=this._terminate()),this._terminateTask}toJSON(){return{app:this._app,databaseId:this._databaseId,settings:this._settings}}_terminate(){return function(t){const e=cd.get(t);e&&(xs("ComponentProvider","Removing Datastore"),cd.delete(t),e.terminate())}(this),Promise.resolve()}}function wd(t,e,n,s={}){var r;const i=(t=md(t,yd))._getSettings();if("firestore.googleapis.com"!==i.host&&i.host!==e&&_s("Host has been set in both settings() and useEmulator(), emulator host will be used"),t._setSettings(Object.assign(Object.assign({},i),{host:`${e}:${n}`,ssl:!1})),s.mockUserToken){let e,n;if("string"==typeof s.mockUserToken)e=s.mockUserToken,n=Is.MOCK_USER;else{e=(0,a.Sg)(s.mockUserToken,null===(r=t._app)||void 0===r?void 0:r.options.projectId);const i=s.mockUserToken.sub||s.mockUserToken.user_id;if(!i)throw new Ls(Rs.INVALID_ARGUMENT,"mockUserToken must contain 'sub' or 'user_id' field!");n=new Is(i)}t._authCredentials=new Vs(new Ps(e,n))}}class vd{constructor(t,e,n){this.converter=e,this._key=n,this.type="document",this.firestore=t}get _path(){return this._key.path}get id(){return this._key.path.lastSegment()}get path(){return this._key.path.canonicalString()}get parent(){return new bd(this.firestore,this.converter,this._key.path.popLast())}withConverter(t){return new vd(this.firestore,t,this._key)}}class Id{constructor(t,e,n){this.converter=e,this._query=n,this.type="query",this.firestore=t}withConverter(t){return new Id(this.firestore,t,this._query)}}class bd extends Id{constructor(t,e,n){super(t,e,li(n)),this._path=n,this.type="collection"}get id(){return this._query.path.lastSegment()}get path(){return this._query.path.canonicalString()}get parent(){const t=this._path.popLast();return t.isEmpty()?null:new vd(this.firestore,null,new br(t))}withConverter(t){return new bd(this.firestore,t,this._path)}}function Td(t,e,...n){if(t=(0,a.m9)(t),ud("collection","path",e),t instanceof yd){const s=sr.fromString(e,...n);return dd(s),new bd(t,null,s)}{if(!(t instanceof vd||t instanceof bd))throw new Ls(Rs.INVALID_ARGUMENT,"Expected first argument to collection() to be a CollectionReference, a DocumentReference or FirebaseFirestore");const s=t._path.child(sr.fromString(e,...n));return dd(s),new bd(t.firestore,null,s)}}function Ed(t,e){if(t=md(t,yd),ud("collectionGroup","collection id",e),e.indexOf("/")>=0)throw new Ls(Rs.INVALID_ARGUMENT,`Invalid collection ID '${e}' passed to function collectionGroup(). Collection IDs must not contain '/'.`);return new Id(t,null,function(t){return new ui(sr.emptyPath(),t)}(e))}function Sd(t,e,...n){if(t=(0,a.m9)(t),1===arguments.length&&(e=Qs.R()),ud("doc","path",e),t instanceof yd){const s=sr.fromString(e,...n);return ld(s),new vd(t,null,new br(s))}{if(!(t instanceof vd||t instanceof bd))throw new Ls(Rs.INVALID_ARGUMENT,"Expected first argument to collection() to be a CollectionReference, a DocumentReference or FirebaseFirestore");const s=t._path.child(sr.fromString(e,...n));return ld(s),new vd(t.firestore,t instanceof bd?t.converter:null,new br(s))}}function xd(t,e){return t=(0,a.m9)(t),e=(0,a.m9)(e),(t instanceof vd||t instanceof bd)&&(e instanceof vd||e instanceof bd)&&t.firestore===e.firestore&&t.path===e.path&&t.converter===e.converter}function Ad(t,e){return t=(0,a.m9)(t),e=(0,a.m9)(e),t instanceof Id&&e instanceof Id&&t.firestore===e.firestore&&Ii(t._query,e._query)&&t.converter===e.converter}class _d{constructor(){this.hu=Promise.resolve(),this.lu=[],this.fu=!1,this.du=[],this._u=null,this.wu=!1,this.mu=!1,this.gu=[],this.ro=new uh(this,"async_queue_retry"),this.yu=()=>{const t=ah();t&&xs("AsyncQueue","Visibility state changed to "+t.visibilityState),this.ro.Yr()};const t=ah();t&&"function"==typeof t.addEventListener&&t.addEventListener("visibilitychange",this.yu)}get isShuttingDown(){return this.fu}enqueueAndForget(t){this.enqueue(t)}enqueueAndForgetEvenWhileRestricted(t){this.pu(),this.Iu(t)}enterRestrictedMode(t){if(!this.fu){this.fu=!0,this.mu=t||!1;const e=ah();e&&"function"==typeof e.removeEventListener&&e.removeEventListener("visibilitychange",this.yu)}}enqueue(t){if(this.pu(),this.fu)return new Promise((()=>{}));const e=new Ms;return this.Iu((()=>this.fu&&this.mu?Promise.resolve():(t().then(e.resolve,e.reject),e.promise))).then((()=>e.promise))}enqueueRetryable(t){this.enqueueAndForget((()=>(this.lu.push(t),this.Eu())))}async Eu(){if(0!==this.lu.length){try{await this.lu[0](),this.lu.shift(),this.ro.reset()}catch(t){if(!$a(t))throw t;xs("AsyncQueue","Operation failed with retryable error: "+t)}this.lu.length>0&&this.ro.Hr((()=>this.Eu()))}}Iu(t){const e=this.hu.then((()=>(this.wu=!0,t().catch((t=>{this._u=t,this.wu=!1;const e=function(t){let e=t.message||"";return t.stack&&(e=t.stack.includes(t.message)?t.stack:t.message+"\n"+t.stack),e}(t);throw As("INTERNAL UNHANDLED ERROR: ",e),t})).then((t=>(this.wu=!1,t))))));return this.hu=e,e}enqueueAfterDelay(t,e,n){this.pu(),this.gu.indexOf(t)>-1&&(e=0);const s=Gh.createAndSchedule(this,t,e,n,(t=>this.Tu(t)));return this.du.push(s),s}pu(){this._u&&Cs()}verifyOperationInProgress(){}async Au(){let t;do{t=this.hu,await t}while(t!==this.hu)}Ru(t){for(const e of this.du)if(e.timerId===t)return!0;return!1}Pu(t){return this.Au().then((()=>{this.du.sort(((t,e)=>t.targetTimeMs-e.targetTimeMs));for(const e of this.du)if(e.skipDelay(),"all"!==t&&e.timerId===t)break;return this.Au()}))}bu(t){this.gu.push(t)}Tu(t){const e=this.du.indexOf(t);this.du.splice(e,1)}}function Nd(t){return function(t,e){if("object"!=typeof t||null===t)return!1;const n=t;for(const t of["next","error","complete"])if(t in n&&"function"==typeof n[t])return!0;return!1}(t)}class Cd{constructor(){this._progressObserver={},this._taskCompletionResolver=new Ms,this._lastProgress={taskState:"Running",totalBytes:0,totalDocuments:0,bytesLoaded:0,documentsLoaded:0}}onProgress(t,e,n){this._progressObserver={next:t,error:e,complete:n}}catch(t){return this._taskCompletionResolver.promise.catch(t)}then(t,e){return this._taskCompletionResolver.promise.then(t,e)}_completeWith(t){this._updateProgress(t),this._progressObserver.complete&&this._progressObserver.complete(),this._taskCompletionResolver.resolve(t)}_failWith(t){this._lastProgress.taskState="Error",this._progressObserver.next&&this._progressObserver.next(this._lastProgress),this._progressObserver.error&&this._progressObserver.error(t),this._taskCompletionResolver.reject(t)}_updateProgress(t){this._lastProgress=t,this._progressObserver.next&&this._progressObserver.next(t)}}const Dd=-1;class kd extends yd{constructor(t,e,n){super(t,e,n),this.type="firestore",this._queue=new _d,this._persistenceKey="name"in t?t.name:"[DEFAULT]"}_terminate(){return this._firestoreClient||Md(this),this._firestoreClient.terminate()}}function Od(t,e){const n=(0,r._getProvider)(t,"firestore");if(n.isInitialized()){const t=n.getImmediate(),s=n.getOptions();if((0,a.vZ)(s,e))return t;throw new Ls(Rs.FAILED_PRECONDITION,"initializeFirestore() has already been called with different options. To avoid this error, call initializeFirestore() with the same options as when it was originally called, or call getFirestore() to return the already initialized instance.")}if(void 0!==e.cacheSizeBytes&&-1!==e.cacheSizeBytes&&e.cacheSizeBytes<1048576)throw new Ls(Rs.INVALID_ARGUMENT,"cacheSizeBytes must be at least 1048576");return n.initialize({options:e})}function Rd(t=(0,r.getApp)()){return(0,r._getProvider)(t,"firestore").getImmediate()}function Ld(t){return t._firestoreClient||Md(t),t._firestoreClient.verifyNotTerminated(),t._firestoreClient}function Md(t){var e;const n=t._freezeSettings(),s=function(t,e,n,s){return new pr(t,e,n,s.host,s.ssl,s.experimentalForceLongPolling,s.experimentalAutoDetectLongPolling,s.useFetchStreams)}(t._databaseId,(null===(e=t._app)||void 0===e?void 0:e.options.appId)||"",t._persistenceKey,n);t._firestoreClient=new Yl(t._authCredentials,t._appCheckCredentials,t._queue,s)}function Pd(t,e){zd(t=md(t,kd));const n=Ld(t),s=t._freezeSettings(),r=new Gl;return Vd(n,r,new Kl(r,s.cacheSizeBytes,null==e?void 0:e.forceOwnership))}function Fd(t){zd(t=md(t,kd));const e=Ld(t),n=t._freezeSettings(),s=new Gl;return Vd(e,s,new jl(s,n.cacheSizeBytes))}function Vd(t,e,n){const s=new Ms;return t.asyncQueue.enqueue((async()=>{try{await Xl(t,n),await Jl(t,e),s.resolve()}catch(t){if(!function(t){return"FirebaseError"===t.name?t.code===Rs.FAILED_PRECONDITION||t.code===Rs.UNIMPLEMENTED:!("undefined"!=typeof DOMException&&t instanceof DOMException)||22===t.code||20===t.code||11===t.code}(t))throw t;console.warn("Error enabling offline persistence. Falling back to persistence disabled: "+t),s.reject(t)}})).then((()=>s.promise))}function Ud(t){if(t._initialized&&!t._terminated)throw new Ls(Rs.FAILED_PRECONDITION,"Persistence can only be cleared before a Firestore instance is initialized or after it is terminated.");const e=new Ms;return t._queue.enqueueAndForgetEvenWhileRestricted((async()=>{try{await async function(t){if(!Ka.Vt())return Promise.resolve();const e=t+"main";await Ka.delete(e)}(yu(t._databaseId,t._persistenceKey)),e.resolve()}catch(t){e.reject(t)}})),e.promise}function qd(t){return function(t){const e=new Ms;return t.asyncQueue.enqueueAndForget((async()=>async function(t,e){const n=Os(t);Sh(n.remoteStore)||xs("SyncEngine","The network is disabled. The task returned by 'awaitPendingWrites()' will not complete until the network is enabled.");try{const t=await function(t){const e=Os(t);return e.persistence.runTransaction("Get highest unacknowledged batch id","readonly",(t=>e.gs.getHighestUnacknowledgedBatchId(t)))}(n.localStore);if(-1===t)return void e.resolve();const s=n.Fc.get(t)||[];s.push(e),n.Fc.set(t,s)}catch(t){const n=$h(t,"Initialization of waitForPendingWrites() operation failed");e.reject(n)}}(await rd(t),e))),e.promise}(Ld(t=md(t,kd)))}function Bd(t){return function(t){return t.asyncQueue.enqueue((async()=>{const e=await ed(t),n=await sd(t);return e.setNetworkEnabled(!0),function(t){const e=Os(t);return e.Ko.delete(0),ph(e)}(n)}))}(Ld(t=md(t,kd)))}function Kd(t){return function(t){return t.asyncQueue.enqueue((async()=>{const e=await ed(t),n=await sd(t);return e.setNetworkEnabled(!1),async function(t){const e=Os(t);e.Ko.add(0),await yh(e),e.Qo.set("Offline")}(n)}))}(Ld(t=md(t,kd)))}function jd(t){return(0,r._removeServiceInstance)(t.app,"firestore"),t._delete()}function Gd(t,e){const n=Ld(t=md(t,kd)),s=new Cd;return function(t,e,n,s){const r=function(t,e){let n;return n="string"==typeof t?(new TextEncoder).encode(t):t,function(t,e){return new Ql(t,e)}(function(t,e){if(t instanceof Uint8Array)return $l(t,e);if(t instanceof ArrayBuffer)return $l(new Uint8Array(t),e);if(t instanceof ReadableStream)return t.getReader();throw new Error("Source of `toByteStreamReader` has to be a ArrayBuffer or ReadableStream")}(n),e)}(n,ch(e));t.asyncQueue.enqueueAndForget((async()=>{!function(t,e,n){const s=Os(t);(async function(t,e,n){try{const s=await e.getMetadata();if(await function(t,e){const n=Os(t),s=qo(e.createTime);return n.persistence.runTransaction("hasNewerBundle","readonly",(t=>n.Kn.getBundleMetadata(t,e.id))).then((t=>!!t&&t.createTime.compareTo(s)>=0))}(t.localStore,s))return await e.close(),void n._completeWith(function(t){return{taskState:"Success",documentsLoaded:t.totalDocuments,bytesLoaded:t.totalBytes,totalDocuments:t.totalDocuments,totalBytes:t.totalBytes}}(s));n._updateProgress(ol(s));const r=new il(s,t.localStore,e.O);let i=await e.Kc();for(;i;){const t=await r.lc(i);t&&n._updateProgress(t),i=await e.Kc()}const o=await r.complete();await Nl(t,o.ws,void 0),await function(t,e){const n=Os(t);return n.persistence.runTransaction("Save bundle","readwrite",(t=>n.Kn.saveBundleMetadata(t,e)))}(t.localStore,s),n._completeWith(o.progress)}catch(t){_s("SyncEngine",`Loading bundle failed with ${t}`),n._failWith(t)}})(s,e,n).then((()=>{s.sharedClientState.notifyBundleLoaded()}))}(await rd(t),r,s)}))}(n,t._databaseId,e,s),s}function $d(t,e){return function(t,e){return t.asyncQueue.enqueue((async()=>function(t,e){const n=Os(t);return n.persistence.runTransaction("Get named query","readonly",(t=>n.Kn.getNamedQuery(t,e)))}(await nd(t),e)))}(Ld(t=md(t,kd)),e).then((e=>e?new Id(t,null,e.query):null))}function zd(t){if(t._initialized||t._terminated)throw new Ls(Rs.FAILED_PRECONDITION,"Firestore has already been started and persistence can no longer be enabled. You can only enable persistence before calling any other methods on a Firestore object.")}class Qd{constructor(...t){for(let e=0;e<t.length;++e)if(0===t[e].length)throw new Ls(Rs.INVALID_ARGUMENT,"Invalid field name at argument $(i + 1). Field names must not be empty.");this._internalPath=new ir(t)}isEqual(t){return this._internalPath.isEqual(t._internalPath)}}function Hd(){return new Qd("__name__")}class Wd{constructor(t){this._byteString=t}static fromBase64String(t){try{return new Wd(cr.fromBase64String(t))}catch(t){throw new Ls(Rs.INVALID_ARGUMENT,"Failed to construct data from Base64 string: "+t)}}static fromUint8Array(t){return new Wd(cr.fromUint8Array(t))}toBase64(){return this._byteString.toBase64()}toUint8Array(){return this._byteString.toUint8Array()}toString(){return"Bytes(base64: "+this.toBase64()+")"}isEqual(t){return this._byteString.isEqual(t._byteString)}}class Yd{constructor(t){this._methodName=t}}class Xd{constructor(t,e){if(!isFinite(t)||t<-90||t>90)throw new Ls(Rs.INVALID_ARGUMENT,"Latitude must be a number between -90 and 90, but was: "+t);if(!isFinite(e)||e<-180||e>180)throw new Ls(Rs.INVALID_ARGUMENT,"Longitude must be a number between -180 and 180, but was: "+e);this._lat=t,this._long=e}get latitude(){return this._lat}get longitude(){return this._long}isEqual(t){return this._lat===t._lat&&this._long===t._long}toJSON(){return{latitude:this._lat,longitude:this._long}}_compareTo(t){return Hs(this._lat,t._lat)||Hs(this._long,t._long)}}const Jd=/^__.*__$/;class Zd{constructor(t,e,n){this.data=t,this.fieldMask=e,this.fieldTransforms=n}toMutation(t,e){return null!==this.fieldMask?new Ji(t,this.data,this.fieldMask,e,this.fieldTransforms):new Xi(t,this.data,e,this.fieldTransforms)}}class tf{constructor(t,e,n){this.data=t,this.fieldMask=e,this.fieldTransforms=n}toMutation(t,e){return new Ji(t,this.data,this.fieldMask,e,this.fieldTransforms)}}function ef(t){switch(t){case 0:case 2:case 1:return!0;case 3:case 4:return!1;default:throw Cs()}}class nf{constructor(t,e,n,s,r,i){this.settings=t,this.databaseId=e,this.O=n,this.ignoreUndefinedProperties=s,void 0===r&&this.vu(),this.fieldTransforms=r||[],this.fieldMask=i||[]}get path(){return this.settings.path}get Vu(){return this.settings.Vu}Su(t){return new nf(Object.assign(Object.assign({},this.settings),t),this.databaseId,this.O,this.ignoreUndefinedProperties,this.fieldTransforms,this.fieldMask)}Du(t){var e;const n=null===(e=this.path)||void 0===e?void 0:e.child(t),s=this.Su({path:n,Cu:!1});return s.Nu(t),s}xu(t){var e;const n=null===(e=this.path)||void 0===e?void 0:e.child(t),s=this.Su({path:n,Cu:!1});return s.vu(),s}ku(t){return this.Su({path:void 0,Cu:!0})}Ou(t){return Ef(t,this.settings.methodName,this.settings.Mu||!1,this.path,this.settings.$u)}contains(t){return void 0!==this.fieldMask.find((e=>t.isPrefixOf(e)))||void 0!==this.fieldTransforms.find((e=>t.isPrefixOf(e.field)))}vu(){if(this.path)for(let t=0;t<this.path.length;t++)this.Nu(this.path.get(t))}Nu(t){if(0===t.length)throw this.Ou("Document fields must not be empty");if(ef(this.Vu)&&Jd.test(t))throw this.Ou('Document fields cannot begin and end with "__"')}}class sf{constructor(t,e,n){this.databaseId=t,this.ignoreUndefinedProperties=e,this.O=n||ch(t)}Fu(t,e,n,s=!1){return new nf({Vu:t,methodName:e,$u:n,path:ir.emptyPath(),Cu:!1,Mu:s},this.databaseId,this.O,this.ignoreUndefinedProperties)}}function rf(t){const e=t._freezeSettings(),n=ch(t._databaseId);return new sf(t._databaseId,!!e.ignoreUndefinedProperties,n)}function of(t,e,n,s,r,i={}){const o=t.Fu(i.merge||i.mergeFields?2:0,e,n,r);vf("Data must be an object, but it was:",o,s);const a=yf(s,o);let c,u;if(i.merge)c=new or(o.fieldMask),u=o.fieldTransforms;else if(i.mergeFields){const t=[];for(const s of i.mergeFields){const r=If(e,s,n);if(!o.contains(r))throw new Ls(Rs.INVALID_ARGUMENT,`Field '${r}' is specified in your field mask but missing from your input data.`);Sf(t,r)||t.push(r)}c=new or(t),u=o.fieldTransforms.filter((t=>c.covers(t.field)))}else c=null,u=o.fieldTransforms;return new Zd(new Fr(a),c,u)}class af extends Yd{_toFieldTransform(t){if(2!==t.Vu)throw 1===t.Vu?t.Ou(`${this._methodName}() can only appear at the top level of your update data`):t.Ou(`${this._methodName}() cannot be used with set() unless you pass {merge:true}`);return t.fieldMask.push(t.path),null}isEqual(t){return t instanceof af}}function cf(t,e,n){return new nf({Vu:3,$u:e.settings.$u,methodName:t._methodName,Cu:n},e.databaseId,e.O,e.ignoreUndefinedProperties)}class uf extends Yd{_toFieldTransform(t){return new Bi(t.path,new Ri)}isEqual(t){return t instanceof uf}}class hf extends Yd{constructor(t,e){super(t),this.Bu=e}_toFieldTransform(t){const e=cf(this,t,!0),n=this.Bu.map((t=>pf(t,e))),s=new Li(n);return new Bi(t.path,s)}isEqual(t){return this===t}}class lf extends Yd{constructor(t,e){super(t),this.Bu=e}_toFieldTransform(t){const e=cf(this,t,!0),n=this.Bu.map((t=>pf(t,e))),s=new Pi(n);return new Bi(t.path,s)}isEqual(t){return this===t}}class df extends Yd{constructor(t,e){super(t),this.Lu=e}_toFieldTransform(t){const e=new Vi(t.O,Ni(t.O,this.Lu));return new Bi(t.path,e)}isEqual(t){return this===t}}function ff(t,e,n,s){const r=t.Fu(1,e,n);vf("Data must be an object, but it was:",r,s);const i=[],o=Fr.empty();tr(s,((t,s)=>{const c=Tf(e,t,n);s=(0,a.m9)(s);const u=r.xu(c);if(s instanceof af)i.push(c);else{const t=pf(s,u);null!=t&&(i.push(c),o.set(c,t))}}));const c=new or(i);return new tf(o,c,r.fieldTransforms)}function mf(t,e,n,s,r,i){const o=t.Fu(1,e,n),c=[If(e,s,n)],u=[r];if(i.length%2!=0)throw new Ls(Rs.INVALID_ARGUMENT,`Function ${e}() needs to be called with an even number of arguments that alternate between field names and values.`);for(let t=0;t<i.length;t+=2)c.push(If(e,i[t])),u.push(i[t+1]);const h=[],l=Fr.empty();for(let t=c.length-1;t>=0;--t)if(!Sf(h,c[t])){const e=c[t];let n=u[t];n=(0,a.m9)(n);const s=o.xu(e);if(n instanceof af)h.push(e);else{const t=pf(n,s);null!=t&&(h.push(e),l.set(e,t))}}const d=new or(h);return new tf(l,d,o.fieldTransforms)}function gf(t,e,n,s=!1){return pf(n,t.Fu(s?4:3,e))}function pf(t,e){if(wf(t=(0,a.m9)(t)))return vf("Unsupported field value:",e,t),yf(t,e);if(t instanceof Yd)return function(t,e){if(!ef(e.Vu))throw e.Ou(`${t._methodName}() can only be used with update() and set()`);if(!e.path)throw e.Ou(`${t._methodName}() is not currently supported inside arrays`);const n=t._toFieldTransform(e);n&&e.fieldTransforms.push(n)}(t,e),null;if(void 0===t&&e.ignoreUndefinedProperties)return null;if(e.path&&e.fieldMask.push(e.path),t instanceof Array){if(e.settings.Cu&&4!==e.Vu)throw e.Ou("Nested arrays are not supported");return function(t,e){const n=[];let s=0;for(const r of t){let t=pf(r,e.ku(s));null==t&&(t={nullValue:"NULL_VALUE"}),n.push(t),s++}return{arrayValue:{values:n}}}(t,e)}return function(t,e){if(null===(t=(0,a.m9)(t)))return{nullValue:"NULL_VALUE"};if("number"==typeof t)return Ni(e.O,t);if("boolean"==typeof t)return{booleanValue:t};if("string"==typeof t)return{stringValue:t};if(t instanceof Date){const n=Xs.fromDate(t);return{timestampValue:Fo(e.O,n)}}if(t instanceof Xs){const n=new Xs(t.seconds,1e3*Math.floor(t.nanoseconds/1e3));return{timestampValue:Fo(e.O,n)}}if(t instanceof Xd)return{geoPointValue:{latitude:t.latitude,longitude:t.longitude}};if(t instanceof Wd)return{bytesValue:Vo(e.O,t._byteString)};if(t instanceof vd){const n=e.databaseId,s=t.firestore._databaseId;if(!s.isEqual(n))throw e.Ou(`Document reference is for database ${s.projectId}/${s.database} but should be for database ${n.projectId}/${n.database}`);return{referenceValue:Bo(t.firestore._databaseId||e.databaseId,t._key.path)}}throw e.Ou(`Unsupported field value: ${fd(t)}`)}(t,e)}function yf(t,e){const n={};return er(t)?e.path&&e.path.length>0&&e.fieldMask.push(e.path):tr(t,((t,s)=>{const r=pf(s,e.Du(t));null!=r&&(n[t]=r)})),{mapValue:{fields:n}}}function wf(t){return!("object"!=typeof t||null===t||t instanceof Array||t instanceof Date||t instanceof Xs||t instanceof Xd||t instanceof Wd||t instanceof vd||t instanceof Yd)}function vf(t,e,n){if(!wf(n)||!function(t){return"object"==typeof t&&null!==t&&(Object.getPrototypeOf(t)===Object.prototype||null===Object.getPrototypeOf(t))}(n)){const s=fd(n);throw"an object"===s?e.Ou(t+" a custom object"):e.Ou(t+" "+s)}}function If(t,e,n){if((e=(0,a.m9)(e))instanceof Qd)return e._internalPath;if("string"==typeof e)return Tf(t,e);throw Ef("Field path arguments must be of type string or ",t,!1,void 0,n)}const bf=new RegExp("[~\\*/\\[\\]]");function Tf(t,e,n){if(e.search(bf)>=0)throw Ef(`Invalid field path (${e}). Paths must not contain '~', '*', '/', '[', or ']'`,t,!1,void 0,n);try{return new Qd(...e.split("."))._internalPath}catch(s){throw Ef(`Invalid field path (${e}). Paths must not be empty, begin with '.', end with '.', or contain '..'`,t,!1,void 0,n)}}function Ef(t,e,n,s,r){const i=s&&!s.isEmpty(),o=void 0!==r;let a=`Function ${e}() called with invalid data`;n&&(a+=" (via `toFirestore()`)"),a+=". ";let c="";return(i||o)&&(c+=" (found",i&&(c+=` in field ${s}`),o&&(c+=` in document ${r}`),c+=")"),new Ls(Rs.INVALID_ARGUMENT,a+t+c)}function Sf(t,e){return t.some((t=>t.isEqual(e)))}class xf{constructor(t,e,n,s,r){this._firestore=t,this._userDataWriter=e,this._key=n,this._document=s,this._converter=r}get id(){return this._key.path.lastSegment()}get ref(){return new vd(this._firestore,this._converter,this._key)}exists(){return null!==this._document}data(){if(this._document){if(this._converter){const t=new Af(this._firestore,this._userDataWriter,this._key,this._document,null);return this._converter.fromFirestore(t)}return this._userDataWriter.convertValue(this._document.data.value)}}get(t){if(this._document){const e=this._document.data.field(_f("DocumentSnapshot.get",t));if(null!==e)return this._userDataWriter.convertValue(e)}}}class Af extends xf{data(){return super.data()}}function _f(t,e){return"string"==typeof e?Tf(t,e):e instanceof Qd?e._internalPath:e._delegate._internalPath}class Nf{constructor(t,e){this.hasPendingWrites=t,this.fromCache=e}isEqual(t){return this.hasPendingWrites===t.hasPendingWrites&&this.fromCache===t.fromCache}}class Cf extends xf{constructor(t,e,n,s,r,i){super(t,e,n,s,i),this._firestore=t,this._firestoreImpl=t,this.metadata=r}exists(){return super.exists()}data(t={}){if(this._document){if(this._converter){const e=new Df(this._firestore,this._userDataWriter,this._key,this._document,this.metadata,null);return this._converter.fromFirestore(e,t)}return this._userDataWriter.convertValue(this._document.data.value,t.serverTimestamps)}}get(t,e={}){if(this._document){const n=this._document.data.field(_f("DocumentSnapshot.get",t));if(null!==n)return this._userDataWriter.convertValue(n,e.serverTimestamps)}}}class Df extends Cf{data(t={}){return super.data(t)}}class kf{constructor(t,e,n,s){this._firestore=t,this._userDataWriter=e,this._snapshot=s,this.metadata=new Nf(s.hasPendingWrites,s.fromCache),this.query=n}get docs(){const t=[];return this.forEach((e=>t.push(e))),t}get size(){return this._snapshot.docs.size}get empty(){return 0===this.size}forEach(t,e){this._snapshot.docs.forEach((n=>{t.call(e,new Df(this._firestore,this._userDataWriter,n.key,n,new Nf(this._snapshot.mutatedKeys.has(n.key),this._snapshot.fromCache),this.query.converter))}))}docChanges(t={}){const e=!!t.includeMetadataChanges;if(e&&this._snapshot.excludesMetadataChanges)throw new Ls(Rs.INVALID_ARGUMENT,"To include metadata changes with your document changes, you must also pass { includeMetadataChanges:true } to onSnapshot().");return this._cachedChanges&&this._cachedChangesIncludeMetadataChanges===e||(this._cachedChanges=function(t,e){if(t._snapshot.oldDocs.isEmpty()){let e=0;return t._snapshot.docChanges.map((n=>({type:"added",doc:new Df(t._firestore,t._userDataWriter,n.doc.key,n.doc,new Nf(t._snapshot.mutatedKeys.has(n.doc.key),t._snapshot.fromCache),t.query.converter),oldIndex:-1,newIndex:e++})))}{let n=t._snapshot.oldDocs;return t._snapshot.docChanges.filter((t=>e||3!==t.type)).map((e=>{const s=new Df(t._firestore,t._userDataWriter,e.doc.key,e.doc,new Nf(t._snapshot.mutatedKeys.has(e.doc.key),t._snapshot.fromCache),t.query.converter);let r=-1,i=-1;return 0!==e.type&&(r=n.indexOf(e.doc.key),n=n.delete(e.doc.key)),1!==e.type&&(n=n.add(e.doc),i=n.indexOf(e.doc.key)),{type:Of(e.type),doc:s,oldIndex:r,newIndex:i}}))}}(this,e),this._cachedChangesIncludeMetadataChanges=e),this._cachedChanges}}function Of(t){switch(t){case 0:return"added";case 2:case 3:return"modified";case 1:return"removed";default:return Cs()}}function Rf(t,e){return t instanceof Cf&&e instanceof Cf?t._firestore===e._firestore&&t._key.isEqual(e._key)&&(null===t._document?null===e._document:t._document.isEqual(e._document))&&t._converter===e._converter:t instanceof kf&&e instanceof kf&&t._firestore===e._firestore&&Ad(t.query,e.query)&&t.metadata.isEqual(e.metadata)&&t._snapshot.isEqual(e._snapshot)}function Lf(t){if(fi(t)&&0===t.explicitOrderBy.length)throw new Ls(Rs.UNIMPLEMENTED,"limitToLast() queries require specifying at least one orderBy() clause")}class Mf{}function Pf(t,...e){for(const n of e)t=n._apply(t);return t}class Ff extends Mf{constructor(t,e,n){super(),this.Uu=t,this.qu=e,this.Ku=n,this.type="where"}_apply(t){const e=rf(t.firestore),n=function(t,e,n,s,r,i,o){let a;if(r.isKeyField()){if("array-contains"===i||"array-contains-any"===i)throw new Ls(Rs.INVALID_ARGUMENT,`Invalid Query. You can't perform '${i}' queries on documentId().`);if("in"===i||"not-in"===i){Jf(o,i);const e=[];for(const n of o)e.push(Xf(s,t,n));a={arrayValue:{values:e}}}else a=Xf(s,t,o)}else"in"!==i&&"not-in"!==i&&"array-contains-any"!==i||Jf(o,i),a=gf(n,"where",o,"in"===i||"not-in"===i);const c=Wr.create(r,i,a);return function(t,e){if(e.S()){const n=gi(t);if(null!==n&&!n.isEqual(e.field))throw new Ls(Rs.INVALID_ARGUMENT,`Invalid query. All where filters with an inequality (<, <=, !=, not-in, >, or >=) must be on the same field. But you have inequality filters on '${n.toString()}' and '${e.field.toString()}'`);const s=mi(t);null!==s&&Zf(0,e.field,s)}const n=function(t,e){for(const n of t.filters)if(e.indexOf(n.op)>=0)return n.op;return null}(t,function(t){switch(t){case"!=":return["!=","not-in"];case"array-contains":return["array-contains","array-contains-any","not-in"];case"in":return["array-contains-any","in","not-in"];case"array-contains-any":return["array-contains","array-contains-any","in","not-in"];case"not-in":return["array-contains","array-contains-any","in","not-in","!="];default:return[]}}(e.op));if(null!==n)throw n===e.op?new Ls(Rs.INVALID_ARGUMENT,`Invalid query. You cannot use more than one '${e.op.toString()}' filter.`):new Ls(Rs.INVALID_ARGUMENT,`Invalid query. You cannot use '${e.op.toString()}' filters with '${n.toString()}' filters.`)}(t,c),c}(t._query,0,e,t.firestore._databaseId,this.Uu,this.qu,this.Ku);return new Id(t.firestore,t.converter,function(t,e){const n=t.filters.concat([e]);return new ui(t.path,t.collectionGroup,t.explicitOrderBy.slice(),n,t.limit,t.limitType,t.startAt,t.endAt)}(t._query,n))}}function Vf(t,e,n){const s=e,r=_f("where",t);return new Ff(r,s,n)}class Uf extends Mf{constructor(t,e){super(),this.Uu=t,this.Gu=e,this.type="orderBy"}_apply(t){const e=function(t,e,n){if(null!==t.startAt)throw new Ls(Rs.INVALID_ARGUMENT,"Invalid query. You must not call startAt() or startAfter() before calling orderBy().");if(null!==t.endAt)throw new Ls(Rs.INVALID_ARGUMENT,"Invalid query. You must not call endAt() or endBefore() before calling orderBy().");const s=new ii(e,n);return function(t,e){if(null===mi(t)){const n=gi(t);null!==n&&Zf(0,n,e.field)}}(t,s),s}(t._query,this.Uu,this.Gu);return new Id(t.firestore,t.converter,function(t,e){const n=t.explicitOrderBy.concat([e]);return new ui(t.path,t.collectionGroup,n,t.filters.slice(),t.limit,t.limitType,t.startAt,t.endAt)}(t._query,e))}}function qf(t,e="asc"){const n=e,s=_f("orderBy",t);return new Uf(s,n)}class Bf extends Mf{constructor(t,e,n){super(),this.type=t,this.ju=e,this.Qu=n}_apply(t){return new Id(t.firestore,t.converter,vi(t._query,this.ju,this.Qu))}}function Kf(t){return gd("limit",t),new Bf("limit",t,"F")}function jf(t){return gd("limitToLast",t),new Bf("limitToLast",t,"L")}class Gf extends Mf{constructor(t,e,n){super(),this.type=t,this.Wu=e,this.zu=n}_apply(t){const e=Yf(t,this.type,this.Wu,this.zu);return new Id(t.firestore,t.converter,function(t,e){return new ui(t.path,t.collectionGroup,t.explicitOrderBy.slice(),t.filters.slice(),t.limit,t.limitType,e,t.endAt)}(t._query,e))}}function $f(...t){return new Gf("startAt",t,!0)}function zf(...t){return new Gf("startAfter",t,!1)}class Qf extends Mf{constructor(t,e,n){super(),this.type=t,this.Wu=e,this.zu=n}_apply(t){const e=Yf(t,this.type,this.Wu,this.zu);return new Id(t.firestore,t.converter,function(t,e){return new ui(t.path,t.collectionGroup,t.explicitOrderBy.slice(),t.filters.slice(),t.limit,t.limitType,t.startAt,e)}(t._query,e))}}function Hf(...t){return new Qf("endBefore",t,!1)}function Wf(...t){return new Qf("endAt",t,!0)}function Yf(t,e,n,s){if(n[0]=(0,a.m9)(n[0]),n[0]instanceof xf)return function(t,e,n,s,r){if(!s)throw new Ls(Rs.NOT_FOUND,`Can't use a DocumentSnapshot that doesn't exist for ${n}().`);const i=[];for(const n of yi(t))if(n.field.isKeyField())i.push(Dr(e,s.key));else{const t=s.data.field(n.field);if(fr(t))throw new Ls(Rs.INVALID_ARGUMENT,'Invalid query. You are trying to start or end a query using a document for which the field "'+n.field+'" is an uncommitted server timestamp. (Since the value of this field is unknown, you cannot start/end a query with it.)');if(null===t){const t=n.field.canonicalString();throw new Ls(Rs.INVALID_ARGUMENT,`Invalid query. You are trying to start or end a query using a document for which the field '${t}' (used as the orderBy) does not exist.`)}i.push(t)}return new ri(i,r)}(t._query,t.firestore._databaseId,e,n[0]._document,s);{const r=rf(t.firestore);return function(t,e,n,s,r,i){const o=t.explicitOrderBy;if(r.length>o.length)throw new Ls(Rs.INVALID_ARGUMENT,`Too many arguments provided to ${s}(). The number of arguments must be less than or equal to the number of orderBy() clauses`);const a=[];for(let i=0;i<r.length;i++){const c=r[i];if(o[i].field.isKeyField()){if("string"!=typeof c)throw new Ls(Rs.INVALID_ARGUMENT,`Invalid query. Expected a string for document ID in ${s}(), but got a ${typeof c}`);if(!pi(t)&&-1!==c.indexOf("/"))throw new Ls(Rs.INVALID_ARGUMENT,`Invalid query. When querying a collection and ordering by documentId(), the value passed to ${s}() must be a plain document ID, but '${c}' contains a slash.`);const n=t.path.child(sr.fromString(c));if(!br.isDocumentKey(n))throw new Ls(Rs.INVALID_ARGUMENT,`Invalid query. When querying a collection group and ordering by documentId(), the value passed to ${s}() must result in a valid document path, but '${n}' is not because it contains an odd number of segments.`);const r=new br(n);a.push(Dr(e,r))}else{const t=gf(n,s,c);a.push(t)}}return new ri(a,i)}(t._query,t.firestore._databaseId,r,e,n,s)}}function Xf(t,e,n){if("string"==typeof(n=(0,a.m9)(n))){if(""===n)throw new Ls(Rs.INVALID_ARGUMENT,"Invalid query. When querying with documentId(), you must provide a valid document ID, but it was an empty string.");if(!pi(e)&&-1!==n.indexOf("/"))throw new Ls(Rs.INVALID_ARGUMENT,`Invalid query. When querying a collection by documentId(), you must provide a plain document ID, but '${n}' contains a '/' character.`);const s=e.path.child(sr.fromString(n));if(!br.isDocumentKey(s))throw new Ls(Rs.INVALID_ARGUMENT,`Invalid query. When querying a collection group by documentId(), the value provided must result in a valid document path, but '${s}' is not because it has an odd number of segments (${s.length}).`);return Dr(t,new br(s))}if(n instanceof vd)return Dr(t,n._key);throw new Ls(Rs.INVALID_ARGUMENT,`Invalid query. When querying with documentId(), you must provide a valid string or a DocumentReference, but it was: ${fd(n)}.`)}function Jf(t,e){if(!Array.isArray(t)||0===t.length)throw new Ls(Rs.INVALID_ARGUMENT,`Invalid Query. A non-empty array is required for '${e.toString()}' filters.`);if(t.length>10)throw new Ls(Rs.INVALID_ARGUMENT,`Invalid Query. '${e.toString()}' filters support a maximum of 10 elements in the value array.`)}function Zf(t,e,n){if(!n.isEqual(e))throw new Ls(Rs.INVALID_ARGUMENT,`Invalid query. You have a where filter with an inequality (<, <=, !=, not-in, >, or >=) on field '${e.toString()}' and so you must also use '${e.toString()}' as your first argument to orderBy(), but your first orderBy() is on field '${n.toString()}' instead.`)}class tm{convertValue(t,e="none"){switch(Er(t)){case 0:return null;case 1:return t.booleanValue;case 2:return lr(t.integerValue||t.doubleValue);case 3:return this.convertTimestamp(t.timestampValue);case 4:return this.convertServerTimestamp(t,e);case 5:return t.stringValue;case 6:return this.convertBytes(dr(t.bytesValue));case 7:return this.convertReference(t.referenceValue);case 8:return this.convertGeoPoint(t.geoPointValue);case 9:return this.convertArray(t.arrayValue,e);case 10:return this.convertObject(t.mapValue,e);default:throw Cs()}}convertObject(t,e){const n={};return tr(t.fields,((t,s)=>{n[t]=this.convertValue(s,e)})),n}convertGeoPoint(t){return new Xd(lr(t.latitude),lr(t.longitude))}convertArray(t,e){return(t.values||[]).map((t=>this.convertValue(t,e)))}convertServerTimestamp(t,e){switch(e){case"previous":const n=mr(t);return null==n?null:this.convertValue(n,e);case"estimate":return this.convertTimestamp(gr(t));default:return null}}convertTimestamp(t){const e=hr(t);return new Xs(e.seconds,e.nanos)}convertDocumentKey(t,e){const n=sr.fromString(t);Ds(ha(n));const s=new yr(n.get(1),n.get(3)),r=new br(n.popFirst(5));return s.isEqual(e)||As(`Document ${r} contains a document reference within a different database (${s.projectId}/${s.database}) which is not supported. It will be treated as a reference in the current database (${e.projectId}/${e.database}) instead.`),r}}function em(t,e,n){let s;return s=t?n&&(n.merge||n.mergeFields)?t.toFirestore(e,n):t.toFirestore(e):e,s}class nm extends tm{constructor(t){super(),this.firestore=t}convertBytes(t){return new Wd(t)}convertReference(t){const e=this.convertDocumentKey(t,this.firestore._databaseId);return new vd(this.firestore,null,e)}}class sm{constructor(t,e){this._firestore=t,this._commitHandler=e,this._mutations=[],this._committed=!1,this._dataReader=rf(t)}set(t,e,n){this._verifyNotCommitted();const s=rm(t,this._firestore),r=em(s.converter,e,n),i=of(this._dataReader,"WriteBatch.set",s._key,r,null!==s.converter,n);return this._mutations.push(i.toMutation(s._key,ji.none())),this}update(t,e,n,...s){this._verifyNotCommitted();const r=rm(t,this._firestore);let i;return i="string"==typeof(e=(0,a.m9)(e))||e instanceof Qd?mf(this._dataReader,"WriteBatch.update",r._key,e,n,s):ff(this._dataReader,"WriteBatch.update",r._key,e),this._mutations.push(i.toMutation(r._key,ji.exists(!0))),this}delete(t){this._verifyNotCommitted();const e=rm(t,this._firestore);return this._mutations=this._mutations.concat(new no(e._key,ji.none())),this}commit(){return this._verifyNotCommitted(),this._committed=!0,this._mutations.length>0?this._commitHandler(this._mutations):Promise.resolve()}_verifyNotCommitted(){if(this._committed)throw new Ls(Rs.FAILED_PRECONDITION,"A write batch can no longer be used after commit() has been called.")}}function rm(t,e){if((t=(0,a.m9)(t)).firestore!==e)throw new Ls(Rs.INVALID_ARGUMENT,"Provided document reference is from a different Firestore instance.");return t}function im(t){t=md(t,vd);const e=md(t.firestore,kd);return od(Ld(e),t._key).then((n=>vm(e,t,n)))}class om extends tm{constructor(t){super(),this.firestore=t}convertBytes(t){return new Wd(t)}convertReference(t){const e=this.convertDocumentKey(t,this.firestore._databaseId);return new vd(this.firestore,null,e)}}function am(t){t=md(t,vd);const e=md(t.firestore,kd),n=Ld(e),s=new om(e);return function(t,e){const n=new Ms;return t.asyncQueue.enqueueAndForget((async()=>async function(t,e,n){try{const s=await function(t,e){const n=Os(t);return n.persistence.runTransaction("read document","readonly",(t=>n.Us.ys(t,e)))}(t,e);s.isFoundDocument()?n.resolve(s):s.isNoDocument()?n.resolve(null):n.reject(new Ls(Rs.UNAVAILABLE,"Failed to get document from cache. (However, this document may exist on the server. Run again without setting 'source' in the GetOptions to attempt to retrieve the document from the server.)"))}catch(t){const s=$h(t,`Failed to get document '${e} from cache`);n.reject(s)}}(await nd(t),e,n))),n.promise}(n,t._key).then((n=>new Cf(e,s,t._key,n,new Nf(null!==n&&n.hasLocalMutations,!0),t.converter)))}function cm(t){t=md(t,vd);const e=md(t.firestore,kd);return od(Ld(e),t._key,{source:"server"}).then((n=>vm(e,t,n)))}function um(t){t=md(t,Id);const e=md(t.firestore,kd),n=Ld(e),s=new om(e);return Lf(t._query),ad(n,t._query).then((n=>new kf(e,s,t,n)))}function hm(t){t=md(t,Id);const e=md(t.firestore,kd),n=Ld(e),s=new om(e);return function(t,e){const n=new Ms;return t.asyncQueue.enqueueAndForget((async()=>async function(t,e,n){try{const s=await Du(t,e,!0),r=new ul(e,s.Ks),i=r.Ic(s.documents),o=r.applyChanges(i,!1);n.resolve(o.snapshot)}catch(t){const s=$h(t,`Failed to execute query '${e} against cache`);n.reject(s)}}(await nd(t),e,n))),n.promise}(n,t._query).then((n=>new kf(e,s,t,n)))}function lm(t){t=md(t,Id);const e=md(t.firestore,kd),n=Ld(e),s=new om(e);return ad(n,t._query,{source:"server"}).then((n=>new kf(e,s,t,n)))}function dm(t,e,n){t=md(t,vd);const s=md(t.firestore,kd),r=em(t.converter,e,n);return wm(s,[of(rf(s),"setDoc",t._key,r,null!==t.converter,n).toMutation(t._key,ji.none())])}function fm(t,e,n,...s){t=md(t,vd);const r=md(t.firestore,kd),i=rf(r);let o;return o="string"==typeof(e=(0,a.m9)(e))||e instanceof Qd?mf(i,"updateDoc",t._key,e,n,s):ff(i,"updateDoc",t._key,e),wm(r,[o.toMutation(t._key,ji.exists(!0))])}function mm(t){return wm(md(t.firestore,kd),[new no(t._key,ji.none())])}function gm(t,e){const n=md(t.firestore,kd),s=Sd(t),r=em(t.converter,e);return wm(n,[of(rf(t.firestore),"addDoc",s._key,r,null!==t.converter,{}).toMutation(s._key,ji.exists(!1))]).then((()=>s))}function pm(t,...e){var n,s,r;t=(0,a.m9)(t);let i={includeMetadataChanges:!1},o=0;"object"!=typeof e[o]||Nd(e[o])||(i=e[o],o++);const c={includeMetadataChanges:i.includeMetadataChanges};if(Nd(e[o])){const t=e[o];e[o]=null===(n=t.next)||void 0===n?void 0:n.bind(t),e[o+1]=null===(s=t.error)||void 0===s?void 0:s.bind(t),e[o+2]=null===(r=t.complete)||void 0===r?void 0:r.bind(t)}let u,h,l;if(t instanceof vd)h=md(t.firestore,kd),l=li(t._key.path),u={next:n=>{e[o]&&e[o](vm(h,t,n))},error:e[o+1],complete:e[o+2]};else{const n=md(t,Id);h=md(n.firestore,kd),l=n._query;const s=new om(h);u={next:t=>{e[o]&&e[o](new kf(h,s,n,t))},error:e[o+1],complete:e[o+2]},Lf(t._query)}return function(t,e,n,s){const r=new zl(s),i=new nl(e,r,n);return t.asyncQueue.enqueueAndForget((async()=>Xh(await id(t),i))),()=>{r.Jc(),t.asyncQueue.enqueueAndForget((async()=>Jh(await id(t),i)))}}(Ld(h),l,c,u)}function ym(t,e){return function(t,e){const n=new zl(e);return t.asyncQueue.enqueueAndForget((async()=>function(t,e){Os(t).Zo.add(e),e.next()}(await id(t),n))),()=>{n.Jc(),t.asyncQueue.enqueueAndForget((async()=>function(t,e){Os(t).Zo.delete(e)}(await id(t),n)))}}(Ld(t=md(t,kd)),Nd(e)?e:{next:e})}function wm(t,e){return function(t,e){const n=new Ms;return t.asyncQueue.enqueueAndForget((async()=>async function(t,e,n){const s=ql(t);try{const t=await function(t,e){const n=Os(t),s=Xs.now(),r=e.reduce(((t,e)=>t.add(e.key)),To());let i;return n.persistence.runTransaction("Locally write mutations","readwrite",(t=>n.Us.Es(t,r).next((r=>{i=r;const o=[];for(const t of e){const e=Hi(t,i.get(t.key));null!=e&&o.push(new Ji(t.key,e,Vr(e.value.mapValue),ji.exists(!0)))}return n.gs.addMutationBatch(t,s,o,e)})))).then((t=>(t.applyToLocalDocumentSet(i),{batchId:t.batchId,changes:i})))}(s.localStore,e);s.sharedClientState.addPendingMutation(t.batchId),function(t,e,n){let s=t.$c[t.currentUser.toKey()];s||(s=new uo(Hs)),s=s.insert(e,n),t.$c[t.currentUser.toKey()]=s}(s,t.batchId,n),await Nl(s,t.changes),await kh(s.remoteStore)}catch(t){const e=$h(t,"Failed to persist write");n.reject(e)}}(await rd(t),e,n))),n.promise}(Ld(t),e)}function vm(t,e,n){const s=n.docs.get(e._key),r=new om(t);return new Cf(t,r,e._key,s,new Nf(n.hasPendingWrites,n.fromCache),e.converter)}class Im extends class{constructor(t,e){this._firestore=t,this._transaction=e,this._dataReader=rf(t)}get(t){const e=rm(t,this._firestore),n=new nm(this._firestore);return this._transaction.lookup([e._key]).then((t=>{if(!t||1!==t.length)return Cs();const s=t[0];if(s.isFoundDocument())return new xf(this._firestore,n,s.key,s,e.converter);if(s.isNoDocument())return new xf(this._firestore,n,e._key,null,e.converter);throw Cs()}))}set(t,e,n){const s=rm(t,this._firestore),r=em(s.converter,e,n),i=of(this._dataReader,"Transaction.set",s._key,r,null!==s.converter,n);return this._transaction.set(s._key,i),this}update(t,e,n,...s){const r=rm(t,this._firestore);let i;return i="string"==typeof(e=(0,a.m9)(e))||e instanceof Qd?mf(this._dataReader,"Transaction.update",r._key,e,n,s):ff(this._dataReader,"Transaction.update",r._key,e),this._transaction.update(r._key,i),this}delete(t){const e=rm(t,this._firestore);return this._transaction.delete(e._key),this}}{constructor(t,e){super(t,e),this._firestore=t}get(t){const e=rm(t,this._firestore),n=new om(this._firestore);return super.get(t).then((t=>new Cf(this._firestore,n,e._key,t._document,new Nf(!1,!1),e.converter)))}}function bm(t,e){return function(t,e){const n=new Ms;return t.asyncQueue.enqueueAndForget((async()=>{const s=await function(t){return td(t).then((t=>t.datastore))}(t);new Wl(t.asyncQueue,s,e,n).run()})),n.promise}(Ld(t=md(t,kd)),(n=>e(new Im(t,n))))}function Tm(){return new af("deleteField")}function Em(){return new uf("serverTimestamp")}function Sm(...t){return new hf("arrayUnion",t)}function xm(...t){return new lf("arrayRemove",t)}function Am(t){return new df("increment",t)}function _m(t){return Ld(t=md(t,kd)),new sm(t,(e=>wm(t,e)))}function Nm(t,e){Ld(t=md(t,kd));const n="string"==typeof e?function(t){try{return JSON.parse(t)}catch(t){throw new Ls(Rs.INVALID_ARGUMENT,"Failed to parse JSON:"+t.message)}}(e):e,s=[];if(Array.isArray(n.indexes))for(const t of n.indexes){const e=Cm(t,"collectionGroup"),n=[];if(Array.isArray(t.fields))for(const e of t.fields){const t=Tf("setIndexConfiguration",Cm(e,"fieldPath"));"CONTAINS"===e.arrayConfig?n.push(new Br(t,2)):"ASCENDING"===e.order?n.push(new Br(t,0)):"DESCENDING"===e.order&&n.push(new Br(t,1))}s.push(new qr(qr.UNKNOWN_ID,e,n,Kr.empty()))}return Promise.resolve()}function Cm(t,e){if("string"!=typeof t[e])throw new Ls(Rs.INVALID_ARGUMENT,"Missing string value for: "+e);return t[e]}!function(t,e=!0){!function(t){bs=t}(r.SDK_VERSION),(0,r._registerComponent)(new i.wA("firestore",((t,{options:n})=>{const s=t.getProvider("app").getImmediate(),r=new kd(s,new Us(t.getProvider("auth-internal")),new js(t.getProvider("app-check-internal")));return n=Object.assign({useFetchStreams:e},n),r._setSettings(n),r}),"PUBLIC")),(0,r.registerVersion)(vs,"3.4.5",t),(0,r.registerVersion)(vs,"3.4.5","esm2017")}()}}]);